<script>
/**
 * AgriTrade Africa - Multilingual + Working Navigation Patch (Investor Demo)
 * Languages: en, es, fr, ar (RTL)
 * - Creates real sections & navigation behavior (no more â€œclick but nothing happensâ€)
 * - Adds language selector in navbar
 * - Localizes UI text, numbers, currency, dates
 * - Localizes AI replies
 */

(function () {
  // ---------- STATE ----------
  const state = {
    lang: localStorage.getItem("agri_lang") || "en",
    currency: localStorage.getItem("agri_currency") || "USD",
    section: localStorage.getItem("agri_section") || "dashboard",
    // base amounts in USD for demo numbers (kept from your UI)
    base: {
      revenueUSD: 24500,
      walletUSD: 8320,
      walletBalanceUSD: 8320.50,
      walletDeltaUSD: 1200
    }
  };

  // FX demo rates relative to USD (your original list)
  const rates = { USD: 1, KES: 130.5, ETB: 54.2, RWF: 1220 };

  // Locale mapping for Intl
  const LOCALES = {
    en: "en-US",
    es: "es-ES",
    fr: "fr-FR",
    ar: "ar"
  };

  // RTL languages
  const RTL = new Set(["ar"]);

  // ---------- I18N DICTIONARY ----------
  // Keep it focused on things you actually show in UI; you can expand anytime.
  const I18N = {
    en: {
      appName: "AgriTrade Africa",
      loadingExperience: "Loading Ultimate Experience...",
      initializing: "Initializing...",
      navDashboard: "Dashboard",
      navMarket: "Market",
      navWallet: "Wallet",
      navAITools: "AI Tools",
      sidebarDashboard: "Dashboard",
      myListings: "My Listings",
      orders: "Orders",
      logistics: "Logistics",
      aiAutomation: "AI & Automation",
      diseaseScanner: "Disease Scanner",
      priceAI: "Price AI",
      soilAnalysis: "Soil Analysis",
      blockchain: "Blockchain",
      traceability: "Traceability",
      smartContracts: "Smart Contracts",
      aiCommandCenter: "AI Command Center",
      aiPredictionAccuracy: "Predictions accurate 94% of the time",
      live: "Live",
      scanCrop: "Scan Crop",
      predictPrices: "Predict Prices",
      soilTest: "Soil Test",
      weatherAI: "Weather AI",
      totalRevenue: "Total Revenue",
      walletBalanceLabel: "Wallet Balance",
      activeContracts: "Active Contracts",
      trustScore: "Trust Score",
      verified: "Verified",
      pending: "pending",
      mobileMoney: "Mobile Money",
      send: "Send",
      receive: "Receive",
      create: "Create",
      view: "View",
      chat: "Chat",
      pool: "Pool",
      quote: "Quote",
      claim: "Claim",
      aiDiseaseDetection: "AI Disease Detection",
      history: "History",
      tapToUpload: "Tap to upload crop photo",
      chooseFile: "Choose File",
      healthyDetected: "Healthy Crop Detected",
      confidence: "Confidence",
      healthyAdvice: "Your maize crop shows no signs of disease. Continue current care schedule.",
      liveLogistics: "Live Logistics",
      all: "All",
      inTransit: "In Transit",
      digitalWallet: "Digital Wallet",
      availableBalance: "Available Balance",
      deposit: "Deposit",
      scan: "Scan",
      quickPay: "Quick Pay",
      phoneNumber: "Phone Number",
      amount: "Amount",
      sendMoney: "Send Money",
      messages: "Messages",
      buyers: "Buyers",
      sellers: "Sellers",
      ai: "AI",
      typeMessage: "Type message...",
      achievements: "Achievements",
      level: "Level",
      trader: "Trader",
      quality: "Quality",
      pioneer: "Pioneer",
      export: "Export",
      green: "Green",
      digital: "Digital",
      mentor: "Mentor",
      leader: "Leader",
      listening: "Listening...",
      voiceHint: 'Try: "Show my wallet" or "Scan for diseases"',
      aiTip: "ðŸ’¡ Tip: Offer bulk discount for 1000kg+ to increase deal size",
      aiReply: "Thanks for your message! Iâ€™ll help you find the best buyers for your crops.",
      currencyChanged: "Currency changed to {currency}",
      languageChanged: "Language changed to {lang}",
      sectionLoaded: "Loaded {section}"
    },
    es: {
      appName: "AgriTrade Ãfrica",
      loadingExperience: "Cargando experiencia definitiva...",
      initializing: "Iniciando...",
      navDashboard: "Panel",
      navMarket: "Mercado",
      navWallet: "Billetera",
      navAITools: "Herramientas IA",
      sidebarDashboard: "Panel",
      myListings: "Mis anuncios",
      orders: "Pedidos",
      logistics: "LogÃ­stica",
      aiAutomation: "IA y automatizaciÃ³n",
      diseaseScanner: "EscÃ¡ner de enfermedades",
      priceAI: "IA de precios",
      soilAnalysis: "AnÃ¡lisis de suelo",
      blockchain: "Blockchain",
      traceability: "Trazabilidad",
      smartContracts: "Contratos inteligentes",
      aiCommandCenter: "Centro de mando IA",
      aiPredictionAccuracy: "Predicciones precisas el 94% del tiempo",
      live: "En vivo",
      scanCrop: "Escanear cultivo",
      predictPrices: "Predecir precios",
      soilTest: "Prueba de suelo",
      weatherAI: "IA del clima",
      totalRevenue: "Ingresos totales",
      walletBalanceLabel: "Saldo de billetera",
      activeContracts: "Contratos activos",
      trustScore: "PuntuaciÃ³n de confianza",
      verified: "Verificado",
      pending: "pendientes",
      mobileMoney: "Dinero mÃ³vil",
      send: "Enviar",
      receive: "Recibir",
      create: "Crear",
      view: "Ver",
      chat: "Chat",
      pool: "Agrupar",
      quote: "Cotizar",
      claim: "Reclamar",
      aiDiseaseDetection: "DetecciÃ³n de enfermedades con IA",
      history: "Historial",
      tapToUpload: "Toque para subir foto del cultivo",
      chooseFile: "Elegir archivo",
      healthyDetected: "Cultivo saludable detectado",
      confidence: "Confianza",
      healthyAdvice: "Tu maÃ­z no muestra signos de enfermedad. ContinÃºa con el cuidado habitual.",
      liveLogistics: "LogÃ­stica en vivo",
      all: "Todos",
      inTransit: "En trÃ¡nsito",
      digitalWallet: "Billetera digital",
      availableBalance: "Saldo disponible",
      deposit: "Depositar",
      scan: "Escanear",
      quickPay: "Pago rÃ¡pido",
      phoneNumber: "NÃºmero de telÃ©fono",
      amount: "Monto",
      sendMoney: "Enviar dinero",
      messages: "Mensajes",
      buyers: "Compradores",
      sellers: "Vendedores",
      ai: "IA",
      typeMessage: "Escribe un mensaje...",
      achievements: "Logros",
      level: "Nivel",
      trader: "Comerciante",
      quality: "Calidad",
      pioneer: "Pionero",
      export: "ExportaciÃ³n",
      green: "Sostenible",
      digital: "Digital",
      mentor: "Mentor",
      leader: "LÃ­der",
      listening: "Escuchando...",
      voiceHint: 'Prueba: "Mostrar mi billetera" o "Escanear enfermedades"',
      aiTip: "ðŸ’¡ Consejo: Ofrece descuento por volumen (1000kg+) para aumentar el valor del trato",
      aiReply: "Â¡Gracias por tu mensaje! Te ayudarÃ© a encontrar los mejores compradores para tus cultivos.",
      currencyChanged: "Moneda cambiada a {currency}",
      languageChanged: "Idioma cambiado a {lang}",
      sectionLoaded: "{section} cargado"
    },
    fr: {
      appName: "AgriTrade Afrique",
      loadingExperience: "Chargement de lâ€™expÃ©rience ultime...",
      initializing: "Initialisation...",
      navDashboard: "Tableau de bord",
      navMarket: "MarchÃ©",
      navWallet: "Portefeuille",
      navAITools: "Outils IA",
      sidebarDashboard: "Tableau de bord",
      myListings: "Mes annonces",
      orders: "Commandes",
      logistics: "Logistique",
      aiAutomation: "IA & automatisation",
      diseaseScanner: "Scanner de maladies",
      priceAI: "IA des prix",
      soilAnalysis: "Analyse du sol",
      blockchain: "Blockchain",
      traceability: "TraÃ§abilitÃ©",
      smartContracts: "Contrats intelligents",
      aiCommandCenter: "Centre de commande IA",
      aiPredictionAccuracy: "PrÃ©dictions exactes 94% du temps",
      live: "En direct",
      scanCrop: "Scanner la culture",
      predictPrices: "PrÃ©dire les prix",
      soilTest: "Test du sol",
      weatherAI: "IA mÃ©tÃ©o",
      totalRevenue: "Revenu total",
      walletBalanceLabel: "Solde du portefeuille",
      activeContracts: "Contrats actifs",
      trustScore: "Indice de confiance",
      verified: "VÃ©rifiÃ©",
      pending: "en attente",
      mobileMoney: "Mobile Money",
      send: "Envoyer",
      receive: "Recevoir",
      create: "CrÃ©er",
      view: "Voir",
      chat: "Chat",
      pool: "Grouper",
      quote: "Devis",
      claim: "RÃ©clamation",
      aiDiseaseDetection: "DÃ©tection des maladies par IA",
      history: "Historique",
      tapToUpload: "Touchez pour tÃ©lÃ©verser une photo",
      chooseFile: "Choisir un fichier",
      healthyDetected: "Culture saine dÃ©tectÃ©e",
      confidence: "Confiance",
      healthyAdvice: "Votre maÃ¯s ne montre aucun signe de maladie. Continuez lâ€™entretien habituel.",
      liveLogistics: "Logistique en direct",
      all: "Tous",
      inTransit: "En transit",
      digitalWallet: "Portefeuille numÃ©rique",
      availableBalance: "Solde disponible",
      deposit: "DÃ©pÃ´t",
      scan: "Scanner",
      quickPay: "Paiement rapide",
      phoneNumber: "NumÃ©ro de tÃ©lÃ©phone",
      amount: "Montant",
      sendMoney: "Envoyer de lâ€™argent",
      messages: "Messages",
      buyers: "Acheteurs",
      sellers: "Vendeurs",
      ai: "IA",
      typeMessage: "Tapez un message...",
      achievements: "SuccÃ¨s",
      level: "Niveau",
      trader: "Trader",
      quality: "QualitÃ©",
      pioneer: "Pionnier",
      export: "Export",
      green: "Ã‰co",
      digital: "NumÃ©rique",
      mentor: "Mentor",
      leader: "Leader",
      listening: "Ã‰coute...",
      voiceHint: 'Essayez : "Ouvre mon portefeuille" ou "Scanner les maladies"',
      aiTip: "ðŸ’¡ Astuce : proposez une remise pour 1000kg+ afin dâ€™augmenter la taille des ventes",
      aiReply: "Merci pour votre message ! Je vais vous aider Ã  trouver les meilleurs acheteurs.",
      currencyChanged: "Devise changÃ©e en {currency}",
      languageChanged: "Langue changÃ©e : {lang}",
      sectionLoaded: "{section} chargÃ©"
    },
    ar: {
      appName: "Ø£Ø¬Ø±ÙŠØªØ±ÙŠØ¯ Ø£ÙØ±ÙŠÙ‚ÙŠØ§",
      loadingExperience: "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©...",
      initializing: "Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...",
      navDashboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
      navMarket: "Ø§Ù„Ø³ÙˆÙ‚",
      navWallet: "Ø§Ù„Ù…Ø­ÙØ¸Ø©",
      navAITools: "Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡",
      sidebarDashboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
      myListings: "Ø¹Ø±ÙˆØ¶ÙŠ",
      orders: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
      logistics: "Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª",
      aiAutomation: "Ø§Ù„Ø°ÙƒØ§Ø¡ ÙˆØ§Ù„Ø£ØªÙ…ØªØ©",
      diseaseScanner: "Ù…Ø§Ø³Ø­ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶",
      priceAI: "Ø°ÙƒØ§Ø¡ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±",
      soilAnalysis: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø©",
      blockchain: "Ø¨Ù„ÙˆÙƒ ØªØ´ÙŠÙ†",
      traceability: "Ø§Ù„ØªØªØ¨Ø¹",
      smartContracts: "Ø¹Ù‚ÙˆØ¯ Ø°ÙƒÙŠØ©",
      aiCommandCenter: "Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø°ÙƒØ§Ø¡",
      aiPredictionAccuracy: "ØªÙˆÙ‚Ø¹Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ù†Ø³Ø¨Ø© 94%",
      live: "Ù…Ø¨Ø§Ø´Ø±",
      scanCrop: "ÙØ­Øµ Ø§Ù„Ù…Ø­ØµÙˆÙ„",
      predictPrices: "ØªÙˆÙ‚Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±",
      soilTest: "Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ±Ø¨Ø©",
      weatherAI: "Ø°ÙƒØ§Ø¡ Ø§Ù„Ø·Ù‚Ø³",
      totalRevenue: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
      walletBalanceLabel: "Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©",
      activeContracts: "Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·Ø©",
      trustScore: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ù‚Ø©",
      verified: "Ù…ÙˆØ«Ù‘Ù‚",
      pending: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
      mobileMoney: "Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø§Ù„Ù‡Ø§ØªÙ",
      send: "Ø¥Ø±Ø³Ø§Ù„",
      receive: "Ø§Ø³ØªÙ„Ø§Ù…",
      create: "Ø¥Ù†Ø´Ø§Ø¡",
      view: "Ø¹Ø±Ø¶",
      chat: "Ø¯Ø±Ø¯Ø´Ø©",
      pool: "ØªØ¬Ù…ÙŠØ¹",
      quote: "Ø³Ø¹Ø±",
      claim: "Ù…Ø·Ø§Ù„Ø¨Ø©",
      aiDiseaseDetection: "ÙƒØ´Ù Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡",
      history: "Ø§Ù„Ø³Ø¬Ù„",
      tapToUpload: "Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ù…Ø­ØµÙˆÙ„",
      chooseFile: "Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§",
      healthyDetected: "ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø­ØµÙˆÙ„ Ø³Ù„ÙŠÙ…",
      confidence: "Ø§Ù„Ø«Ù‚Ø©",
      healthyAdvice: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø°Ø±Ø©. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù…Ø¹ØªØ§Ø¯.",
      liveLogistics: "Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©",
      all: "Ø§Ù„ÙƒÙ„",
      inTransit: "Ù‚ÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„",
      digitalWallet: "Ù…Ø­ÙØ¸Ø© Ø±Ù‚Ù…ÙŠØ©",
      availableBalance: "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­",
      deposit: "Ø¥ÙŠØ¯Ø§Ø¹",
      scan: "Ù…Ø³Ø­",
      quickPay: "Ø¯ÙØ¹ Ø³Ø±ÙŠØ¹",
      phoneNumber: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
      amount: "Ø§Ù„Ù…Ø¨Ù„Øº",
      sendMoney: "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø§Ù„",
      messages: "Ø§Ù„Ø±Ø³Ø§Ø¦Ù„",
      buyers: "Ø§Ù„Ù…Ø´ØªØ±ÙˆÙ†",
      sellers: "Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙˆÙ†",
      ai: "Ø§Ù„Ø°ÙƒØ§Ø¡",
      typeMessage: "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...",
      achievements: "Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª",
      level: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
      trader: "ØªØ§Ø¬Ø±",
      quality: "Ø¬ÙˆØ¯Ø©",
      pioneer: "Ø±Ø§Ø¦Ø¯",
      export: "ØªØµØ¯ÙŠØ±",
      green: "Ù…Ø³ØªØ¯Ø§Ù…",
      digital: "Ø±Ù‚Ù…ÙŠ",
      mentor: "Ù…Ø±Ø´Ø¯",
      leader: "Ù‚Ø§Ø¦Ø¯",
      listening: "Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...",
      voiceHint: 'Ø¬Ø±Ù‘Ø¨: "Ø§ÙØªØ­ Ù…Ø­ÙØ¸ØªÙŠ" Ø£Ùˆ "Ø§ÙØ­Øµ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶"',
      aiTip: "ðŸ’¡ Ù†ØµÙŠØ­Ø©: Ù‚Ø¯Ù‘Ù… Ø®ØµÙ…Ù‹Ø§ Ù„Ù„ÙƒÙ…ÙŠØ§Øª 1000 ÙƒØº+ Ù„Ø²ÙŠØ§Ø¯Ø© Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙÙ‚Ø©",
      aiReply: "Ø´ÙƒØ±Ù‹Ø§ Ù„Ø±Ø³Ø§Ù„ØªÙƒ! Ø³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ† Ù„Ù…Ø­Ø§ØµÙŠÙ„Ùƒ.",
      currencyChanged: "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ {currency}",
      languageChanged: "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ {lang}",
      sectionLoaded: "ØªÙ… ØªØ­Ù…ÙŠÙ„ {section}"
    }
  };

  // ---------- UTIL ----------
  function t(key, vars) {
    const dict = I18N[state.lang] || I18N.en;
    let s = dict[key] || I18N.en[key] || key;
    if (vars) {
      Object.keys(vars).forEach(k => (s = s.replaceAll(`{${k}}`, String(vars[k]))));
    }
    return s;
  }

  function locale() {
    return LOCALES[state.lang] || "en-US";
  }

  function setDir() {
    const isRtl = RTL.has(state.lang);
    document.documentElement.setAttribute("dir", isRtl ? "rtl" : "ltr");
    document.documentElement.setAttribute("lang", state.lang);
  }

  function formatMoney(valueInUSD) {
    const rate = rates[state.currency] || 1;
    const converted = valueInUSD * rate;

    // Intl currency formatting (localized digits & separators)
    try {
      return new Intl.NumberFormat(locale(), {
        style: "currency",
        currency: state.currency,
        maximumFractionDigits: 2
      }).format(converted);
    } catch {
      // fallback
      return `${converted.toLocaleString(locale())} ${state.currency}`;
    }
  }

  function formatPercent(n) {
    return new Intl.NumberFormat(locale(), { style: "percent", maximumFractionDigits: 0 }).format(n);
  }

  function formatDate(d = new Date()) {
    return new Intl.DateTimeFormat(locale(), { dateStyle: "medium" }).format(d);
  }

  // ---------- TOAST (kept, but not spammy) ----------
  function showToast(message, type = "info") {
    const container = document.getElementById("toastContainer");
    if (!container) return;

    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    const icon = type === "success" ? "check-circle" : type === "error" ? "exclamation-circle" : "info-circle";
    toast.innerHTML = `<i class="fas fa-${icon}"></i><span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  }

  // ---------- CREATE REAL SECTIONS (no HTML edits needed) ----------
  function buildSections() {
    const main = document.getElementById("mainContent");
    if (!main) return;

    // If we already built sections once, donâ€™t do it again.
    if (main.querySelector("[data-section='dashboard']")) return;

    // Move existing dashboard content into a dashboard section container
    const dash = document.createElement("div");
    dash.dataset.section = "dashboard";
    dash.id = "section-dashboard";

    while (main.firstChild) dash.appendChild(main.firstChild);
    main.appendChild(dash);

    // Create placeholder sections for other nav targets
    const sections = ["market", "wallet", "ai", "listings", "orders", "logistics", "traceability", "contracts"];
    sections.forEach(s => {
      const el = document.createElement("div");
      el.dataset.section = s;
      el.id = `section-${s}`;
      el.style.display = "none";
      el.className = "card";
      el.innerHTML = `
        <div class="card-header">
          <div class="card-title"><i class="fas fa-layer-group"></i> <span data-i18n="nav_${s}">${s}</span></div>
          <div style="font-size:.85rem; color: var(--text-light)">${formatDate()}</div>
        </div>
        <div style="color: var(--text-light); line-height:1.7">
          <div><strong>${t("appName")}</strong> â€” ${t("sectionLoaded", { section: s })}</div>
          <div style="margin-top:.75rem;">
            This is a demo section placeholder for investors. Wire this to backend/API later.
          </div>
        </div>
      `;
      main.appendChild(el);
    });
  }

  function showSection(sectionName) {
    const main = document.getElementById("mainContent");
    if (!main) return;

    const all = main.querySelectorAll("[data-section]");
    all.forEach(s => (s.style.display = "none"));

    const target = main.querySelector(`[data-section="${sectionName}"]`);
    if (target) target.style.display = "";

    state.section = sectionName;
    localStorage.setItem("agri_section", sectionName);

    // Highlight sidebar/top links
    document.querySelectorAll(".menu-link, .nav-btn").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(`[data-nav="${sectionName}"]`).forEach(x => x.classList.add("active"));
  }

  // ---------- BIND BUTTONS SAFELY (no more relying on "event") ----------
  function bindNavClicks() {
    // Convert inline onclick="showSection('x')" into reliable listeners
    const clickable = Array.from(document.querySelectorAll("[onclick]"));
    clickable.forEach(el => {
      const oc = el.getAttribute("onclick") || "";

      // showSection('name')
      let m = oc.match(/showSection\('([^']+)'\)/);
      if (m) {
        const section = m[1];
        el.removeAttribute("onclick");
        el.dataset.nav = section;
        el.addEventListener("click", (e) => {
          e.preventDefault();
          showSection(section);
        });
      }

      // switchChat('tab') - fix event dependency
      m = oc.match(/switchChat\('([^']+)'\)/);
      if (m) {
        const tab = m[1];
        el.removeAttribute("onclick");
        el.addEventListener("click", (e) => {
          e.preventDefault();
          switchChat(tab, el);
        });
      }
    });
  }

  // ---------- LANGUAGE SELECTOR (injected automatically) ----------
  function injectLanguageSelector() {
    const navRight = document.querySelector(".nav-right");
    if (!navRight) return;
    if (document.getElementById("langSelect")) return;

    const sel = document.createElement("select");
    sel.id = "langSelect";
    sel.title = "Language";
    sel.innerHTML = `
      <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
      <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
      <option value="fr">ðŸ‡«ðŸ‡· FR</option>
      <option value="ar">ðŸ‡¸ðŸ‡¦ AR</option>
    `;
    sel.value = state.lang;
    sel.addEventListener("change", () => setLanguage(sel.value, true));

    // Put language selector before the mic/bell buttons
    navRight.insertBefore(sel, navRight.firstChild);
  }

  // ---------- APPLY TRANSLATIONS ----------
  // Since your HTML isnâ€™t tagged with data-i18n everywhere, we â€œauto-keyâ€ common labels once.
  function applyI18nKeysOnce() {
    // Top nav buttons
    const navBtns = document.querySelectorAll(".nav-center .nav-btn");
    if (navBtns.length >= 4) {
      setI18n(navBtns[0], "navDashboard");
      setI18n(navBtns[1], "navMarket");
      setI18n(navBtns[2], "navWallet");
      setI18n(navBtns[3], "navAITools");
    }

    // Sidebar labels
    const menuLinks = Array.from(document.querySelectorAll(".sidebar-left .menu-link"));
    // We identify by icon class when possible:
    menuLinks.forEach(a => {
      const icon = a.querySelector("i")?.className || "";
      if (icon.includes("fa-chart-line")) setI18n(a, "sidebarDashboard");
      if (icon.includes("fa-warehouse")) setI18n(a, "myListings");
      if (icon.includes("fa-box")) setI18n(a, "orders");
      if (icon.includes("fa-truck")) setI18n(a, "logistics");
      if (icon.includes("fa-camera")) setI18n(a, "diseaseScanner");
      if (icon.includes("fa-brain")) setI18n(a, "priceAI");
      if (icon.includes("fa-flask")) setI18n(a, "soilAnalysis");
      if (icon.includes("fa-link")) setI18n(a, "traceability");
      if (icon.includes("fa-file-contract")) setI18n(a, "smartContracts");
    });

    // Stats labels
    document.querySelectorAll(".stat-title").forEach((el) => {
      const txt = el.textContent.trim().toLowerCase();
      if (txt.includes("total")) setI18n(el, "totalRevenue");
      if (txt.includes("wallet")) setI18n(el, "walletBalanceLabel");
      if (txt.includes("active")) setI18n(el, "activeContracts");
      if (txt.includes("trust")) setI18n(el, "trustScore");
    });

    // Achievements title + badge names
    const achTitle = document.querySelector(".sidebar-right .card .card-title i.fa-trophy")?.parentElement;
    if (achTitle) setI18n(achTitle, "achievements");

    document.querySelectorAll(".badge-name").forEach((el) => {
      const txt = el.textContent.trim().toLowerCase();
      if (txt === "trader") setI18n(el, "trader");
      if (txt === "quality") setI18n(el, "quality");
      if (txt === "pioneer") setI18n(el, "pioneer");
      if (txt === "export") setI18n(el, "export");
      if (txt === "green") setI18n(el, "green");
      if (txt === "digital") setI18n(el, "digital");
      if (txt === "mentor") setI18n(el, "mentor");
      if (txt === "leader") setI18n(el, "leader");
    });

    // Wallet label + available balance
    const walletLabel = document.querySelector(".wallet .wallet-label");
    if (walletLabel) setI18n(walletLabel, "digitalWallet");

    const avail = document.querySelector(".wallet div[style*='Available Balance']");
    if (avail) setI18n(avail, "availableBalance");

    // Chat input placeholder
    const chatInput = document.getElementById("chatInput");
    if (chatInput) chatInput.dataset.i18nPlaceholder = "typeMessage";

    // Loader text
    const loaderP = document.querySelector("#loader p");
    if (loaderP) loaderP.dataset.i18n = "loadingExperience";
    const loaderText = document.getElementById("loaderText");
    if (loaderText) loaderText.dataset.i18n = "initializing";

    // Voice overlay
    const listening = document.querySelector("#voiceOverlay div:nth-child(2)");
    if (listening) listening.dataset.i18n = "listening";
    const voiceHint = document.querySelector("#voiceOverlay div:nth-child(3)");
    if (voiceHint) voiceHint.dataset.i18n = "voiceHint";

    // AI tip in chat (the prefilled one)
    const aiTip = Array.from(document.querySelectorAll(".msg-bubble.ai")).find(b => b.textContent.includes("Tip:"));
    if (aiTip) {
      // keep the AgriAI label, translate tip body only
      const tipNode = aiTip.childNodes[aiTip.childNodes.length - 1];
      if (tipNode && tipNode.nodeType === Node.TEXT_NODE) {
        // ignore; weâ€™ll replace entire bubble on setLanguage
        aiTip.dataset.i18nAiTip = "aiTip";
      }
    }
  }

  function setI18n(el, key) {
    if (!el) return;
    el.dataset.i18n = key;
  }

  function applyTranslations() {
    // Elements with data-i18n
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.dataset.i18n;
      // Keep icons intact if this is a button/anchor with children
      const hasIcon = el.querySelector("i");
      if (hasIcon && el.childNodes.length > 1) {
        // Replace only text nodes after icon
        // Approach: set innerHTML preserving icon + trailing text
        const iconHTML = hasIcon.outerHTML;
        // remove existing text but keep badge span if exists
        const badge = el.querySelector(".badge");
        const badgeHTML = badge ? badge.outerHTML : "";
        el.innerHTML = `${iconHTML} ${t(key)} ${badgeHTML}`.trim();
      } else {
        el.textContent = t(key);
      }
    });

    // Placeholder translations
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
      el.setAttribute("placeholder", t(el.dataset.i18nPlaceholder));
    });

    // Chat AI tip bubble refresh
    const aiBubble = Array.from(document.querySelectorAll(".msg-bubble.ai"))[0];
    if (aiBubble && aiBubble.dataset.i18nAiTip) {
      aiBubble.innerHTML = `
        <div style="font-size: 0.7rem; font-weight: bold; margin-bottom: 0.25rem;">AgriAI</div>
        ${t("aiTip")}
      `;
    }
  }

  // ---------- CURRENCY + NUMBER RENDER ----------
  function renderStats() {
    // revenue / wallet amounts
    const revenueEl = document.getElementById("revenue");
    const walletEl = document.getElementById("wallet");
    const walletBalEl = document.getElementById("walletBalance");

    if (revenueEl) revenueEl.textContent = formatMoney(state.base.revenueUSD);
    if (walletEl) walletEl.textContent = formatMoney(state.base.walletUSD);
    if (walletBalEl) walletBalEl.textContent = formatMoney(state.base.walletBalanceUSD);

    // Wallet delta (+$1,200) localized
    const deltaEl = document.querySelectorAll(".stat-change")[1]; // wallet stat-change (second box)
    if (deltaEl) {
      const sign = "+";
      deltaEl.innerHTML = `<i class="fas fa-arrow-up"></i> ${sign}${formatMoney(state.base.walletDeltaUSD)}`;
    }

    // Percent change localized (+15%)
    const revChange = document.querySelectorAll(".stat-change")[0];
    if (revChange) {
      revChange.innerHTML = `<i class="fas fa-arrow-up"></i> ${formatPercent(0.15)}`;
    }
  }

  // ---------- LANGUAGE / CURRENCY HANDLERS ----------
  function setLanguage(lang, showMsg) {
    state.lang = lang;
    localStorage.setItem("agri_lang", lang);
    setDir();
    applyTranslations();
    renderStats();

    // Update dynamic UI strings that are not tagged (like some buttons)
    // Chat input placeholder already handled
    if (showMsg) showToast(t("languageChanged", { lang: lang.toUpperCase() }), "success");
  }

  function setCurrency(code, showMsg) {
    state.currency = code;
    localStorage.setItem("agri_currency", code);
    renderStats();
    if (showMsg) showToast(t("currencyChanged", { currency: code }), "success");
  }

  // Patch your existing select#currency to use setCurrency (and localize formatting)
  function wireCurrencySelect() {
    const sel = document.getElementById("currency");
    if (!sel) return;
    sel.value = state.currency;
    sel.onchange = () => setCurrency(sel.value, true);
  }

  // ---------- FIX switchChat (no more `event` dependency) ----------
  window.switchChat = function (tab, el) {
    document.querySelectorAll(".chat-tab").forEach(t => t.classList.remove("active"));
    if (el) el.classList.add("active");
    // You can later add per-tab filtering; keeping it simple for demo
  };

  // ---------- PATCH sendChat AI response to be translated ----------
  window.sendChat = function () {
    const input = document.getElementById("chatInput");
    if (!input || !input.value.trim()) return;

    const messages = document.getElementById("chatMessages");
    messages.innerHTML += `
      <div class="message own">
        <div class="msg-avatar" style="background: var(--accent); color: var(--text);">ME</div>
        <div class="msg-bubble own">${escapeHtml(input.value)}</div>
      </div>
    `;
    input.value = "";
    messages.scrollTop = messages.scrollHeight;

    setTimeout(() => {
      messages.innerHTML += `
        <div class="message">
          <div class="msg-avatar" style="background: linear-gradient(135deg, var(--purple), #e91e63); color: white;">AI</div>
          <div class="msg-bubble ai">
            <div style="font-size: 0.7rem; font-weight: bold; margin-bottom: 0.25rem;">AgriAI</div>
            ${t("aiReply")}
          </div>
        </div>
      `;
      messages.scrollTop = messages.scrollHeight;
    }, 900);
  };

  // Keep Enter-to-send working
  window.handleChat = function (e) {
    if (e.key === "Enter") window.sendChat();
  };

  // ---------- SAFE HTML ESCAPE ----------
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // ---------- RTL CSS TWEAKS ----------
  function injectRtlStyles() {
    if (document.getElementById("rtlStyles")) return;
    const style = document.createElement("style");
    style.id = "rtlStyles";
    style.textContent = `
      [dir="rtl"] body { direction: rtl; }
      [dir="rtl"] .navbar { flex-direction: row-reverse; }
      [dir="rtl"] .nav-center { flex-direction: row-reverse; }
      [dir="rtl"] .nav-right { flex-direction: row-reverse; }
      [dir="rtl"] .menu-link { justify-content: flex-end; }
      [dir="rtl"] .menu-icon { margin-left: .75rem; margin-right: 0; }
      [dir="rtl"] .toast-container { right: auto; left: 20px; }
      [dir="rtl"] .message.own { flex-direction: row; }
      [dir="rtl"] .message { text-align: right; }
    `;
    document.head.appendChild(style);
  }

  // ---------- INIT MAP (your original function kept) ----------
  window.initMap = function () {
    const mapEl = document.getElementById("map");
    if (!mapEl) return;
    const map = L.map("map").setView([-1.2921, 36.8219], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const markers = [
      { pos: [-1.2921, 36.8219], title: "Nairobi - Warehouse" },
      { pos: [-0.0236, 37.9062], title: "Mt. Kenya - Farm" },
      { pos: [-1.2864, 36.8172], title: "In Transit" }
    ];
    markers.forEach(m => L.marker(m.pos).addTo(map).bindPopup(m.title));
  };

  // ---------- LOADER (your original loader but translated) ----------
  window.addEventListener("load", () => {
    injectRtlStyles();
    injectLanguageSelector();
    buildSections();
    bindNavClicks();
    applyI18nKeysOnce();
    wireCurrencySelect();

    // Apply saved language/dir before showing anything
    setDir();
    applyTranslations();
    renderStats();

    // Restore last section
    showSection(state.section);

    // Loader
    let progress = 0;
    const loader = document.getElementById("loader");
    const progressBar = document.getElementById("loaderProgress");
    const loaderText = document.getElementById("loaderText");

    const steps = {
      en: ["Initializing AI modules...", "Loading blockchain...", "Connecting to mobile money...", "Setting up secure channels...", "Ready!"],
      es: ["Iniciando mÃ³dulos IA...", "Cargando blockchain...", "Conectando dinero mÃ³vil...", "Configurando canales seguros...", "Â¡Listo!"],
      fr: ["Initialisation des modules IA...", "Chargement blockchain...", "Connexion Mobile Money...", "Mise en place sÃ©curisÃ©e...", "PrÃªt !"],
      ar: ["ØªÙ‡ÙŠØ¦Ø© ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡...", "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆÙƒ ØªØ´ÙŠÙ†...", "Ø±Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø§Ù„Ù‡Ø§ØªÙ...", "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¢Ù…Ù†Ø©...", "Ø¬Ø§Ù‡Ø²!"]
    };

    const texts = steps[state.lang] || steps.en;

    const interval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress >= 100) {
        progress = 100;
        clearInterval(interval);
        setTimeout(() => {
          loader && loader.classList.add("hidden");
          // init map after loader
          try { window.initMap(); } catch {}
        }, 400);
      }
      if (progressBar) progressBar.style.width = progress + "%";
      if (loaderText) loaderText.textContent = texts[Math.min(texts.length - 1, Math.floor((progress / 100) * (texts.length - 1)))];
    }, 180);

    // Wire language select
    const langSel = document.getElementById("langSelect");
    if (langSel) langSel.value = state.lang;

    // Wire currency select without any extra â€œstartup toastâ€
    const curSel = document.getElementById("currency");
    if (curSel) {
      curSel.value = state.currency;
      curSel.addEventListener("change", () => setCurrency(curSel.value, true));
    }
  });

  // Expose setLanguage globally if you want to call it
  window.setLanguage = setLanguage;
  window.setCurrency = setCurrency;

})();
</script>
