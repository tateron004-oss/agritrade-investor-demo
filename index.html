<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgriTrade Africa â€” Investor Demo</title>

  <!-- GitHub Pages safe: CDN assets ok -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --card2:#0f172a;
      --text:#e5e7eb;
      --text-light:#a7b0c0;
      --accent:#22c55e;
      --purple:#8b5cf6;
      --border:rgba(255,255,255,.08);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(34,197,94,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 20%, rgba(139,92,246,.20), transparent 55%),
                  var(--bg);
    }
    a{color:inherit; text-decoration:none}
    .navbar{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(10,14,22,.65);
      backdrop-filter: blur(12px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .brand .logo{
      width:34px; height:34px; border-radius:10px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .nav-center{display:flex; gap:10px; align-items:center;}
    .nav-btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      display:flex; gap:8px; align-items:center;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
    }
    .nav-btn:hover{background: rgba(255,255,255,.06)}
    .nav-btn:active{transform: translateY(1px)}
    .nav-btn.active{outline:2px solid rgba(34,197,94,.25); border-color: rgba(34,197,94,.35)}
    .nav-right{display:flex; gap:10px; align-items:center;}
    select, input{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      outline:none;
    }
    .layout{
      display:grid;
      grid-template-columns: 240px 1fr 280px;
      gap:14px;
      padding:14px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .sidebar-left,.sidebar-right,.main{
      min-height: calc(100vh - 70px);
    }
    .panel{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .sidebar-left{padding:12px}
    .menu-title{font-size:.85rem; color:var(--text-light); margin:10px 8px 8px;}
    .menu-link{
      display:flex; align-items:center; justify-content:flex-start;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease;
    }
    .menu-link:hover{background: rgba(255,255,255,.05)}
    .menu-link.active{background: rgba(34,197,94,.12); outline:1px solid rgba(34,197,94,.25)}
    .menu-icon{
      width:32px; height:32px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
    }
    .main{padding:0}
    .card{
      border:1px solid var(--border);
      background: rgba(17,24,39,.65);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .card-title{font-weight:900; display:flex; align-items:center; gap:10px}
    .content-pad{padding:12px 14px}
    .grid4{display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px;}
    @media(max-width:1100px){ .layout{grid-template-columns: 220px 1fr; } .sidebar-right{display:none} .grid4{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media(max-width:720px){ .layout{grid-template-columns: 1fr;} .sidebar-left{display:none} .grid4{grid-template-columns: 1fr;} }
    .stat{
      padding:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
    }
    .stat-title{font-size:.85rem; color:var(--text-light)}
    .stat-value{font-size:1.6rem; font-weight:900; margin-top:6px}
    .stat-change{font-size:.85rem; margin-top:6px; color: #86efac}
    .action-btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
      transition: background .15s ease, transform .08s ease;
    }
    .action-btn:hover{background: rgba(255,255,255,.07)}
    .action-btn:active{transform: translateY(1px)}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-size:.78rem;
      color: var(--text-light);
    }
    table{border-collapse:collapse}
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      font-size:.92rem;
      vertical-align:top;
    }
    .table th{color:var(--text-light); font-weight:800; text-transform:none}
    .toast-container{
      position:fixed;
      right:20px;
      bottom:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
    }
    .toast{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(17,24,39,.9);
      box-shadow: var(--shadow);
      max-width: 420px;
    }
    .toast.success i{color:#22c55e}
    .toast.error i{color:#ef4444}
    .toast.info i{color:#60a5fa}

    /* Chat box on right */
    .chat-wrap{padding:12px}
    .chat-box{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height: 380px;
    }
    .chat-head{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .chat-tabs{display:flex; gap:8px}
    .chat-tab{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      cursor:pointer;
      font-size:.82rem;
      color:var(--text-light);
      user-select:none;
      background: rgba(255,255,255,.03);
    }
    .chat-tab.active{color:var(--text); outline:2px solid rgba(34,197,94,.18)}
    .chat-messages{padding:10px; overflow:auto; flex:1}
    .message{display:flex; gap:10px; margin:10px 0}
    .message.own{justify-content:flex-end}
    .msg-avatar{
      width:34px; height:34px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      font-weight:900; font-size:.78rem;
    }
    .msg-bubble{
      max-width: 70%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius: 14px;
      line-height:1.55;
    }
    .msg-bubble.own{background: rgba(34,197,94,.10)}
    .chat-input{
      display:flex; gap:8px;
      padding:10px;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.08);
    }
    .chat-input input{flex:1}

    /* Modal */
    #agriModal{
      position:fixed; inset:0; display:none;
      background: rgba(0,0,0,.55);
      align-items:center; justify-content:center;
      z-index: 99999;
      padding: 20px;
    }
    #agriModalCard{
      width: min(920px, 96vw);
      max-height: 88vh;
      overflow:auto;
      background: rgba(17,24,39,.96);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
      padding: 16px 16px 12px 16px;
    }

    /* RTL tweaks */
    [dir="rtl"] .navbar { flex-direction: row-reverse; }
    [dir="rtl"] .nav-center { flex-direction: row-reverse; }
    [dir="rtl"] .nav-right { flex-direction: row-reverse; }
    [dir="rtl"] .menu-link{justify-content:flex-end}
    [dir="rtl"] .toast-container{right:auto; left:20px}
    [dir="rtl"] .message{ text-align:right }
    [dir="rtl"] .message.own{ flex-direction: row }
    [dir="rtl"] #agriModalCard input, [dir="rtl"] #agriModalCard select { direction:ltr; }
  </style>
</head>

<body>
  <div class="navbar">
    <div class="brand">
      <div class="logo"></div>
      <div id="appName">AgriTrade Africa</div>
    </div>

    <div class="nav-center">
      <div class="nav-btn active" data-nav="dashboard"><i class="fa-solid fa-chart-line"></i> <span data-i18n="navDashboard">Dashboard</span></div>
      <div class="nav-btn" data-nav="market"><i class="fa-solid fa-store"></i> <span data-i18n="navMarket">Market</span></div>
      <div class="nav-btn" data-nav="wallet"><i class="fa-solid fa-wallet"></i> <span data-i18n="navWallet">Wallet</span></div>
      <div class="nav-btn" data-nav="ai"><i class="fa-solid fa-robot"></i> <span data-i18n="navAITools">AI Tools</span></div>
    </div>

    <div class="nav-right">
      <!-- Language selector injected by script -->
      <select id="currency" title="Currency">
        <option value="USD">USD</option>
        <option value="KES">KES</option>
        <option value="ETB">ETB</option>
        <option value="RWF">RWF</option>
      </select>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar-left panel">
      <div class="menu-title">NAV</div>

      <div class="menu-link active" data-nav="dashboard">
        <div class="menu-icon"><i class="fa-solid fa-chart-line"></i></div>
        <div data-i18n="sidebarDashboard">Dashboard</div>
      </div>

      <div class="menu-link" data-nav="listings">
        <div class="menu-icon"><i class="fa-solid fa-warehouse"></i></div>
        <div data-i18n="myListings">My Listings</div>
      </div>

      <div class="menu-link" data-nav="orders">
        <div class="menu-icon"><i class="fa-solid fa-box"></i></div>
        <div data-i18n="orders">Orders</div>
      </div>

      <div class="menu-link" data-nav="logistics">
        <div class="menu-icon"><i class="fa-solid fa-truck"></i></div>
        <div data-i18n="logistics">Logistics</div>
      </div>

      <div class="menu-title">TRUST</div>

      <div class="menu-link" data-nav="traceability">
        <div class="menu-icon"><i class="fa-solid fa-link"></i></div>
        <div data-i18n="traceability">Traceability</div>
      </div>

      <div class="menu-link" data-nav="contracts">
        <div class="menu-icon"><i class="fa-solid fa-file-contract"></i></div>
        <div data-i18n="smartContracts">Smart Contracts</div>
      </div>
    </aside>

    <main class="main" id="mainContent">
      <!-- DASHBOARD (this content gets wrapped into a dashboard section automatically) -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-gauge-high"></i> Dashboard</div>
          <div class="badge">LIVE</div>
        </div>
        <div class="content-pad">
          <div class="grid4">
            <div class="stat">
              <div class="stat-title">Total Revenue</div>
              <div class="stat-value" id="revenue">$0</div>
              <div class="stat-change"><i class="fa-solid fa-arrow-up"></i> 15%</div>
            </div>
            <div class="stat">
              <div class="stat-title">Wallet Balance</div>
              <div class="stat-value" id="wallet">$0</div>
              <div class="stat-change"><i class="fa-solid fa-arrow-up"></i> +$0</div>
            </div>
            <div class="stat">
              <div class="stat-title">Active Contracts</div>
              <div class="stat-value">12</div>
              <div class="stat-change"><i class="fa-solid fa-circle-check"></i> Verified</div>
            </div>
            <div class="stat">
              <div class="stat-title">Trust Score</div>
              <div class="stat-value">94</div>
              <div class="stat-change"><i class="fa-solid fa-shield"></i> Verified</div>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:10px;">
            <button class="action-btn" data-nav="market"><i class="fa-solid fa-store"></i> Open Market</button>
            <button class="action-btn" data-nav="wallet"><i class="fa-solid fa-wallet"></i> Open Wallet</button>
            <button class="action-btn" data-nav="orders"><i class="fa-solid fa-box"></i> View Orders</button>
            <button class="action-btn" data-nav="listings"><i class="fa-solid fa-warehouse"></i> My Listings</button>
          </div>

          <div style="margin-top:12px; color:var(--text-light); line-height:1.7;">
            This is a static investor demo for GitHub Pages (no backend). All actions update real demo data in your browser.
          </div>
        </div>
      </div>
    </main>

    <aside class="sidebar-right panel">
      <div class="chat-wrap">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-comments"></i> AgriAI Chat</div>
            <div class="chat-tabs">
              <div class="chat-tab active" onclick="switchChat('all')">All</div>
              <div class="chat-tab" onclick="switchChat('buyers')">Buyers</div>
              <div class="chat-tab" onclick="switchChat('sellers')">Sellers</div>
            </div>
          </div>

          <div class="chat-box">
            <div class="chat-messages" id="chatMessages">
              <div class="message">
                <div class="msg-avatar" style="background: linear-gradient(135deg, var(--purple), #e91e63); color: white;">AI</div>
                <div class="msg-bubble ai">
                  <div style="font-size: 0.7rem; font-weight: bold; margin-bottom: 0.25rem;">AgriAI</div>
                  ðŸ’¡ Tip: Offer bulk discount for 1000kg+ to increase deal size
                </div>
              </div>
            </div>
            <div class="chat-input">
              <input id="chatInput" placeholder="Type message..." onkeydown="handleChat(event)" />
              <button class="action-btn" onclick="sendChat()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-trophy"></i> Achievements</div>
            <div class="badge">Level 7</div>
          </div>
          <div class="content-pad" style="display:flex; flex-wrap:wrap; gap:10px;">
            <span class="badge">Trader</span>
            <span class="badge">Quality</span>
            <span class="badge">Pioneer</span>
            <span class="badge">Export</span>
            <span class="badge">Green</span>
            <span class="badge">Digital</span>
            <span class="badge">Mentor</span>
            <span class="badge">Leader</span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <!-- Modal -->
  <div id="agriModal">
    <div id="agriModalCard">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div id="agriModalTitle" style="font-weight:900; font-size:1.05rem;"></div>
        <button id="agriModalClose" class="action-btn"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="agriModalBody" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
  /**
   * AgriTrade Africa â€” GitHub Pages Safe Investor Demo (single-file)
   * - Fully functional Market, Wallet Ledger, Orders, My Listings, Logistics, Traceability, Smart Contracts
   * - Multilingual + currency conversions everywhere
   * - Uses localStorage only (no backend required)
   */

  (function () {
    // ---------- STATE / STORAGE ----------
    const LS = { lang:"agri_lang", currency:"agri_currency", section:"agri_section", data:"agri_demo_data_v4" };
    const state = {
      lang: localStorage.getItem(LS.lang) || "en",
      currency: localStorage.getItem(LS.currency) || "USD",
      section: localStorage.getItem(LS.section) || "dashboard"
    };

    const rates = { USD:1, KES:130.5, ETB:54.2, RWF:1220 };
    const LOCALES = { en:"en-US", es:"es-ES", fr:"fr-FR", ar:"ar" };
    const RTL = new Set(["ar"]);

    // ---------- I18N ----------
    const I18N = {
      en:{ appName:"AgriTrade Africa", navDashboard:"Dashboard", navMarket:"Market", navWallet:"Wallet", navAITools:"AI Tools",
        sidebarDashboard:"Dashboard", myListings:"My Listings", orders:"Orders", logistics:"Logistics", traceability:"Traceability", smartContracts:"Smart Contracts",
        marketTitle:"Market Listings", search:"Search", category:"Category", origin:"Origin", crop:"Crop", grade:"Grade", available:"Available", pricePerKg:"Price / kg",
        minOrder:"Min Order", viewDetails:"View Details", requestQuote:"Request Quote", openChat:"Chat", buyNow:"Buy Now", addToOrders:"Added to Orders", quoteSent:"Quote request sent",
        listingsTitle:"My Listings", createListing:"Create Listing", edit:"Edit", delete:"Delete", publish:"Publish", unpublish:"Unpublish", save:"Save", cancel:"Cancel",
        listingSaved:"Listing saved", listingDeleted:"Listing deleted",
        ordersTitle:"Orders", status:"Status", all:"All", pending:"Pending", confirmed:"Confirmed", inTransit:"In Transit", delivered:"Delivered", disputed:"Disputed", refunded:"Refunded",
        orderId:"Order ID", buyer:"Buyer", seller:"Seller", total:"Total", created:"Created", actions:"Actions", view:"View",
        markConfirmed:"Mark Confirmed", markInTransit:"Mark In Transit", markDelivered:"Mark Delivered", openDispute:"Open Dispute", refund:"Refund", orderUpdated:"Order updated",
        walletTitle:"Wallet & Ledger", availableBalance:"Available Balance", escrow:"Escrow", ledger:"Ledger", deposit:"Deposit", send:"Send", receive:"Receive",
        phoneNumber:"Phone Number", amount:"Amount", note:"Note", confirm:"Confirm", txType:"Type", txRef:"Reference", txCounterparty:"Counterparty", txDate:"Date", txAmount:"Amount",
        depositSuccess:"Deposit successful", sendSuccess:"Transfer sent", receiveSuccess:"Funds received",
        aiToolsTitle:"AI Tools", scanCrop:"Scan Crop", predictPrices:"Predict Prices", soilTest:"Soil Test", weatherAI:"Weather AI",
        logisticsTitle:"Live Logistics", shipmentId:"Shipment ID", route:"Route", eta:"ETA", carrier:"Carrier", lastPing:"Last Ping",
        traceTitle:"Traceability", batchId:"Batch ID", event:"Event", actor:"Actor", location:"Location",
        contractsTitle:"Smart Contracts", contractId:"Contract ID", terms:"Terms", claim:"Claim", claimed:"Claimed",
        aiReply:"Thanks for your message! Iâ€™ll help you find the best buyers for your crops.",
        currencyChanged:"Currency changed to {currency}", languageChanged:"Language changed to {lang}"
      },
      es:{ appName:"AgriTrade Ãfrica", navDashboard:"Panel", navMarket:"Mercado", navWallet:"Billetera", navAITools:"Herramientas IA",
        sidebarDashboard:"Panel", myListings:"Mis anuncios", orders:"Pedidos", logistics:"LogÃ­stica", traceability:"Trazabilidad", smartContracts:"Contratos inteligentes",
        marketTitle:"Anuncios del mercado", search:"Buscar", category:"CategorÃ­a", origin:"Origen", crop:"Cultivo", grade:"Calidad", available:"Disponible", pricePerKg:"Precio / kg",
        minOrder:"Pedido mÃ­nimo", viewDetails:"Ver detalles", requestQuote:"Pedir cotizaciÃ³n", openChat:"Chat", buyNow:"Comprar ahora",
        addToOrders:"Agregado a Pedidos", quoteSent:"Solicitud de cotizaciÃ³n enviada",
        listingsTitle:"Mis anuncios", createListing:"Crear anuncio", edit:"Editar", delete:"Eliminar", publish:"Publicar", unpublish:"Ocultar", save:"Guardar", cancel:"Cancelar",
        listingSaved:"Anuncio guardado", listingDeleted:"Anuncio eliminado",
        ordersTitle:"Pedidos", status:"Estado", all:"Todos", pending:"Pendiente", confirmed:"Confirmado", inTransit:"En trÃ¡nsito", delivered:"Entregado", disputed:"En disputa", refunded:"Reembolsado",
        orderId:"ID pedido", buyer:"Comprador", seller:"Vendedor", total:"Total", created:"Creado", actions:"Acciones", view:"Ver",
        markConfirmed:"Marcar confirmado", markInTransit:"Marcar en trÃ¡nsito", markDelivered:"Marcar entregado", openDispute:"Abrir disputa", refund:"Reembolsar", orderUpdated:"Pedido actualizado",
        walletTitle:"Billetera y libro mayor", availableBalance:"Saldo disponible", escrow:"DepÃ³sito en garantÃ­a", ledger:"Libro mayor", deposit:"Depositar", send:"Enviar", receive:"Recibir",
        phoneNumber:"NÃºmero de telÃ©fono", amount:"Monto", note:"Nota", confirm:"Confirmar", txType:"Tipo", txRef:"Referencia", txCounterparty:"Contraparte", txDate:"Fecha", txAmount:"Monto",
        depositSuccess:"DepÃ³sito exitoso", sendSuccess:"Transferencia enviada", receiveSuccess:"Fondos recibidos",
        aiToolsTitle:"Herramientas IA", scanCrop:"Escanear cultivo", predictPrices:"Predecir precios", soilTest:"Prueba de suelo", weatherAI:"IA del clima",
        logisticsTitle:"LogÃ­stica en vivo", shipmentId:"ID envÃ­o", route:"Ruta", eta:"ETA", carrier:"Transportista", lastPing:"Ãšltimo ping",
        traceTitle:"Trazabilidad", batchId:"ID lote", event:"Evento", actor:"Actor", location:"UbicaciÃ³n",
        contractsTitle:"Contratos inteligentes", contractId:"ID contrato", terms:"TÃ©rminos", claim:"Reclamar", claimed:"Reclamado",
        aiReply:"Â¡Gracias por tu mensaje! Te ayudarÃ© a encontrar los mejores compradores para tus cultivos.",
        currencyChanged:"Moneda cambiada a {currency}", languageChanged:"Idioma cambiado a {lang}"
      },
      fr:{ appName:"AgriTrade Afrique", navDashboard:"Tableau de bord", navMarket:"MarchÃ©", navWallet:"Portefeuille", navAITools:"Outils IA",
        sidebarDashboard:"Tableau de bord", myListings:"Mes annonces", orders:"Commandes", logistics:"Logistique", traceability:"TraÃ§abilitÃ©", smartContracts:"Contrats intelligents",
        marketTitle:"Annonces du marchÃ©", search:"Rechercher", category:"CatÃ©gorie", origin:"Origine", crop:"Culture", grade:"QualitÃ©", available:"Disponible", pricePerKg:"Prix / kg",
        minOrder:"Commande min.", viewDetails:"Voir dÃ©tails", requestQuote:"Demander un devis", openChat:"Chat", buyNow:"Acheter",
        addToOrders:"AjoutÃ© aux commandes", quoteSent:"Demande de devis envoyÃ©e",
        listingsTitle:"Mes annonces", createListing:"CrÃ©er une annonce", edit:"Modifier", delete:"Supprimer", publish:"Publier", unpublish:"DÃ©publier", save:"Enregistrer", cancel:"Annuler",
        listingSaved:"Annonce enregistrÃ©e", listingDeleted:"Annonce supprimÃ©e",
        ordersTitle:"Commandes", status:"Statut", all:"Toutes", pending:"En attente", confirmed:"ConfirmÃ©e", inTransit:"En transit", delivered:"LivrÃ©e", disputed:"Litige", refunded:"RemboursÃ©e",
        orderId:"ID commande", buyer:"Acheteur", seller:"Vendeur", total:"Total", created:"CrÃ©Ã©e", actions:"Actions", view:"Voir",
        markConfirmed:"Marquer confirmÃ©e", markInTransit:"Marquer en transit", markDelivered:"Marquer livrÃ©e", openDispute:"Ouvrir un litige", refund:"Rembourser", orderUpdated:"Commande mise Ã  jour",
        walletTitle:"Portefeuille & registre", availableBalance:"Solde disponible", escrow:"SÃ©questre", ledger:"Registre", deposit:"DÃ©pÃ´t", send:"Envoyer", receive:"Recevoir",
        phoneNumber:"NumÃ©ro de tÃ©lÃ©phone", amount:"Montant", note:"Note", confirm:"Confirmer", txType:"Type", txRef:"RÃ©fÃ©rence", txCounterparty:"Contrepartie", txDate:"Date", txAmount:"Montant",
        depositSuccess:"DÃ©pÃ´t rÃ©ussi", sendSuccess:"Transfert envoyÃ©", receiveSuccess:"Fonds reÃ§us",
        aiToolsTitle:"Outils IA", scanCrop:"Scanner la culture", predictPrices:"PrÃ©dire les prix", soilTest:"Test du sol", weatherAI:"IA mÃ©tÃ©o",
        logisticsTitle:"Logistique en direct", shipmentId:"ID expÃ©dition", route:"Trajet", eta:"ETA", carrier:"Transporteur", lastPing:"Dernier ping",
        traceTitle:"TraÃ§abilitÃ©", batchId:"ID lot", event:"Ã‰vÃ©nement", actor:"Acteur", location:"Lieu",
        contractsTitle:"Contrats intelligents", contractId:"ID contrat", terms:"Conditions", claim:"RÃ©clamer", claimed:"RÃ©clamÃ©",
        aiReply:"Merci pour votre message ! Je vais vous aider Ã  trouver les meilleurs acheteurs.",
        currencyChanged:"Devise changÃ©e en {currency}", languageChanged:"Langue : {lang}"
      },
      ar:{ appName:"Ø£Ø¬Ø±ÙŠØªØ±ÙŠØ¯ Ø£ÙØ±ÙŠÙ‚ÙŠØ§", navDashboard:"Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", navMarket:"Ø§Ù„Ø³ÙˆÙ‚", navWallet:"Ø§Ù„Ù…Ø­ÙØ¸Ø©", navAITools:"Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡",
        sidebarDashboard:"Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", myListings:"Ø¹Ø±ÙˆØ¶ÙŠ", orders:"Ø§Ù„Ø·Ù„Ø¨Ø§Øª", logistics:"Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª", traceability:"Ø§Ù„ØªØªØ¨Ø¹", smartContracts:"Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠØ©",
        marketTitle:"Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆÙ‚", search:"Ø¨Ø­Ø«", category:"Ø§Ù„ÙØ¦Ø©", origin:"Ø§Ù„Ù…Ù†Ø´Ø£", crop:"Ø§Ù„Ù…Ø­ØµÙˆÙ„", grade:"Ø§Ù„Ø¯Ø±Ø¬Ø©", available:"Ø§Ù„Ù…ØªØ§Ø­", pricePerKg:"Ø§Ù„Ø³Ø¹Ø± / ÙƒØº",
        minOrder:"Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰", viewDetails:"Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„", requestQuote:"Ø·Ù„Ø¨ Ø³Ø¹Ø±", openChat:"Ø¯Ø±Ø¯Ø´Ø©", buyNow:"Ø§Ø´ØªØ±Ù Ø§Ù„Ø¢Ù†",
        addToOrders:"ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨Ø§Øª", quoteSent:"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±",
        listingsTitle:"Ø¹Ø±ÙˆØ¶ÙŠ", createListing:"Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶", edit:"ØªØ¹Ø¯ÙŠÙ„", delete:"Ø­Ø°Ù", publish:"Ù†Ø´Ø±", unpublish:"Ø¥Ø®ÙØ§Ø¡", save:"Ø­ÙØ¸", cancel:"Ø¥Ù„ØºØ§Ø¡",
        listingSaved:"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶", listingDeleted:"ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶",
        ordersTitle:"Ø§Ù„Ø·Ù„Ø¨Ø§Øª", status:"Ø§Ù„Ø­Ø§Ù„Ø©", all:"Ø§Ù„ÙƒÙ„", pending:"Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", confirmed:"Ù…Ø¤ÙƒØ¯", inTransit:"Ù‚ÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„", delivered:"ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", disputed:"Ù†Ø²Ø§Ø¹", refunded:"Ù…Ø³ØªØ±Ø¬Ø¹",
        orderId:"Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨", buyer:"Ø§Ù„Ù…Ø´ØªØ±ÙŠ", seller:"Ø§Ù„Ø¨Ø§Ø¦Ø¹", total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", created:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡", actions:"Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª", view:"Ø¹Ø±Ø¶",
        markConfirmed:"ØªØ£ÙƒÙŠØ¯", markInTransit:"ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„", markDelivered:"ØªØ¹ÙŠÙŠÙ† ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…", openDispute:"ÙØªØ­ Ù†Ø²Ø§Ø¹", refund:"Ø§Ø³ØªØ±Ø¬Ø§Ø¹", orderUpdated:"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨",
        walletTitle:"Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„Ø³Ø¬Ù„", availableBalance:"Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­", escrow:"Ø­Ø¬Ø²", ledger:"Ø§Ù„Ø³Ø¬Ù„", deposit:"Ø¥ÙŠØ¯Ø§Ø¹", send:"Ø¥Ø±Ø³Ø§Ù„", receive:"Ø§Ø³ØªÙ„Ø§Ù…",
        phoneNumber:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", amount:"Ø§Ù„Ù…Ø¨Ù„Øº", note:"Ù…Ù„Ø§Ø­Ø¸Ø©", confirm:"ØªØ£ÙƒÙŠØ¯", txType:"Ø§Ù„Ù†ÙˆØ¹", txRef:"Ø§Ù„Ù…Ø±Ø¬Ø¹", txCounterparty:"Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±", txDate:"Ø§Ù„ØªØ§Ø±ÙŠØ®", txAmount:"Ø§Ù„Ù…Ø¨Ù„Øº",
        depositSuccess:"ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­", sendSuccess:"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„", receiveSuccess:"ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£Ù…ÙˆØ§Ù„",
        aiToolsTitle:"Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡", scanCrop:"ÙØ­Øµ Ø§Ù„Ù…Ø­ØµÙˆÙ„", predictPrices:"ØªÙˆÙ‚Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±", soilTest:"Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ±Ø¨Ø©", weatherAI:"Ø°ÙƒØ§Ø¡ Ø§Ù„Ø·Ù‚Ø³",
        logisticsTitle:"Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©", shipmentId:"Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø©", route:"Ø§Ù„Ù…Ø³Ø§Ø±", eta:"ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„", carrier:"Ø§Ù„Ù†Ø§Ù‚Ù„", lastPing:"Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«",
        traceTitle:"Ø§Ù„ØªØªØ¨Ø¹", batchId:"Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©", event:"Ø§Ù„Ø­Ø¯Ø«", actor:"Ø§Ù„Ø¬Ù‡Ø©", location:"Ø§Ù„Ù…ÙˆÙ‚Ø¹",
        contractsTitle:"Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠØ©", contractId:"Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯", terms:"Ø§Ù„Ø´Ø±ÙˆØ·", claim:"Ù…Ø·Ø§Ù„Ø¨Ø©", claimed:"ØªÙ…Øª Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©",
        aiReply:"Ø´ÙƒØ±Ù‹Ø§ Ù„Ø±Ø³Ø§Ù„ØªÙƒ! Ø³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ† Ù„Ù…Ø­Ø§ØµÙŠÙ„Ùƒ.",
        currencyChanged:"ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ {currency}", languageChanged:"ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ {lang}"
      }
    };

    function t(key, vars){
      const dict = I18N[state.lang] || I18N.en;
      let s = dict[key] || I18N.en[key] || key;
      if (vars) Object.keys(vars).forEach(k => s = s.replaceAll(`{${k}}`, String(vars[k])));
      return s;
    }
    function locale(){ return LOCALES[state.lang] || "en-US"; }
    function setDir(){
      const rtl = RTL.has(state.lang);
      document.documentElement.setAttribute("dir", rtl ? "rtl" : "ltr");
      document.documentElement.setAttribute("lang", state.lang);
    }
    function moneyFromUSD(usd){
      const r = rates[state.currency] || 1;
      const val = usd * r;
      try{
        return new Intl.NumberFormat(locale(), { style:"currency", currency: state.currency, maximumFractionDigits: 2 }).format(val);
      }catch{
        return `${val.toLocaleString(locale())} ${state.currency}`;
      }
    }
    function toUSD(amountInCurrency){
      const r = rates[state.currency] || 1;
      return Number(amountInCurrency) / r;
    }
    function fmtDate(d){
      return new Intl.DateTimeFormat(locale(), { dateStyle:"medium", timeStyle:"short" }).format(new Date(d));
    }
    function escapeHtml(str){
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // ---------- TOAST ----------
    function showToast(message, type="info"){
      const c = document.getElementById("toastContainer");
      if(!c) return;
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      const icon = type==="success" ? "check-circle" : type==="error" ? "exclamation-circle" : "info-circle";
      el.innerHTML = `<i class="fas fa-${icon}"></i><span>${escapeHtml(message)}</span>`;
      c.appendChild(el);
      setTimeout(()=> el.remove(), 3200);
    }

    // ---------- MODAL ----------
    const modal = document.getElementById("agriModal");
    const modalTitle = document.getElementById("agriModalTitle");
    const modalBody = document.getElementById("agriModalBody");
    document.getElementById("agriModalClose").addEventListener("click", ()=> modal.style.display="none");
    modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.style.display="none"; });
    function openModal(title, html){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      modal.style.display="flex";
    }
    function closeModal(){ modal.style.display="none"; }

    // ---------- DATA ----------
    function seedData(){
      const data = {
        me: { id:"u_me", name:"AgriTrade Seller", country:"Kenya" },
        listings: [
          { id:"L-KE-MZ-001", ownerId:"u_me", ownerName:"AgriTrade Seller", crop:"Maize", category:"Grain", origin:"Kenya", grade:"A", availableKg:5000, minOrderKg:250, pricePerKgUSD:0.42, moisture:"12%", packaging:"50kg bags", harvestDate:"2026-01-20T09:00:00.000Z", published:true },
          { id:"L-RW-BN-014", ownerId:"u_rw_1", ownerName:"Kigali Agro Co-op", crop:"Beans", category:"Legume", origin:"Rwanda", grade:"Premium", availableKg:2400, minOrderKg:100, pricePerKgUSD:0.95, moisture:"11%", packaging:"25kg sacks", harvestDate:"2026-02-03T09:00:00.000Z", published:true },
          { id:"L-ET-CO-007", ownerId:"u_et_1", ownerName:"Addis Highlands Exporters", crop:"Coffee", category:"Cash Crop", origin:"Ethiopia", grade:"AA", availableKg:1200, minOrderKg:60, pricePerKgUSD:6.35, moisture:"10.5%", packaging:"Jute 60kg", harvestDate:"2026-01-29T09:00:00.000Z", published:true },
          { id:"L-KE-MN-021", ownerId:"u_ke_2", ownerName:"Mombasa Mango Growers", crop:"Mango", category:"Fruit", origin:"Kenya", grade:"Export", availableKg:8000, minOrderKg:300, pricePerKgUSD:0.78, moisture:"Fresh", packaging:"Crates", harvestDate:"2026-02-08T09:00:00.000Z", published:true }
        ],
        orders: [
          { id:"O-10021", listingId:"L-RW-BN-014", crop:"Beans", qtyKg:300, pricePerKgUSD:0.95, buyerName:"Nairobi Foods Ltd", sellerName:"Kigali Agro Co-op", status:"inTransit", createdAt:"2026-02-09T14:22:00.000Z", notes:"Delivery to Nairobi cold store" }
        ],
        wallet: { availableUSD: 8320.5, escrowUSD: 1240.0 },
        ledger: [
          { id:"TX-90011", type:"deposit", ref:"MM-KE-112930", counterparty:"M-Pesa", amountUSD:5000, createdAt:"2026-01-18T10:05:00.000Z", note:"Operating float" },
          { id:"TX-90012", type:"escrow_hold", ref:"ESC-O-10021", counterparty:"Escrow", amountUSD:-1240, createdAt:"2026-02-09T14:23:00.000Z", note:"Order escrow hold" }
        ],
        logistics: [
          { shipmentId:"S-77301", route:"Kigali â†’ Nairobi", carrier:"SwiftHaul Logistics", eta:"2026-02-14T15:00:00.000Z", lastPing:"2026-02-13T08:10:00.000Z", status:"inTransit" },
          { shipmentId:"S-77322", route:"Addis Ababa â†’ Djibouti Port", carrier:"BlueRoute Freight", eta:"2026-02-15T09:30:00.000Z", lastPing:"2026-02-13T07:42:00.000Z", status:"inTransit" }
        ],
        traceability: [
          { batchId:"B-KE-MZ-8821", event:"Harvested", actor:"Farm Co-op", location:"Nakuru, Kenya", createdAt:"2026-01-20T09:10:00.000Z" },
          { batchId:"B-KE-MZ-8821", event:"Quality Check", actor:"Independent Inspector", location:"Nakuru Depot", createdAt:"2026-01-22T12:40:00.000Z" },
          { batchId:"B-KE-MZ-8821", event:"Loaded", actor:"Warehouse", location:"Nairobi Warehouse", createdAt:"2026-01-24T16:05:00.000Z" }
        ],
        contracts: [
          { contractId:"C-ESC-22018", terms:"Escrow releases on delivery confirmation + buyer sign-off within 24h", status:"active", claimed:false },
          { contractId:"C-INS-11007", terms:"Cargo insurance covers loss/damage; claim window 7 days", status:"active", claimed:false }
        ]
      };
      localStorage.setItem(LS.data, JSON.stringify(data));
      return data;
    }
    function loadData(){
      try{
        const raw = localStorage.getItem(LS.data);
        if(!raw) return seedData();
        const parsed = JSON.parse(raw);
        if(!parsed.listings || !parsed.wallet || !parsed.ledger) return seedData();
        return parsed;
      }catch{ return seedData(); }
    }
    let DB = loadData();
    function saveData(){ localStorage.setItem(LS.data, JSON.stringify(DB)); }
    function nowISO(){ return new Date().toISOString(); }
    function nextId(prefix){ return `${prefix}-${Math.floor(Math.random()*90000+10000)}`; }

    // ---------- LANGUAGE SELECTOR ----------
    function injectLanguageSelector(){
      const navRight = document.querySelector(".nav-right");
      if(!navRight || document.getElementById("langSelect")) return;
      const sel = document.createElement("select");
      sel.id = "langSelect";
      sel.title = "Language";
      sel.innerHTML = `
        <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
        <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
        <option value="fr">ðŸ‡«ðŸ‡· FR</option>
        <option value="ar">ðŸ‡¸ðŸ‡¦ AR</option>
      `;
      sel.value = state.lang;
      sel.addEventListener("change", ()=> setLanguage(sel.value, true));
      navRight.insertBefore(sel, navRight.firstChild);
    }

    function applyTranslations(){
      document.getElementById("appName").textContent = t("appName");
      document.querySelectorAll("[data-i18n]").forEach(el => el.textContent = t(el.dataset.i18n));
      const chatInput = document.getElementById("chatInput");
      if(chatInput) chatInput.placeholder = (I18N[state.lang]?.typeMessage) ? I18N[state.lang].typeMessage : "Type message...";
      // refresh visible section content
      showSection(state.section, true);
    }

    function setLanguage(lang, toast){
      state.lang = lang;
      localStorage.setItem(LS.lang, lang);
      setDir();
      applyTranslations();
      renderStats();
      if(toast) showToast(t("languageChanged",{lang:lang.toUpperCase()}), "success");
    }

    function setCurrency(code, toast){
      state.currency = code;
      localStorage.setItem(LS.currency, code);
      renderStats();
      // re-render dynamic sections
      renderMarket(); renderWallet(); renderOrders(); renderMyListings(); renderLogistics(); renderTrace(); renderContracts();
      if(toast) showToast(t("currencyChanged",{currency:code}), "success");
    }

    // ---------- DASH STATS ----------
    function renderStats(){
      const deliveredUSD = DB.orders.filter(o=>o.status==="delivered").reduce((s,o)=> s + o.qtyKg*o.pricePerKgUSD, 0);
      const baseRevenueUSD = 24500;
      const revenueUSD = baseRevenueUSD + deliveredUSD;

      const rev = document.getElementById("revenue");
      const wal = document.getElementById("wallet");
      if(rev) rev.textContent = moneyFromUSD(revenueUSD);
      if(wal) wal.textContent = moneyFromUSD(DB.wallet.availableUSD);

      const changes = document.querySelectorAll(".stat-change");
      if(changes[1]) changes[1].innerHTML = `<i class="fa-solid fa-arrow-up"></i> +${moneyFromUSD(1200)}`;
    }

    // ---------- SECTION BUILD ----------
    function sectionHeader(icon, titleKey, rightHtml=""){
      return `
        <div class="card-header">
          <div class="card-title"><i class="fa-solid ${icon}"></i> <span data-i18n="${titleKey}">${escapeHtml(t(titleKey))}</span></div>
          <div style="display:flex; align-items:center; gap:10px;">
            ${rightHtml}
            <div class="badge">${escapeHtml(new Intl.DateTimeFormat(locale(),{dateStyle:"medium"}).format(new Date()))}</div>
          </div>
        </div>
      `;
    }

    function buildSections(){
      const main = document.getElementById("mainContent");
      if(!main) return;

      if(main.querySelector("[data-section='dashboard']")) return;

      const dash = document.createElement("div");
      dash.dataset.section = "dashboard";
      dash.id = "section-dashboard";
      while(main.firstChild) dash.appendChild(main.firstChild);
      main.appendChild(dash);

      const defs = [
        ["market", buildMarketSection()],
        ["wallet", buildWalletSection()],
        ["ai", buildAISection()],
        ["listings", buildMyListingsSection()],
        ["orders", buildOrdersSection()],
        ["logistics", buildLogisticsSection()],
        ["traceability", buildTraceSection()],
        ["contracts", buildContractsSection()]
      ];

      defs.forEach(([name, html])=>{
        const el = document.createElement("div");
        el.dataset.section = name;
        el.id = `section-${name}`;
        el.className = "card";
        el.style.display="none";
        el.innerHTML = html;
        main.appendChild(el);
      });
    }

    function showSection(name, silent){
      const main = document.getElementById("mainContent");
      if(!main) return;

      main.querySelectorAll("[data-section]").forEach(s=> s.style.display="none");
      const target = main.querySelector(`[data-section="${name}"]`);
      if(target) target.style.display="";

      state.section = name;
      localStorage.setItem(LS.section, name);

      document.querySelectorAll(".menu-link, .nav-btn").forEach(x=> x.classList.remove("active"));
      document.querySelectorAll(`[data-nav="${name}"]`).forEach(x=> x.classList.add("active"));

      if(!silent){
        renderMarket(); renderWallet(); renderOrders(); renderMyListings(); renderLogistics(); renderTrace(); renderContracts();
      }else{
        // still render the current section so translations/currency stay correct
        if(name==="market") renderMarket();
        if(name==="wallet") renderWallet();
        if(name==="orders") renderOrders();
        if(name==="listings") renderMyListings();
        if(name==="logistics") renderLogistics();
        if(name==="traceability") renderTrace();
        if(name==="contracts") renderContracts();
        if(name==="ai") bindAIButtons();
      }
    }

    // ---------- SECTION HTML ----------
    function buildMarketSection(){
      return `
        ${sectionHeader("fa-store","marketTitle",`
          <input id="marketSearch" placeholder="${escapeHtml(t("search"))}..." />
          <select id="marketCategory">
            <option value="">${escapeHtml(t("category"))}: ${escapeHtml(t("all"))}</option>
            <option value="Grain">Grain</option>
            <option value="Legume">Legume</option>
            <option value="Cash Crop">Cash Crop</option>
            <option value="Fruit">Fruit</option>
          </select>
          <select id="marketOrigin">
            <option value="">${escapeHtml(t("origin"))}: ${escapeHtml(t("all"))}</option>
            <option>Kenya</option><option>Rwanda</option><option>Ethiopia</option>
          </select>
        `)}
        <div class="content-pad">
          <div id="marketGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;"></div>
        </div>
      `;
    }

    function buildWalletSection(){
      return `
        ${sectionHeader("fa-wallet","walletTitle",`
          <button class="action-btn" id="btnDeposit"><i class="fa-solid fa-plus"></i> <span data-i18n="deposit">${escapeHtml(t("deposit"))}</span></button>
          <button class="action-btn" id="btnSend"><i class="fa-solid fa-paper-plane"></i> <span data-i18n="send">${escapeHtml(t("send"))}</span></button>
          <button class="action-btn" id="btnReceive"><i class="fa-solid fa-download"></i> <span data-i18n="receive">${escapeHtml(t("receive"))}</span></button>
        `)}
        <div class="content-pad">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;">
            <div class="stat">
              <div class="stat-title" data-i18n="availableBalance">${escapeHtml(t("availableBalance"))}</div>
              <div class="stat-value" id="walletAvail"></div>
            </div>
            <div class="stat">
              <div class="stat-title" data-i18n="escrow">${escapeHtml(t("escrow"))}</div>
              <div class="stat-value" id="walletEscrow"></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-receipt"></i> <span data-i18n="ledger">${escapeHtml(t("ledger"))}</span></div>
              <input id="ledgerSearch" placeholder="${escapeHtml(t("search"))}..." />
            </div>
            <div style="overflow:auto;">
              <table class="table" style="width:100%;">
                <thead>
                  <tr>
                    <th data-i18n="txType">${escapeHtml(t("txType"))}</th>
                    <th data-i18n="txRef">${escapeHtml(t("txRef"))}</th>
                    <th data-i18n="txCounterparty">${escapeHtml(t("txCounterparty"))}</th>
                    <th data-i18n="txDate">${escapeHtml(t("txDate"))}</th>
                    <th style="text-align:right;" data-i18n="txAmount">${escapeHtml(t("txAmount"))}</th>
                  </tr>
                </thead>
                <tbody id="ledgerBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function buildOrdersSection(){
      return `
        ${sectionHeader("fa-box","ordersTitle",`
          <select id="ordersStatus">
            <option value="">${escapeHtml(t("status"))}: ${escapeHtml(t("all"))}</option>
            <option value="pending">${escapeHtml(t("pending"))}</option>
            <option value="confirmed">${escapeHtml(t("confirmed"))}</option>
            <option value="inTransit">${escapeHtml(t("inTransit"))}</option>
            <option value="delivered">${escapeHtml(t("delivered"))}</option>
            <option value="disputed">${escapeHtml(t("disputed"))}</option>
            <option value="refunded">${escapeHtml(t("refunded"))}</option>
          </select>
          <input id="ordersSearch" placeholder="${escapeHtml(t("search"))}..." />
        `)}
        <div class="content-pad">
          <div style="overflow:auto;">
            <table class="table" style="width:100%;">
              <thead>
                <tr>
                  <th data-i18n="orderId">${escapeHtml(t("orderId"))}</th>
                  <th data-i18n="crop">${escapeHtml(t("crop"))}</th>
                  <th data-i18n="buyer">${escapeHtml(t("buyer"))}</th>
                  <th data-i18n="seller">${escapeHtml(t("seller"))}</th>
                  <th data-i18n="status">${escapeHtml(t("status"))}</th>
                  <th style="text-align:right;" data-i18n="total">${escapeHtml(t("total"))}</th>
                  <th data-i18n="created">${escapeHtml(t("created"))}</th>
                  <th data-i18n="actions">${escapeHtml(t("actions"))}</th>
                </tr>
              </thead>
              <tbody id="ordersBody"></tbody>
            </table>
          </div>
        </div>
      `;
    }

    function buildMyListingsSection(){
      return `
        ${sectionHeader("fa-warehouse","listingsTitle",`
          <button class="action-btn" id="btnCreateListing"><i class="fa-solid fa-plus"></i> <span data-i18n="createListing">${escapeHtml(t("createListing"))}</span></button>
        `)}
        <div class="content-pad">
          <div id="myListingsGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;"></div>
        </div>
      `;
    }

    function buildAISection(){
      return `
        ${sectionHeader("fa-robot","aiToolsTitle",`
          <button class="action-btn" id="btnScanCrop"><i class="fa-solid fa-camera"></i> <span data-i18n="scanCrop">${escapeHtml(t("scanCrop"))}</span></button>
          <button class="action-btn" id="btnPredict"><i class="fa-solid fa-brain"></i> <span data-i18n="predictPrices">${escapeHtml(t("predictPrices"))}</span></button>
          <button class="action-btn" id="btnSoil"><i class="fa-solid fa-flask"></i> <span data-i18n="soilTest">${escapeHtml(t("soilTest"))}</span></button>
          <button class="action-btn" id="btnWeather"><i class="fa-solid fa-cloud-sun"></i> <span data-i18n="weatherAI">${escapeHtml(t("weatherAI"))}</span></button>
        `)}
        <div class="content-pad">
          <div class="card">
            <div class="card-header"><div class="card-title"><i class="fa-solid fa-bolt"></i> AI Actions</div></div>
            <div class="content-pad" style="color:var(--text-light); line-height:1.7;">
              <div id="aiActionResult">Run an AI action above to generate investor-demo insights.</div>
            </div>
          </div>
        </div>
      `;
    }

    function buildLogisticsSection(){
      return `
        ${sectionHeader("fa-truck","logisticsTitle")}
        <div class="content-pad">
          <div style="overflow:auto;">
            <table class="table" style="width:100%;">
              <thead>
                <tr>
                  <th data-i18n="shipmentId">${escapeHtml(t("shipmentId"))}</th>
                  <th data-i18n="route">${escapeHtml(t("route"))}</th>
                  <th data-i18n="carrier">${escapeHtml(t("carrier"))}</th>
                  <th data-i18n="eta">${escapeHtml(t("eta"))}</th>
                  <th data-i18n="lastPing">${escapeHtml(t("lastPing"))}</th>
                  <th data-i18n="status">${escapeHtml(t("status"))}</th>
                </tr>
              </thead>
              <tbody id="logisticsBody"></tbody>
            </table>
          </div>
        </div>
      `;
    }

    function buildTraceSection(){
      return `
        ${sectionHeader("fa-link","traceTitle",`
          <input id="traceSearch" placeholder="${escapeHtml(t("batchId"))}..." />
        `)}
        <div class="content-pad">
          <div style="overflow:auto;">
            <table class="table" style="width:100%;">
              <thead>
                <tr>
                  <th data-i18n="batchId">${escapeHtml(t("batchId"))}</th>
                  <th data-i18n="event">${escapeHtml(t("event"))}</th>
                  <th data-i18n="actor">${escapeHtml(t("actor"))}</th>
                  <th data-i18n="location">${escapeHtml(t("location"))}</th>
                  <th data-i18n="txDate">${escapeHtml(t("txDate"))}</th>
                </tr>
              </thead>
              <tbody id="traceBody"></tbody>
            </table>
          </div>
        </div>
      `;
    }

    function buildContractsSection(){
      return `
        ${sectionHeader("fa-file-contract","contractsTitle")}
        <div class="content-pad">
          <div style="overflow:auto;">
            <table class="table" style="width:100%;">
              <thead>
                <tr>
                  <th data-i18n="contractId">${escapeHtml(t("contractId"))}</th>
                  <th data-i18n="terms">${escapeHtml(t("terms"))}</th>
                  <th data-i18n="status">${escapeHtml(t("status"))}</th>
                  <th data-i18n="actions">${escapeHtml(t("actions"))}</th>
                </tr>
              </thead>
              <tbody id="contractsBody"></tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ---------- RENDERERS ----------
    function renderMarket(){
      const grid = document.getElementById("marketGrid");
      if(!grid) return;

      const q = (document.getElementById("marketSearch")?.value || "").trim().toLowerCase();
      const cat = (document.getElementById("marketCategory")?.value || "");
      const org = (document.getElementById("marketOrigin")?.value || "");

      const items = DB.listings.filter(l=>l.published)
        .filter(l=> !cat || l.category===cat)
        .filter(l=> !org || l.origin===org)
        .filter(l=>{
          if(!q) return true;
          const hay = `${l.id} ${l.crop} ${l.category} ${l.origin} ${l.grade} ${l.ownerName}`.toLowerCase();
          return hay.includes(q);
        });

      grid.innerHTML = items.map(l=>{
        const totalMinUSD = l.minOrderKg * l.pricePerKgUSD;
        return `
          <div class="card" style="padding:12px;">
            <div style="display:flex; justify-content:space-between; gap:10px;">
              <div style="font-weight:900;">${escapeHtml(l.crop)} <span style="opacity:.7;">(${escapeHtml(l.grade)})</span></div>
              <div style="font-weight:900;">${escapeHtml(moneyFromUSD(l.pricePerKgUSD))}</div>
            </div>
            <div style="margin-top:6px; color:var(--text-light); line-height:1.6;">
              <div><strong>${escapeHtml(t("origin"))}:</strong> ${escapeHtml(l.origin)}</div>
              <div><strong>${escapeHtml(t("category"))}:</strong> ${escapeHtml(l.category)}</div>
              <div><strong>${escapeHtml(t("available"))}:</strong> ${Number(l.availableKg).toLocaleString(locale())} kg</div>
              <div><strong>${escapeHtml(t("minOrder"))}:</strong> ${Number(l.minOrderKg).toLocaleString(locale())} kg</div>
              <div><strong>${escapeHtml(t("total"))} (min):</strong> ${escapeHtml(moneyFromUSD(totalMinUSD))}</div>
              <div style="margin-top:6px; font-size:.85rem;"><i class="fa-solid fa-user"></i> ${escapeHtml(l.ownerName)}</div>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
              <button class="action-btn" data-action="market_view" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-eye"></i> ${escapeHtml(t("viewDetails"))}</button>
              <button class="action-btn" data-action="market_quote" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-file-signature"></i> ${escapeHtml(t("requestQuote"))}</button>
              <button class="action-btn" data-action="market_chat" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-comments"></i> ${escapeHtml(t("openChat"))}</button>
              <button class="action-btn" data-action="market_buy" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-cart-shopping"></i> ${escapeHtml(t("buyNow"))}</button>
            </div>
          </div>
        `;
      }).join("");

      const s = document.getElementById("marketSearch");
      const c = document.getElementById("marketCategory");
      const o = document.getElementById("marketOrigin");
      if(s && !s.__b){ s.__b=true; s.addEventListener("input", renderMarket); }
      if(c && !c.__b){ c.__b=true; c.addEventListener("change", renderMarket); }
      if(o && !o.__b){ o.__b=true; o.addEventListener("change", renderMarket); }
    }

    function renderWallet(){
      const a = document.getElementById("walletAvail");
      const e = document.getElementById("walletEscrow");
      if(a) a.textContent = moneyFromUSD(DB.wallet.availableUSD);
      if(e) e.textContent = moneyFromUSD(DB.wallet.escrowUSD);

      const q = (document.getElementById("ledgerSearch")?.value || "").trim().toLowerCase();
      const body = document.getElementById("ledgerBody");
      if(!body) return;

      const rows = DB.ledger.slice().sort((x,y)=> new Date(y.createdAt)-new Date(x.createdAt))
        .filter(tx=>{
          if(!q) return true;
          const hay = `${tx.type} ${tx.ref} ${tx.counterparty} ${tx.note||""}`.toLowerCase();
          return hay.includes(q);
        });

      body.innerHTML = rows.map(tx=>{
        const sign = tx.amountUSD>=0 ? "+" : "âˆ’";
        const abs = Math.abs(tx.amountUSD);
        return `
          <tr>
            <td>${escapeHtml(String(tx.type).replaceAll("_"," "))}</td>
            <td>${escapeHtml(tx.ref)}</td>
            <td>${escapeHtml(tx.counterparty)}</td>
            <td>${escapeHtml(fmtDate(tx.createdAt))}</td>
            <td style="text-align:right; font-weight:900;">${sign}${escapeHtml(moneyFromUSD(abs))}</td>
          </tr>
        `;
      }).join("");

      const s = document.getElementById("ledgerSearch");
      if(s && !s.__b){ s.__b=true; s.addEventListener("input", renderWallet); }
      bindWalletButtons();
    }

    function renderOrders(){
      const body = document.getElementById("ordersBody");
      if(!body) return;

      const status = (document.getElementById("ordersStatus")?.value || "");
      const q = (document.getElementById("ordersSearch")?.value || "").trim().toLowerCase();

      const rows = DB.orders.slice().sort((x,y)=> new Date(y.createdAt)-new Date(x.createdAt))
        .filter(o=> !status || o.status===status)
        .filter(o=>{
          if(!q) return true;
          const hay = `${o.id} ${o.crop} ${o.buyerName} ${o.sellerName} ${o.status}`.toLowerCase();
          return hay.includes(q);
        });

      body.innerHTML = rows.map(o=>{
        const totalUSD = o.qtyKg * o.pricePerKgUSD;
        return `
          <tr>
            <td style="font-weight:900;">${escapeHtml(o.id)}</td>
            <td>${escapeHtml(o.crop)} (${Number(o.qtyKg).toLocaleString(locale())} kg)</td>
            <td>${escapeHtml(o.buyerName)}</td>
            <td>${escapeHtml(o.sellerName)}</td>
            <td><span class="badge">${escapeHtml(o.status)}</span></td>
            <td style="text-align:right; font-weight:900;">${escapeHtml(moneyFromUSD(totalUSD))}</td>
            <td>${escapeHtml(fmtDate(o.createdAt))}</td>
            <td><button class="action-btn" data-action="order_view" data-id="${escapeHtml(o.id)}"><i class="fa-solid fa-eye"></i> ${escapeHtml(t("view"))}</button></td>
          </tr>
        `;
      }).join("");

      const ss = document.getElementById("ordersStatus");
      const qs = document.getElementById("ordersSearch");
      if(ss && !ss.__b){ ss.__b=true; ss.addEventListener("change", renderOrders); }
      if(qs && !qs.__b){ qs.__b=true; qs.addEventListener("input", renderOrders); }
    }

    function renderMyListings(){
      const grid = document.getElementById("myListingsGrid");
      if(!grid) return;
      const mine = DB.listings.filter(l=> l.ownerId===DB.me.id);
      grid.innerHTML = mine.map(l=>`
        <div class="card" style="padding:12px;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div style="font-weight:900;">${escapeHtml(l.crop)} <span style="opacity:.7;">(${escapeHtml(l.grade)})</span></div>
            <span class="badge">${l.published ? "LIVE" : "DRAFT"}</span>
          </div>
          <div style="margin-top:6px; color:var(--text-light); line-height:1.6;">
            <div><strong>ID:</strong> ${escapeHtml(l.id)}</div>
            <div><strong>${escapeHtml(t("available"))}:</strong> ${Number(l.availableKg).toLocaleString(locale())} kg</div>
            <div><strong>${escapeHtml(t("minOrder"))}:</strong> ${Number(l.minOrderKg).toLocaleString(locale())} kg</div>
            <div><strong>${escapeHtml(t("pricePerKg"))}:</strong> ${escapeHtml(moneyFromUSD(l.pricePerKgUSD))}</div>
          </div>
          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
            <button class="action-btn" data-action="listing_edit" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-pen"></i> ${escapeHtml(t("edit"))}</button>
            <button class="action-btn" data-action="listing_toggle" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-broadcast-tower"></i> ${escapeHtml(l.published ? t("unpublish") : t("publish"))}</button>
            <button class="action-btn" data-action="listing_delete" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-trash"></i> ${escapeHtml(t("delete"))}</button>
          </div>
        </div>
      `).join("");

      const btn = document.getElementById("btnCreateListing");
      if(btn && !btn.__b){ btn.__b=true; btn.addEventListener("click", ()=> openListingEditor(null)); }
    }

    function renderLogistics(){
      const body = document.getElementById("logisticsBody");
      if(!body) return;
      body.innerHTML = DB.logistics.map(s=>`
        <tr>
          <td style="font-weight:900;">${escapeHtml(s.shipmentId)}</td>
          <td>${escapeHtml(s.route)}</td>
          <td>${escapeHtml(s.carrier)}</td>
          <td>${escapeHtml(fmtDate(s.eta))}</td>
          <td>${escapeHtml(fmtDate(s.lastPing))}</td>
          <td><span class="badge">${escapeHtml(s.status)}</span></td>
        </tr>
      `).join("");
    }

    function renderTrace(){
      const body = document.getElementById("traceBody");
      if(!body) return;
      const q = (document.getElementById("traceSearch")?.value || "").trim().toLowerCase();
      const rows = DB.traceability.slice().sort((x,y)=> new Date(y.createdAt)-new Date(x.createdAt))
        .filter(r=> !q || String(r.batchId).toLowerCase().includes(q));
      body.innerHTML = rows.map(r=>`
        <tr>
          <td style="font-weight:900;">${escapeHtml(r.batchId)}</td>
          <td>${escapeHtml(r.event)}</td>
          <td>${escapeHtml(r.actor)}</td>
          <td>${escapeHtml(r.location)}</td>
          <td>${escapeHtml(fmtDate(r.createdAt))}</td>
        </tr>
      `).join("");
      const s = document.getElementById("traceSearch");
      if(s && !s.__b){ s.__b=true; s.addEventListener("input", renderTrace); }
    }

    function renderContracts(){
      const body = document.getElementById("contractsBody");
      if(!body) return;
      body.innerHTML = DB.contracts.map(c=>`
        <tr>
          <td style="font-weight:900;">${escapeHtml(c.contractId)}</td>
          <td>${escapeHtml(c.terms)}</td>
          <td><span class="badge">${escapeHtml(c.status)}${c.claimed ? " â€¢ " + escapeHtml(t("claimed")) : ""}</span></td>
          <td>
            <button class="action-btn" data-action="contract_claim" data-id="${escapeHtml(c.contractId)}" ${c.claimed ? "disabled" : ""}>
              <i class="fa-solid fa-hand-holding-dollar"></i> ${escapeHtml(t("claim"))}
            </button>
          </td>
        </tr>
      `).join("");
    }

    // ---------- ACTION HELPERS ----------
    function findListing(id){ return DB.listings.find(l=>l.id===id); }
    function findOrder(id){ return DB.orders.find(o=>o.id===id); }

    function requestQuote(listingId){
      const l = findListing(listingId);
      if(!l) return;
      DB.ledger.push({ id:nextId("TX"), type:"quote_request", ref:`Q-${listingId}-${Math.floor(Math.random()*900+100)}`, counterparty:l.ownerName, amountUSD:0, createdAt:nowISO(), note:`Quote requested for ${l.crop} (${listingId})` });
      saveData();
      showToast(t("quoteSent"), "success");
      renderWallet();
    }

    function openChatForListing(listingId){
      const l = findListing(listingId);
      closeModal();
      const input = document.getElementById("chatInput");
      const messages = document.getElementById("chatMessages");
      if(messages){
        messages.innerHTML += `
          <div class="message">
            <div class="msg-avatar" style="background: linear-gradient(135deg, var(--purple), #e91e63); color: white;">AI</div>
            <div class="msg-bubble ai">
              <div style="font-size: 0.7rem; font-weight: bold; margin-bottom: 0.25rem;">AgriAI</div>
              Negotiation opened for <strong>${escapeHtml(l.crop)}</strong> (${escapeHtml(l.id)}). Ask for docs, delivery terms, or bulk pricing.
            </div>
          </div>
        `;
        messages.scrollTop = messages.scrollHeight;
      }
      if(input){
        input.value = `Requesting quote and delivery terms for ${l.crop} (${l.id}).`;
        input.focus();
      }
    }

    function openListingDetails(listingId){
      const l = findListing(listingId);
      if(!l) return;
      const totalMinUSD = l.minOrderKg * l.pricePerKgUSD;
      openModal(`${l.crop} â€¢ ${l.grade} â€¢ ${l.origin}`, `
        <div class="card" style="padding:12px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div>
              <div style="font-weight:900; font-size:1.1rem;">${escapeHtml(l.crop)} (${escapeHtml(l.grade)})</div>
              <div style="color:var(--text-light); margin-top:6px; line-height:1.7;">
                <div><strong>${escapeHtml(t("category"))}:</strong> ${escapeHtml(l.category)}</div>
                <div><strong>${escapeHtml(t("origin"))}:</strong> ${escapeHtml(l.origin)}</div>
                <div><strong>${escapeHtml(t("available"))}:</strong> ${Number(l.availableKg).toLocaleString(locale())} kg</div>
                <div><strong>${escapeHtml(t("minOrder"))}:</strong> ${Number(l.minOrderKg).toLocaleString(locale())} kg</div>
                <div><strong>${escapeHtml(t("pricePerKg"))}:</strong> ${escapeHtml(moneyFromUSD(l.pricePerKgUSD))}</div>
                <div><strong>${escapeHtml(t("total"))} (min):</strong> ${escapeHtml(moneyFromUSD(totalMinUSD))}</div>
                <div><strong>Packaging:</strong> ${escapeHtml(l.packaging)}</div>
                <div><strong>Moisture:</strong> ${escapeHtml(l.moisture)}</div>
                <div><strong>Harvest:</strong> ${escapeHtml(fmtDate(l.harvestDate))}</div>
              </div>
            </div>
            <div>
              <div style="font-weight:900; margin-bottom:8px;">Trade Actions</div>
              <div style="color:var(--text-light); font-size:.9rem; margin-bottom:6px;">${escapeHtml(t("amount"))} (kg)</div>
              <input id="buyQtyKg" type="number" min="${l.minOrderKg}" value="${l.minOrderKg}" />
              <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
                <button class="action-btn" data-action="modal_quote" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-file-signature"></i> ${escapeHtml(t("requestQuote"))}</button>
                <button class="action-btn" data-action="modal_chat" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-comments"></i> ${escapeHtml(t("openChat"))}</button>
                <button class="action-btn" data-action="modal_buy" data-id="${escapeHtml(l.id)}"><i class="fa-solid fa-cart-shopping"></i> ${escapeHtml(t("buyNow"))}</button>
              </div>
              <div style="margin-top:10px; color:var(--text-light); line-height:1.7;">
                Buying creates an order and places funds in escrow (demo).
              </div>
            </div>
          </div>
        </div>
      `);
    }

    function createOrderFromListing(listingId, qtyKg){
      const l = findListing(listingId);
      if(!l) return;
      const qty = Math.max(Number(qtyKg || l.minOrderKg), l.minOrderKg);
      if(qty > l.availableKg){ showToast("Not enough inventory for that quantity.", "error"); return; }

      const totalUSD = qty * l.pricePerKgUSD;
      if(DB.wallet.availableUSD < totalUSD){
        showToast("Insufficient wallet balance for this demo buy. Deposit first.", "error");
        return;
      }

      l.availableKg -= qty;

      const orderId = nextId("O");
      DB.orders.push({ id:orderId, listingId:l.id, crop:l.crop, qtyKg:qty, pricePerKgUSD:l.pricePerKgUSD,
        buyerName:"Investor Demo Buyer", sellerName:l.ownerName, status:"pending", createdAt:nowISO(), notes:`Auto-created from Market buy (${qty} kg)` });

      DB.wallet.availableUSD -= totalUSD;
      DB.wallet.escrowUSD += totalUSD;
      DB.ledger.push({ id:nextId("TX"), type:"escrow_hold", ref:`ESC-${orderId}`, counterparty:"Escrow", amountUSD:-totalUSD, createdAt:nowISO(), note:`Escrow hold for ${orderId}` });

      saveData();
      renderStats(); renderMarket(); renderOrders(); renderWallet();
      closeModal();
      showToast(t("addToOrders"), "success");
    }

    function openOrderDetails(orderId){
      const o = findOrder(orderId);
      if(!o) return;
      const totalUSD = o.qtyKg * o.pricePerKgUSD;

      openModal(`${t("orderId")}: ${o.id}`, `
        <div class="card" style="padding:12px;">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
            <div><div style="color:var(--text-light);">${escapeHtml(t("crop"))}</div><div style="font-weight:900;">${escapeHtml(o.crop)} â€¢ ${Number(o.qtyKg).toLocaleString(locale())} kg</div></div>
            <div><div style="color:var(--text-light);">${escapeHtml(t("buyer"))}</div><div style="font-weight:900;">${escapeHtml(o.buyerName)}</div></div>
            <div><div style="color:var(--text-light);">${escapeHtml(t("seller"))}</div><div style="font-weight:900;">${escapeHtml(o.sellerName)}</div></div>
            <div><div style="color:var(--text-light);">${escapeHtml(t("total"))}</div><div style="font-weight:900;">${escapeHtml(moneyFromUSD(totalUSD))}</div></div>
            <div><div style="color:var(--text-light);">${escapeHtml(t("status"))}</div><div class="badge">${escapeHtml(o.status)}</div></div>
            <div><div style="color:var(--text-light);">${escapeHtml(t("created"))}</div><div style="font-weight:900;">${escapeHtml(fmtDate(o.createdAt))}</div></div>
          </div>
          <div style="margin-top:10px; color:var(--text-light); line-height:1.7;"><strong>Notes:</strong> ${escapeHtml(o.notes||"")}</div>

          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;">
            <button class="action-btn" data-action="order_set" data-id="${escapeHtml(o.id)}" data-status="confirmed"><i class="fa-solid fa-check"></i> ${escapeHtml(t("markConfirmed"))}</button>
            <button class="action-btn" data-action="order_set" data-id="${escapeHtml(o.id)}" data-status="inTransit"><i class="fa-solid fa-truck"></i> ${escapeHtml(t("markInTransit"))}</button>
            <button class="action-btn" data-action="order_set" data-id="${escapeHtml(o.id)}" data-status="delivered"><i class="fa-solid fa-box-open"></i> ${escapeHtml(t("markDelivered"))}</button>
            <button class="action-btn" data-action="order_set" data-id="${escapeHtml(o.id)}" data-status="disputed"><i class="fa-solid fa-triangle-exclamation"></i> ${escapeHtml(t("openDispute"))}</button>
            <button class="action-btn" data-action="order_refund" data-id="${escapeHtml(o.id)}"><i class="fa-solid fa-rotate-left"></i> ${escapeHtml(t("refund"))}</button>
          </div>
        </div>
      `);
    }

    function setOrderStatus(orderId, status){
      const o = findOrder(orderId);
      if(!o) return;
      const totalUSD = o.qtyKg * o.pricePerKgUSD;

      if(status==="delivered" && o.status!=="delivered"){
        DB.wallet.escrowUSD = Math.max(0, DB.wallet.escrowUSD - totalUSD);
        DB.ledger.push({ id:nextId("TX"), type:"escrow_release", ref:`REL-${o.id}`, counterparty:"Escrow", amountUSD:0, createdAt:nowISO(), note:`Escrow released for ${o.id}` });
      }

      o.status = status;
      saveData();
      showToast(t("orderUpdated"), "success");
      renderOrders(); renderWallet(); renderStats();
      closeModal();
    }

    function refundOrder(orderId){
      const o = findOrder(orderId);
      if(!o) return;
      const totalUSD = o.qtyKg * o.pricePerKgUSD;

      DB.wallet.escrowUSD = Math.max(0, DB.wallet.escrowUSD - totalUSD);
      DB.wallet.availableUSD += totalUSD;
      DB.ledger.push({ id:nextId("TX"), type:"refund", ref:`RF-${o.id}`, counterparty:"Escrow", amountUSD:totalUSD, createdAt:nowISO(), note:`Refund processed for ${o.id}` });
      o.status = "refunded";

      saveData();
      showToast(t("orderUpdated"), "success");
      renderOrders(); renderWallet(); renderStats();
      closeModal();
    }

    // ---------- LISTINGS CRUD ----------
    function openListingEditor(listingId){
      const isEdit = !!listingId;
      const l = isEdit ? findListing(listingId) : null;

      const draft = l || {
        id: `L-${(DB.me.country||"KE").slice(0,2).toUpperCase()}-${Math.random().toString(16).slice(2,6).toUpperCase()}-${Math.floor(Math.random()*900+100)}`,
        ownerId: DB.me.id, ownerName: DB.me.name, crop:"Maize", category:"Grain", origin: DB.me.country || "Kenya", grade:"A",
        availableKg:1000, minOrderKg:100, pricePerKgUSD:0.5, moisture:"12%", packaging:"50kg bags", harvestDate:nowISO(), published:false
      };

      openModal(isEdit ? `${t("edit")}: ${draft.id}` : t("createListing"), `
        <div class="card" style="padding:12px;">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("crop"))}</div><input id="f_crop" value="${escapeHtml(draft.crop)}" /></div>
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("category"))}</div>
              <select id="f_category">
                ${["Grain","Legume","Cash Crop","Fruit","Vegetable"].map(x=>`<option ${x===draft.category?"selected":""}>${x}</option>`).join("")}
              </select>
            </div>
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("origin"))}</div><input id="f_origin" value="${escapeHtml(draft.origin)}" /></div>
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("grade"))}</div><input id="f_grade" value="${escapeHtml(draft.grade)}" /></div>
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("available"))} (kg)</div><input id="f_available" type="number" min="0" value="${Number(draft.availableKg)}" /></div>
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("minOrder"))} (kg)</div><input id="f_min" type="number" min="1" value="${Number(draft.minOrderKg)}" /></div>
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("pricePerKg"))} (USD)</div><input id="f_price" type="number" step="0.01" min="0" value="${Number(draft.pricePerKgUSD)}" /></div>
            <div><div style="font-size:.85rem; color:var(--text-light);">Packaging</div><input id="f_pack" value="${escapeHtml(draft.packaging)}" /></div>
            <div><div style="font-size:.85rem; color:var(--text-light);">Moisture</div><input id="f_moist" value="${escapeHtml(draft.moisture)}" /></div>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
            <button class="action-btn" data-action="listing_cancel"><i class="fa-solid fa-xmark"></i> ${escapeHtml(t("cancel"))}</button>
            <button class="action-btn" data-action="listing_save" data-id="${escapeHtml(draft.id)}"><i class="fa-solid fa-floppy-disk"></i> ${escapeHtml(t("save"))}</button>
          </div>
        </div>
      `);
      modalBody.dataset.isEdit = isEdit ? "1" : "0";
    }

    function saveListingFromModal(listingId){
      const crop = document.getElementById("f_crop")?.value.trim();
      const category = document.getElementById("f_category")?.value.trim();
      const origin = document.getElementById("f_origin")?.value.trim();
      const grade = document.getElementById("f_grade")?.value.trim();
      const availableKg = Number(document.getElementById("f_available")?.value);
      const minOrderKg = Number(document.getElementById("f_min")?.value);
      const pricePerKgUSD = Number(document.getElementById("f_price")?.value);
      const packaging = document.getElementById("f_pack")?.value.trim();
      const moisture = document.getElementById("f_moist")?.value.trim();

      if(!crop || !origin || !grade || !category || !isFinite(availableKg) || !isFinite(minOrderKg) || !isFinite(pricePerKgUSD)){
        showToast("Please complete all fields.", "error"); return;
      }
      if(availableKg<=0 || minOrderKg<=0 || pricePerKgUSD<=0){
        showToast("Values must be greater than zero.", "error"); return;
      }

      const existing = findListing(listingId);
      if(existing){
        Object.assign(existing, { crop, category, origin, grade, availableKg, minOrderKg, pricePerKgUSD, packaging, moisture });
      }else{
        DB.listings.push({ id:listingId, ownerId:DB.me.id, ownerName:DB.me.name, harvestDate:nowISO(), published:false, crop, category, origin, grade, availableKg, minOrderKg, pricePerKgUSD, packaging, moisture });
      }
      saveData();
      closeModal();
      showToast(t("listingSaved"), "success");
      renderMyListings(); renderMarket();
    }

    function togglePublish(listingId){
      const l = findListing(listingId);
      if(!l) return;
      l.published = !l.published;
      saveData();
      renderMyListings(); renderMarket();
    }

    function deleteListing(listingId){
      const idx = DB.listings.findIndex(l=>l.id===listingId);
      if(idx<0) return;
      DB.listings.splice(idx,1);
      saveData();
      showToast(t("listingDeleted"), "success");
      renderMyListings(); renderMarket();
    }

    // ---------- WALLET FLOWS ----------
    function openWalletFlow(type){
      const title = type==="deposit" ? t("deposit") : type==="send" ? t("send") : t("receive");
      openModal(title, `
        <div class="card" style="padding:12px;">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("phoneNumber"))}</div><input id="wf_phone" value="+254700000000" /></div>
            <div><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("amount"))} (${escapeHtml(state.currency)})</div><input id="wf_amount" type="number" min="1" step="0.01" value="100" /></div>
            <div style="grid-column:1/-1;"><div style="font-size:.85rem; color:var(--text-light);">${escapeHtml(t("note"))}</div><input id="wf_note" value="Investor demo transaction" /></div>
          </div>
          <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button class="action-btn" data-action="wallet_confirm" data-type="${escapeHtml(type)}"><i class="fa-solid fa-check"></i> ${escapeHtml(t("confirm"))}</button>
          </div>
        </div>
      `);
    }

    function walletConfirm(type){
      const phone = document.getElementById("wf_phone")?.value.trim() || "N/A";
      const amtCur = Number(document.getElementById("wf_amount")?.value);
      const note = document.getElementById("wf_note")?.value.trim() || "";
      if(!isFinite(amtCur) || amtCur<=0){ showToast("Invalid amount.", "error"); return; }
      const amtUSD = toUSD(amtCur);

      if(type==="deposit"){
        DB.wallet.availableUSD += amtUSD;
        DB.ledger.push({ id:nextId("TX"), type:"deposit", ref:`MM-${Math.floor(Math.random()*900000+100000)}`, counterparty:phone, amountUSD:amtUSD, createdAt:nowISO(), note });
        showToast(t("depositSuccess"), "success");
      }
      if(type==="send"){
        if(DB.wallet.availableUSD < amtUSD){ showToast("Insufficient balance.", "error"); return; }
        DB.wallet.availableUSD -= amtUSD;
        DB.ledger.push({ id:nextId("TX"), type:"send", ref:`TR-${Math.floor(Math.random()*900000+100000)}`, counterparty:phone, amountUSD:-amtUSD, createdAt:nowISO(), note });
        showToast(t("sendSuccess"), "success");
      }
      if(type==="receive"){
        DB.wallet.availableUSD += amtUSD;
        DB.ledger.push({ id:nextId("TX"), type:"receive", ref:`RC-${Math.floor(Math.random()*900000+100000)}`, counterparty:phone, amountUSD:amtUSD, createdAt:nowISO(), note });
        showToast(t("receiveSuccess"), "success");
      }

      saveData();
      closeModal();
      renderWallet(); renderStats();
    }

    function bindWalletButtons(){
      const d = document.getElementById("btnDeposit");
      const s = document.getElementById("btnSend");
      const r = document.getElementById("btnReceive");
      if(d && !d.__b){ d.__b=true; d.addEventListener("click", ()=> openWalletFlow("deposit")); }
      if(s && !s.__b){ s.__b=true; s.addEventListener("click", ()=> openWalletFlow("send")); }
      if(r && !r.__b){ r.__b=true; r.addEventListener("click", ()=> openWalletFlow("receive")); }
    }

    // ---------- CONTRACTS ----------
    function claimContract(contractId){
      const c = DB.contracts.find(x=>x.contractId===contractId);
      if(!c || c.claimed) return;
      c.claimed = true;
      DB.ledger.push({ id:nextId("TX"), type:"contract_claim", ref:`CL-${contractId}`, counterparty:"Smart Contract", amountUSD:0, createdAt:nowISO(), note:`Claim submitted for ${contractId}` });
      saveData();
      renderContracts(); renderWallet();
      showToast("Claim submitted", "success");
    }

    // ---------- AI ----------
    function runAI(kind){
      const out = document.getElementById("aiActionResult");
      if(!out) return;
      const responses = {
        scan:[
          "Scan result: Healthy. No fungal or pest indicators detected. Recommended: maintain irrigation schedule; monitor leaf edges for discoloration.",
          "Scan result: Mild nutrient stress detected. Recommended: soil test + nitrogen balance adjustment."
        ],
        price:[
          "Price forecast (7-day): Maize stable with +3% upside due to regional demand. Suggested offer: bundle 1000kg+ with 2% discount to close.",
          "Price forecast (7-day): Beans trending +5% with tighter supply. Suggested: hold inventory 48h if logistics capacity is available."
        ],
        soil:[
          "Soil analysis: pH slightly acidic. Recommended: lime application + organic compost, retest in 21 days.",
          "Soil analysis: low potassium. Recommended: K-rich fertilizer plan + improve drainage."
        ],
        weather:[
          "Weather AI: Light rainfall expected in next 48h along key route. Recommended: waterproof packaging + confirm carrier contingency plan.",
          "Weather AI: High heat risk forecast. Recommended: prioritize early-morning loading and improved ventilation for fresh produce."
        ]
      };
      const arr = responses[kind] || ["AI ready."];
      out.textContent = arr[Math.floor(Math.random()*arr.length)];
    }

    function bindAIButtons(){
      const a = (id, fn)=>{
        const el = document.getElementById(id);
        if(el && !el.__b){ el.__b=true; el.addEventListener("click", fn); }
      };
      a("btnScanCrop", ()=>runAI("scan"));
      a("btnPredict", ()=>runAI("price"));
      a("btnSoil", ()=>runAI("soil"));
      a("btnWeather", ()=>runAI("weather"));
    }

    // ---------- GLOBAL ACTION ROUTER ----------
    document.body.addEventListener("click", (e)=>{
      const nav = e.target.closest("[data-nav]");
      if(nav){
        e.preventDefault();
        showSection(nav.dataset.nav);
        return;
      }
      const btn = e.target.closest("[data-action]");
      if(!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;

      if(action==="market_view") return openListingDetails(id);
      if(action==="market_quote") return requestQuote(id);
      if(action==="market_chat") return openChatForListing(id);
      if(action==="market_buy")  return createOrderFromListing(id);

      if(action==="modal_quote") return requestQuote(id);
      if(action==="modal_chat") return openChatForListing(id);
      if(action==="modal_buy"){
        const qty = Number(document.getElementById("buyQtyKg")?.value || 0);
        return createOrderFromListing(id, qty);
      }

      if(action==="order_view") return openOrderDetails(id);
      if(action==="order_set") return setOrderStatus(btn.dataset.id, btn.dataset.status);
      if(action==="order_refund") return refundOrder(id);

      if(action==="listing_edit") return openListingEditor(id);
      if(action==="listing_toggle") return togglePublish(id);
      if(action==="listing_delete") return deleteListing(id);
      if(action==="listing_cancel") return closeModal();
      if(action==="listing_save") return saveListingFromModal(id);

      if(action==="wallet_confirm") return walletConfirm(btn.dataset.type);

      if(action==="contract_claim") return claimContract(id);
    });

    // ---------- CHAT ----------
    window.switchChat = function(tab, el){
      document.querySelectorAll(".chat-tab").forEach(x=> x.classList.remove("active"));
      if(el) el.classList.add("active");
    };

    window.sendChat = function(){
      const input = document.getElementById("chatInput");
      const messages = document.getElementById("chatMessages");
      if(!input || !messages || !input.value.trim()) return;

      messages.innerHTML += `
        <div class="message own">
          <div class="msg-avatar" style="background: var(--accent); color:#04110a;">ME</div>
          <div class="msg-bubble own">${escapeHtml(input.value)}</div>
        </div>
      `;
      input.value = "";
      messages.scrollTop = messages.scrollHeight;

      setTimeout(()=>{
        messages.innerHTML += `
          <div class="message">
            <div class="msg-avatar" style="background: linear-gradient(135deg, var(--purple), #e91e63); color: white;">AI</div>
            <div class="msg-bubble ai">
              <div style="font-size: 0.7rem; font-weight: bold; margin-bottom: 0.25rem;">AgriAI</div>
              ${escapeHtml(t("aiReply"))}
            </div>
          </div>
        `;
        messages.scrollTop = messages.scrollHeight;
      }, 650);
    };

    window.handleChat = function(e){ if(e.key==="Enter") window.sendChat(); };

    // ---------- INIT ----------
    function init(){
      injectLanguageSelector();
      setDir();

      buildSections();

      // currency wire
      const currency = document.getElementById("currency");
      currency.value = state.currency;
      currency.addEventListener("change", ()=> setCurrency(currency.value, true));

      // language restore
      const langSel = document.getElementById("langSelect");
      if(langSel) langSel.value = state.lang;

      applyTranslations();
      renderStats();

      // show last section
      showSection(state.section, true);

      // render all once
      renderMarket(); renderWallet(); renderOrders(); renderMyListings(); renderLogistics(); renderTrace(); renderContracts(); bindAIButtons();
    }

    // expose for console testing
    window.showSection = (name)=> showSection(name);
    window.setLanguage = (lang, toast)=> setLanguage(lang, toast);
    window.setCurrency = (cur, toast)=> setCurrency(cur, toast);

    // safety: show on-screen error if something breaks (prevents â€œblank pageâ€ mystery)
    window.addEventListener("error", (e)=>{
      const msg = (e?.error?.stack || e.message || "Unknown error");
      document.body.innerHTML = `<div style="padding:20px;font-family:Arial;color:#fff;background:#111">
        <h2>AgriTrade Error</h2><pre style="white-space:pre-wrap">${escapeHtml(msg)}</pre>
      </div>`;
    }, { once:true });

    init();
  })();
  </script>
</body>
</html>
