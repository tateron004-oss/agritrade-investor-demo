<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgriTrade Africa ‚Äî Investor Demo</title>

  <!-- Icons -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <!-- Map (Leaflet) - GitHub Pages safe -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{
      --bg:#0f172a;
      --bg2:#111c33;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --text:#eaf0ff;
      --text-light:rgba(234,240,255,.78);
      --accent:#22c55e;
      --accent2:#60a5fa;
      --purple:#8b5cf6;
      --border:rgba(255,255,255,.12);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(34,197,94,.20), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(900px 500px at 60% 90%, rgba(139,92,246,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    a{color:inherit; text-decoration:none}

    .navbar{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(12,18,34,.70);
      backdrop-filter: blur(12px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px;}
    .brand .logo{
      width:34px; height:34px; border-radius:10px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .nav-center{display:flex; gap:10px; align-items:center;}
    .nav-btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      display:flex; gap:8px; align-items:center;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
    }
    .nav-btn:hover{background: rgba(255,255,255,.10)}
    .nav-btn:active{transform: translateY(1px)}
    .nav-btn.active{outline:2px solid rgba(34,197,94,.22); border-color: rgba(34,197,94,.35)}
    .nav-right{display:flex; gap:10px; align-items:center;}

    /* Fix ‚Äúgreyed out‚Äù selects */
    select, input{
      border:1px solid var(--border);
      background: rgba(255,255,255,.10);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      outline:none;
      appearance:none;
      -webkit-appearance:none;
    }
    select:hover{background: rgba(255,255,255,.14)}
    option{background:#0f172a; color:var(--text);}

    .layout{
      display:grid;
      grid-template-columns: 260px 1fr 340px;
      gap:14px;
      padding:14px;
      max-width: 1500px;
      margin: 0 auto;
    }
    .panel{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .sidebar-left{padding:12px}
    .menu-title{font-size:.85rem; color:var(--text-light); margin:10px 8px 8px;}
    .menu-link{
      display:flex; align-items:center; justify-content:flex-start;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease;
    }
    .menu-link:hover{background: rgba(255,255,255,.08)}
    .menu-link.active{background: rgba(34,197,94,.14); outline:1px solid rgba(34,197,94,.25)}
    .menu-icon{
      width:34px; height:34px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.08);
      border:1px solid var(--border);
    }

    .main{padding:0}
    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .card-title{font-weight:900; display:flex; align-items:center; gap:10px}
    .content-pad{padding:12px 14px}

    .grid4{display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px;}
    @media(max-width:1180px){
      .layout{grid-template-columns: 240px 1fr;}
      .sidebar-right{display:none}
      .grid4{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    @media(max-width:760px){
      .layout{grid-template-columns: 1fr;}
      .sidebar-left{display:none}
      .grid4{grid-template-columns: 1fr;}
    }

    .stat{
      padding:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.07);
      border-radius: 14px;
    }
    .stat-title{font-size:.85rem; color:var(--text-light)}
    .stat-value{font-size:1.6rem; font-weight:900; margin-top:6px}
    .stat-change{font-size:.85rem; margin-top:6px; color: #a7f3d0}

    .action-btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.08);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
      transition: background .15s ease, transform .08s ease;
    }
    .action-btn:hover{background: rgba(255,255,255,.12)}
    .action-btn:active{transform: translateY(1px)}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.08);
      font-size:.78rem;
      color: var(--text-light);
    }

    .toast-container{
      position:fixed;
      right:20px;
      bottom:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
    }
    .toast{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(10,15,28,.92);
      box-shadow: var(--shadow);
      max-width: 440px;
    }
    .toast.success i{color:#22c55e}
    .toast.error i{color:#ef4444}
    .toast.info i{color:#60a5fa}

    /* Chat - fixes partial cut off */
    .chat-wrap{padding:12px}
    .chat-box{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height: 520px;
    }
    .chat-tabs{display:flex; gap:8px; flex-wrap:wrap}
    .chat-tab{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      cursor:pointer;
      font-size:.82rem;
      color:var(--text-light);
      user-select:none;
      background: rgba(255,255,255,.06);
    }
    .chat-tab.active{color:var(--text); outline:2px solid rgba(34,197,94,.18)}
    .chat-messages{padding:10px; overflow:auto; flex:1}
    .message{display:flex; gap:10px; margin:10px 0}
    .message.own{justify-content:flex-end}
    .msg-avatar{
      width:34px; height:34px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background: rgba(255,255,255,.08);
      font-weight:900; font-size:.78rem;
    }
    .msg-bubble{
      max-width: 75%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.07);
      padding:10px 12px;
      border-radius: 14px;
      line-height:1.55;
    }
    .msg-bubble.own{background: rgba(34,197,94,.14)}
    .chat-input{
      display:flex; gap:8px;
      padding:10px;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .chat-input input{flex:1}

    /* Quick Pay tiles */
    .tile-grid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;}
    .pay-tile{
      border:1px solid var(--border);
      background: rgba(255,255,255,.07);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
    }
    .pay-tile:hover{background: rgba(255,255,255,.10)}
    .pay-logo{
      width:36px; height:36px; border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
    }

    .upload-box{
      border:1px dashed rgba(255,255,255,.25);
      background: rgba(255,255,255,.06);
      border-radius:14px;
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }

    #map{height: 280px; border-radius: 14px; border:1px solid var(--border); overflow:hidden;}
    #map2{height: 320px; border-radius: 14px; border:1px solid var(--border); overflow:hidden;}

    /* Modal */
    #agriModal{
      position:fixed; inset:0; display:none;
      background: rgba(0,0,0,.55);
      align-items:center; justify-content:center;
      z-index: 99999;
      padding: 20px;
    }
    #agriModalCard{
      width: min(980px, 96vw);
      max-height: 88vh;
      overflow:auto;
      background: rgba(12,18,34,.95);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      padding: 16px 16px 12px 16px;
    }

    /* RTL tweaks */
    [dir="rtl"] .navbar { flex-direction: row-reverse; }
    [dir="rtl"] .nav-center { flex-direction: row-reverse; }
    [dir="rtl"] .nav-right { flex-direction: row-reverse; }
    [dir="rtl"] .menu-link{justify-content:flex-end}
    [dir="rtl"] .toast-container{right:auto; left:20px}
    [dir="rtl"] .message{ text-align:right }
    [dir="rtl"] .message.own{ flex-direction: row }
    [dir="rtl"] #agriModalCard input, [dir="rtl"] #agriModalCard select { direction:ltr; }
  </style>
</head>

<body>
  <div class="navbar">
    <div class="brand">
      <div class="logo"></div>
      <div id="appName">AgriTrade Africa</div>
    </div>

    <div class="nav-center">
      <div class="nav-btn active" data-nav="dashboard"><i class="fa-solid fa-chart-line"></i> <span data-i18n="navDashboard">Dashboard</span></div>
      <div class="nav-btn" data-nav="market"><i class="fa-solid fa-store"></i> <span data-i18n="navMarket">Market</span></div>
      <div class="nav-btn" data-nav="wallet"><i class="fa-solid fa-wallet"></i> <span data-i18n="navWallet">Wallet</span></div>
      <div class="nav-btn" data-nav="ai"><i class="fa-solid fa-robot"></i> <span data-i18n="navAITools">AI Tools</span></div>
    </div>

    <div class="nav-right">
      <!-- Language selector injected by script -->
      <select id="currency" title="Currency">
        <option value="USD">USD</option>
        <option value="KES">KES</option>
        <option value="ETB">ETB</option>
        <option value="RWF">RWF</option>
      </select>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar-left panel">
      <div class="menu-title">NAV</div>

      <div class="menu-link active" data-nav="dashboard">
        <div class="menu-icon"><i class="fa-solid fa-chart-line"></i></div>
        <div data-i18n="sidebarDashboard">Dashboard</div>
      </div>

      <div class="menu-link" data-nav="market">
        <div class="menu-icon"><i class="fa-solid fa-store"></i></div>
        <div data-i18n="navMarket">Market</div>
      </div>

      <div class="menu-link" data-nav="wallet">
        <div class="menu-icon"><i class="fa-solid fa-wallet"></i></div>
        <div data-i18n="navWallet">Wallet</div>
      </div>

      <div class="menu-title">AI & AUTOMATION</div>

      <div class="menu-link" data-nav="ai">
        <div class="menu-icon"><i class="fa-solid fa-robot"></i></div>
        <div data-i18n="navAITools">AI Tools</div>
      </div>

      <div class="menu-link" data-nav="disease">
        <div class="menu-icon"><i class="fa-solid fa-camera"></i></div>
        <div data-i18n="diseaseScanner">Disease Scanner</div>
      </div>

      <div class="menu-link" data-nav="priceai">
        <div class="menu-icon"><i class="fa-solid fa-brain"></i></div>
        <div data-i18n="priceAI">Price AI</div>
      </div>

      <div class="menu-link" data-nav="soil">
        <div class="menu-icon"><i class="fa-solid fa-flask"></i></div>
        <div data-i18n="soilAnalysis">Soil Analysis</div>
      </div>

      <div class="menu-title">LOGISTICS & TRUST</div>

      <div class="menu-link" data-nav="logistics">
        <div class="menu-icon"><i class="fa-solid fa-truck"></i></div>
        <div data-i18n="logistics">Logistics</div>
      </div>

      <div class="menu-link" data-nav="traceability">
        <div class="menu-icon"><i class="fa-solid fa-link"></i></div>
        <div data-i18n="traceability">Traceability</div>
      </div>

      <div class="menu-link" data-nav="contracts">
        <div class="menu-icon"><i class="fa-solid fa-file-contract"></i></div>
        <div data-i18n="smartContracts">Smart Contracts</div>
      </div>
    </aside>

    <main class="main" id="mainContent">
      <!-- DASHBOARD -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-gauge-high"></i> <span data-i18n="navDashboard">Dashboard</span></div>
          <div class="badge"><span data-i18n="live">Live</span></div>
        </div>

        <div class="content-pad">
          <div class="grid4">
            <div class="stat">
              <div class="stat-title" data-i18n="totalRevenue">Total Revenue</div>
              <div class="stat-value" id="revenue">$0</div>
              <div class="stat-change"><i class="fa-solid fa-arrow-up"></i> 15%</div>
            </div>
            <div class="stat">
              <div class="stat-title" data-i18n="walletBalanceLabel">Wallet Balance</div>
              <div class="stat-value" id="wallet">$0</div>
              <div class="stat-change" id="walletDelta"><i class="fa-solid fa-arrow-up"></i> +$0</div>
            </div>
            <div class="stat">
              <div class="stat-title" data-i18n="activeContracts">Active Contracts</div>
              <div class="stat-value">12</div>
              <div class="stat-change"><i class="fa-solid fa-circle-check"></i> <span data-i18n="verified">Verified</span></div>
            </div>
            <div class="stat">
              <div class="stat-title" data-i18n="trustScore">Trust Score</div>
              <div class="stat-value">94</div>
              <div class="stat-change"><i class="fa-solid fa-shield"></i> <span data-i18n="verified">Verified</span></div>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:10px;">
            <button class="action-btn" data-nav="market"><i class="fa-solid fa-store"></i> <span data-i18n="navMarket">Market</span></button>
            <button class="action-btn" data-nav="wallet"><i class="fa-solid fa-wallet"></i> <span data-i18n="navWallet">Wallet</span></button>
            <button class="action-btn" data-nav="disease"><i class="fa-solid fa-camera"></i> <span data-i18n="diseaseScanner">Disease Scanner</span></button>
            <button class="action-btn" data-nav="logistics"><i class="fa-solid fa-truck"></i> <span data-i18n="logistics">Logistics</span></button>
          </div>

          <div style="margin-top:12px;" class="card">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-map-location-dot"></i> <span data-i18n="liveLogistics">Live Logistics</span></div>
              <div class="badge">Map</div>
            </div>
            <div class="content-pad">
              <div id="map"></div>
            </div>
          </div>

          <div style="margin-top:12px; color:var(--text-light); line-height:1.7;">
            Investor demo (GitHub Pages static). All actions update real demo data in your browser.
          </div>
        </div>
      </div>
    </main>

    <aside class="sidebar-right panel">
      <div class="chat-wrap">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-comments"></i> <span data-i18n="messages">Messages</span></div>
            <div class="chat-tabs" id="chatTabs">
              <div class="chat-tab active" data-chat="all"><span data-i18n="all">All</span></div>
              <div class="chat-tab" data-chat="buyers"><span data-i18n="buyers">Buyers</span></div>
              <div class="chat-tab" data-chat="sellers"><span data-i18n="sellers">Sellers</span></div>
              <div class="chat-tab" data-chat="ai"><span data-i18n="ai">AI</span></div>
            </div>
          </div>

          <div class="chat-box">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
              <input id="chatInput" placeholder="Type message..." />
              <button class="action-btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
          </div>
        </div>

        <!-- GAMIFICATION PANEL injected by script at bottom of this sidebar -->
      </div>
    </aside>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <!-- Modal -->
  <div id="agriModal">
    <div id="agriModalCard">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div id="agriModalTitle" style="font-weight:900; font-size:1.05rem;"></div>
        <button id="agriModalClose" class="action-btn"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="agriModalBody" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
  (function () {
    // ---------- CONSTANTS / STATE ----------
    const LS = {
      lang:"agri_lang",
      currency:"agri_currency",
      section:"agri_section",
      data:"agri_demo_data_v6",
      chatTab:"agri_chat_tab",
      gam:"agri_gamification_v1"
    };

    const state = {
      lang: localStorage.getItem(LS.lang) || "en",
      currency: localStorage.getItem(LS.currency) || "USD",
      section: localStorage.getItem(LS.section) || "dashboard",
      chatTab: localStorage.getItem(LS.chatTab) || "all",
      payProvider: "mpesa"
    };

    const rates = { USD:1, KES:130.5, ETB:54.2, RWF:1220 };
    const LOCALES = { en:"en-US", es:"es-ES", fr:"fr-FR", ar:"ar" };
    const RTL = new Set(["ar"]);

    // ---------- I18N ----------
    const I18N = {
      en: {
        appName:"AgriTrade Africa",
        navDashboard:"Dashboard", navMarket:"Market", navWallet:"Wallet", navAITools:"AI Tools",
        sidebarDashboard:"Dashboard", logistics:"Logistics",
        diseaseScanner:"Disease Scanner", priceAI:"Price AI", soilAnalysis:"Soil Analysis",
        traceability:"Traceability", smartContracts:"Smart Contracts",
        totalRevenue:"Total Revenue", walletBalanceLabel:"Wallet Balance", activeContracts:"Active Contracts", trustScore:"Trust Score",
        verified:"Verified", live:"Live", liveLogistics:"Live Logistics",
        messages:"Messages", all:"All", buyers:"Buyers", sellers:"Sellers", ai:"AI",
        digitalWallet:"Digital Wallet", mobileMoney:"Mobile Money", quickPay:"Quick Pay",
        phoneNumber:"Phone Number", amount:"Amount", sendMoney:"Send Money",
        aiDiseaseDetection:"AI Disease Detection", history:"History",
        tapToUpload:"Tap to upload crop photo", chooseFile:"Choose File",
        healthyDetected:"Healthy Crop Detected", confidence:"Confidence",
        healthyAdvice:"Your crop shows no signs of disease. Continue current care schedule.",
        typeMessage:"Type message...",
        aiReply:"Thanks for your message! I‚Äôll help you find the best buyers for your crops.",
        currencyChanged:"Currency changed to {currency}",
        languageChanged:"Language changed to {lang}",
        achievements:"Achievements", level:"Level", xpProgress:"XP Progress"
      },
      es: {
        appName:"AgriTrade √Åfrica",
        navDashboard:"Panel", navMarket:"Mercado", navWallet:"Billetera", navAITools:"Herramientas IA",
        sidebarDashboard:"Panel", logistics:"Log√≠stica",
        diseaseScanner:"Esc√°ner de enfermedades", priceAI:"IA de precios", soilAnalysis:"An√°lisis de suelo",
        traceability:"Trazabilidad", smartContracts:"Contratos inteligentes",
        totalRevenue:"Ingresos totales", walletBalanceLabel:"Saldo de billetera", activeContracts:"Contratos activos", trustScore:"Puntuaci√≥n de confianza",
        verified:"Verificado", live:"En vivo", liveLogistics:"Log√≠stica en vivo",
        messages:"Mensajes", all:"Todos", buyers:"Compradores", sellers:"Vendedores", ai:"IA",
        digitalWallet:"Billetera digital", mobileMoney:"Dinero m√≥vil", quickPay:"Pago r√°pido",
        phoneNumber:"N√∫mero de tel√©fono", amount:"Monto", sendMoney:"Enviar dinero",
        aiDiseaseDetection:"Detecci√≥n de enfermedades con IA", history:"Historial",
        tapToUpload:"Toque para subir foto del cultivo", chooseFile:"Elegir archivo",
        healthyDetected:"Cultivo saludable detectado", confidence:"Confianza",
        healthyAdvice:"No se detectan signos de enfermedad. Contin√∫a con el cuidado habitual.",
        typeMessage:"Escribe un mensaje...",
        aiReply:"¬°Gracias por tu mensaje! Te ayudar√© a encontrar los mejores compradores.",
        currencyChanged:"Moneda cambiada a {currency}",
        languageChanged:"Idioma cambiado a {lang}",
        achievements:"Logros", level:"Nivel", xpProgress:"Progreso XP"
      },
      fr: {
        appName:"AgriTrade Afrique",
        navDashboard:"Tableau de bord", navMarket:"March√©", navWallet:"Portefeuille", navAITools:"Outils IA",
        sidebarDashboard:"Tableau de bord", logistics:"Logistique",
        diseaseScanner:"Scanner de maladies", priceAI:"IA des prix", soilAnalysis:"Analyse du sol",
        traceability:"Tra√ßabilit√©", smartContracts:"Contrats intelligents",
        totalRevenue:"Revenu total", walletBalanceLabel:"Solde du portefeuille", activeContracts:"Contrats actifs", trustScore:"Indice de confiance",
        verified:"V√©rifi√©", live:"En direct", liveLogistics:"Logistique en direct",
        messages:"Messages", all:"Tous", buyers:"Acheteurs", sellers:"Vendeurs", ai:"IA",
        digitalWallet:"Portefeuille num√©rique", mobileMoney:"Mobile Money", quickPay:"Paiement rapide",
        phoneNumber:"Num√©ro de t√©l√©phone", amount:"Montant", sendMoney:"Envoyer de l‚Äôargent",
        aiDiseaseDetection:"D√©tection des maladies par IA", history:"Historique",
        tapToUpload:"Touchez pour t√©l√©verser une photo", chooseFile:"Choisir un fichier",
        healthyDetected:"Culture saine d√©tect√©e", confidence:"Confiance",
        healthyAdvice:"Aucun signe de maladie. Continuez l‚Äôentretien habituel.",
        typeMessage:"Tapez un message...",
        aiReply:"Merci pour votre message ! Je vais vous aider √† trouver les meilleurs acheteurs.",
        currencyChanged:"Devise chang√©e en {currency}",
        languageChanged:"Langue : {lang}",
        achievements:"Succ√®s", level:"Niveau", xpProgress:"Progression XP"
      },
      ar: {
        appName:"ÿ£ÿ¨ÿ±Ÿäÿ™ÿ±ŸäÿØ ÿ£ŸÅÿ±ŸäŸÇŸäÿß",
        navDashboard:"ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ", navMarket:"ÿßŸÑÿ≥ŸàŸÇ", navWallet:"ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©", navAITools:"ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ∞ŸÉÿßÿ°",
        sidebarDashboard:"ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ", logistics:"ÿßŸÑŸÑŸàÿ¨ÿ≥ÿ™Ÿäÿßÿ™",
        diseaseScanner:"ŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ£ŸÖÿ±ÿßÿ∂", priceAI:"ÿ∞ŸÉÿßÿ° ÿßŸÑÿ£ÿ≥ÿπÿßÿ±", soilAnalysis:"ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™ÿ±ÿ®ÿ©",
        traceability:"ÿßŸÑÿ™ÿ™ÿ®ÿπ", smartContracts:"ÿßŸÑÿπŸÇŸàÿØ ÿßŸÑÿ∞ŸÉŸäÿ©",
        totalRevenue:"ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™", walletBalanceLabel:"ÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©", activeContracts:"ÿßŸÑÿπŸÇŸàÿØ ÿßŸÑŸÜÿ¥ÿ∑ÿ©", trustScore:"ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ´ŸÇÿ©",
        verified:"ŸÖŸàÿ´ŸëŸÇ", live:"ŸÖÿ®ÿßÿ¥ÿ±", liveLogistics:"ÿßŸÑŸÑŸàÿ¨ÿ≥ÿ™Ÿäÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©",
        messages:"ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ", all:"ÿßŸÑŸÉŸÑ", buyers:"ÿßŸÑŸÖÿ¥ÿ™ÿ±ŸàŸÜ", sellers:"ÿßŸÑÿ®ÿßÿ¶ÿπŸàŸÜ", ai:"ÿßŸÑÿ∞ŸÉÿßÿ°",
        digitalWallet:"ŸÖÿ≠ŸÅÿ∏ÿ© ÿ±ŸÇŸÖŸäÿ©", mobileMoney:"ÿßŸÑÿØŸÅÿπ ÿπÿ®ÿ± ÿßŸÑŸáÿßÿ™ŸÅ", quickPay:"ÿØŸÅÿπ ÿ≥ÿ±Ÿäÿπ",
        phoneNumber:"ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ", amount:"ÿßŸÑŸÖÿ®ŸÑÿ∫", sendMoney:"ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿßŸÑ",
        aiDiseaseDetection:"ŸÉÿ¥ŸÅ ÿßŸÑÿ£ŸÖÿ±ÿßÿ∂ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ°", history:"ÿßŸÑÿ≥ÿ¨ŸÑ",
        tapToUpload:"ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ŸÑŸÑŸÖÿ≠ÿµŸàŸÑ", chooseFile:"ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅŸãÿß",
        healthyDetected:"ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ŸÖÿ≠ÿµŸàŸÑ ÿ≥ŸÑŸäŸÖ", confidence:"ÿßŸÑÿ´ŸÇÿ©",
        healthyAdvice:"ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÑÿßŸÖÿßÿ™ ŸÖÿ±ÿ∂. ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿ¨ÿØŸàŸÑ ÿßŸÑÿπŸÜÿßŸäÿ© ÿßŸÑŸÖÿπÿ™ÿßÿØ.",
        typeMessage:"ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©...",
        aiReply:"ÿ¥ŸÉÿ±Ÿãÿß ŸÑÿ±ÿ≥ÿßŸÑÿ™ŸÉ! ÿ≥ÿ£ÿ≥ÿßÿπÿØŸÉ ŸÅŸä ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÖÿ¥ÿ™ÿ±ŸäŸÜ.",
        currencyChanged:"ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿπŸÖŸÑÿ© ÿ•ŸÑŸâ {currency}",
        languageChanged:"ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑÿ∫ÿ© ÿ•ŸÑŸâ {lang}",
        achievements:"ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™", level:"ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ", xpProgress:"ÿ™ŸÇÿØŸÖ XP"
      }
    };

    function t(key, vars){
      const dict = I18N[state.lang] || I18N.en;
      let s = dict[key] || I18N.en[key] || key;
      if (vars) Object.keys(vars).forEach(k => s = s.replaceAll(`{${k}}`, String(vars[k])));
      return s;
    }
    function locale(){ return LOCALES[state.lang] || "en-US"; }
    function setDir(){
      const rtl = RTL.has(state.lang);
      document.documentElement.setAttribute("dir", rtl ? "rtl" : "ltr");
      document.documentElement.setAttribute("lang", state.lang);
    }
    function moneyFromUSD(usd){
      const r = rates[state.currency] || 1;
      const val = usd * r;
      try{
        return new Intl.NumberFormat(locale(), { style:"currency", currency: state.currency, maximumFractionDigits: 2 }).format(val);
      }catch{
        return `${val.toLocaleString(locale())} ${state.currency}`;
      }
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function nowISO(){ return new Date().toISOString(); }

    // ---------- TOAST ----------
    function showToast(message, type="info"){
      const c = document.getElementById("toastContainer");
      if(!c) return;
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      const icon = type==="success" ? "check-circle" : type==="error" ? "exclamation-circle" : "info-circle";
      el.innerHTML = `<i class="fas fa-${icon}"></i><span>${escapeHtml(message)}</span>`;
      c.appendChild(el);
      setTimeout(()=> el.remove(), 3200);
    }

    // ---------- MODAL ----------
    const modal = document.getElementById("agriModal");
    const modalTitle = document.getElementById("agriModalTitle");
    const modalBody = document.getElementById("agriModalBody");
    document.getElementById("agriModalClose").addEventListener("click", ()=> modal.style.display="none");
    modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.style.display="none"; });
    function openModal(title, html){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      modal.style.display="flex";
    }

    // ---------- DATA ----------
    function seedData(){
      const data = {
        baseRevenueUSD: 24500,
        walletUSD: 8320.50,
        walletDeltaUSD: 1200,
        chat: [
          { id:"c1", tab:"ai", from:"AI", text:"üí° Tip: Offer bulk discount for 1000kg+ to increase deal size", ts: nowISO() },
          { id:"c2", tab:"buyers", from:"Buyer", text:"We need 5,000kg maize Grade A. Can you deliver to Nairobi in 7 days?", ts: nowISO() },
          { id:"c3", tab:"sellers", from:"Seller", text:"Coffee AA available ‚Äî export ready. MOQ 60kg.", ts: nowISO() }
        ],
        diseaseHistory: []
      };
      localStorage.setItem(LS.data, JSON.stringify(data));
      return data;
    }
    function loadData(){
      try{
        const raw = localStorage.getItem(LS.data);
        if(!raw) return seedData();
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed !== "object") return seedData();
        if(!Array.isArray(parsed.chat)) parsed.chat = [];
        if(!Array.isArray(parsed.diseaseHistory)) parsed.diseaseHistory = [];
        return parsed;
      }catch{ return seedData(); }
    }
    const DB = loadData();
    function saveData(){ localStorage.setItem(LS.data, JSON.stringify(DB)); }

    // ---------- GAMIFICATION ----------
    const GAM = (() => {
      try { return JSON.parse(localStorage.getItem(LS.gam) || "null") || null; } catch { return null; }
    })() || {
      xp: 0,
      level: 1,
      actions: { chats:0, quickPays:0, diseaseScans:0, soilRuns:0, priceRuns:0, navMarket:0, navLogistics:0, aiChats:0 },
      badges: { trader:false, quality:false, pioneer:false, export:false, green:false, digital:false, mentor:false, leader:false }
    };

    function saveGAM(){ localStorage.setItem(LS.gam, JSON.stringify(GAM)); }
    function xpForNextLevel(lv){ return 200 + (lv-1)*120; }

    function badgeHint(k){
      const a = GAM.actions;
      const unlockedCount = Object.values(GAM.badges).filter(Boolean).length;
      const hints = {
        trader: `Send 3 messages (${a.chats}/3)`,
        quality: `Run 2 scans (Disease/Soil) (${(a.diseaseScans+a.soilRuns)}/2)`,
        pioneer: `Run Price AI 2x (${a.priceRuns}/2)`,
        export: `Visit Market + Logistics (${Math.min(1,a.navMarket) + Math.min(1,a.navLogistics)}/2)`,
        green: `Run Soil Analysis 1x (${a.soilRuns}/1)`,
        digital: `Use Quick Pay 1x (${a.quickPays}/1)`,
        mentor: `Chat with AI 5x (${a.aiChats}/5)`,
        leader: `Unlock 4 badges (${unlockedCount}/4)`
      };
      return hints[k] || "";
    }

    function unlockBadge(key, label){
      if(GAM.badges[key]) return;
      GAM.badges[key] = true;
      saveGAM();
      renderGamification();
      showToast(`Badge unlocked: ${label}`, "success");
    }

    function evaluateBadges(){
      if(GAM.actions.chats >= 3) unlockBadge("trader", "Trader");
      if((GAM.actions.diseaseScans + GAM.actions.soilRuns) >= 2) unlockBadge("quality", "Quality");
      if(GAM.actions.priceRuns >= 2) unlockBadge("pioneer", "Pioneer");
      if(GAM.actions.navMarket >= 1 && GAM.actions.navLogistics >= 1) unlockBadge("export", "Export");
      if(GAM.actions.soilRuns >= 1) unlockBadge("green", "Green");
      if(GAM.actions.quickPays >= 1) unlockBadge("digital", "Digital");
      if(GAM.actions.aiChats >= 5) unlockBadge("mentor", "Mentor");
      const unlockedCount = Object.values(GAM.badges).filter(Boolean).length;
      if(unlockedCount >= 4) unlockBadge("leader", "Leader");
    }

    function addXP(amount, reason){
      GAM.xp += amount;
      while(GAM.xp >= xpForNextLevel(GAM.level)){
        GAM.xp -= xpForNextLevel(GAM.level);
        GAM.level += 1;
        showToast(`Level up! Level ${GAM.level}`, "success");
      }
      saveGAM();
      renderGamification();
      evaluateBadges();
      if(reason) showToast(`+${amount} XP ‚Äî ${reason}`, "info");
    }

    function renderGamification(){
      let host = document.getElementById("gamificationPanel");
      if(!host){
        const right = document.querySelector(".sidebar-right .chat-wrap");
        if(!right) return;
        host = document.createElement("div");
        host.id = "gamificationPanel";
        host.className = "card";
        host.style.marginTop = "12px";
        right.appendChild(host);
      }

      const next = xpForNextLevel(GAM.level);
      const pct = Math.max(0, Math.min(100, Math.round((GAM.xp/next)*100)));

      const badgeList = [
        ["trader","Trader"],["quality","Quality"],["pioneer","Pioneer"],["export","Export"],
        ["green","Green"],["digital","Digital"],["mentor","Mentor"],["leader","Leader"]
      ];

      host.innerHTML = `
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-trophy"></i> <span>${escapeHtml(t("achievements"))}</span></div>
          <div class="badge">${escapeHtml(t("level"))} ${GAM.level}</div>
        </div>
        <div class="content-pad">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div style="font-weight:900;">${escapeHtml(t("xpProgress"))}</div>
            <div class="badge">${GAM.xp} / ${next}</div>
          </div>
          <div style="height:10px; background: rgba(255,255,255,.08); border:1px solid var(--border); border-radius:999px; overflow:hidden; margin-top:8px;">
            <div style="height:100%; width:${pct}%; background: linear-gradient(90deg, var(--accent), var(--accent2));"></div>
          </div>

          <div style="margin-top:12px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;">
            ${badgeList.map(([k,label])=>`
              <div style="border:1px solid var(--border); background: rgba(255,255,255,.06); border-radius:14px; padding:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                  <div style="font-weight:900;">${label}</div>
                  <span class="badge" style="${GAM.badges[k] ? "outline:2px solid rgba(34,197,94,.25)" : "opacity:.7"}">
                    ${GAM.badges[k] ? "Unlocked" : "Locked"}
                  </span>
                </div>
                <div style="margin-top:6px; color:var(--text-light); font-size:.85rem;">
                  ${escapeHtml(badgeHint(k))}
                </div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    }

    // ---------- SECTIONS ----------
    function buildSections(){
      const main = document.getElementById("mainContent");
      if(!main) return;
      if(main.querySelector("[data-section='dashboard']")) return;

      // wrap existing dashboard
      const dash = document.createElement("div");
      dash.dataset.section = "dashboard";
      dash.id = "section-dashboard";
      while(main.firstChild) dash.appendChild(main.firstChild);
      main.appendChild(dash);

      const mk = (name, html) => {
        const el = document.createElement("div");
        el.dataset.section = name;
        el.id = `section-${name}`;
        el.className = "card";
        el.style.display="none";
        el.innerHTML = html;
        main.appendChild(el);
      };

      mk("market", shell("fa-store", t("navMarket"), `
        <div class="content-pad" style="color:var(--text-light); line-height:1.7;">
          Market module can be re-attached (your bigger build). For this combined version we stabilized: AI + Chat + Logistics + Gamification.
          <div style="margin-top:10px;">
            <button class="action-btn" onclick="openModal('Market', 'Market listings will be merged in next pass. This demo is stable + investor-ready.')">
              <i class="fa-solid fa-list"></i> Market Status
            </button>
          </div>
        </div>
      `));

      mk("wallet", shell("fa-wallet", t("navWallet"), walletHTML()));
      mk("ai", shell("fa-robot", t("navAITools"), aiHubHTML()));
      mk("disease", shell("fa-camera", t("aiDiseaseDetection"), diseaseHTML()));
      mk("priceai", shell("fa-brain", t("priceAI"), priceAIHTML()));
      mk("soil", shell("fa-flask", t("soilAnalysis"), soilHTML()));
      mk("logistics", shell("fa-truck", t("logistics"), logisticsHTML()));
      mk("traceability", shell("fa-link", t("traceability"), `<div class="content-pad" style="color:var(--text-light);">Traceability module placeholder (next merge).</div>`));
      mk("contracts", shell("fa-file-contract", t("smartContracts"), `<div class="content-pad" style="color:var(--text-light);">Smart Contracts module placeholder (next merge).</div>`));
    }

    function shell(icon, title, body){
      return `
        <div class="card-header">
          <div class="card-title"><i class="fa-solid ${icon}"></i> ${escapeHtml(title)}</div>
          <div class="badge">${escapeHtml(new Intl.DateTimeFormat(locale(), {dateStyle:"medium"}).format(new Date()))}</div>
        </div>
        ${body}
      `;
    }

    function walletHTML(){
      return `
        <div class="content-pad">
          <div class="stat">
            <div class="stat-title" data-i18n="walletBalanceLabel">${escapeHtml(t("walletBalanceLabel"))}</div>
            <div class="stat-value" id="walletBalanceBig">${escapeHtml(moneyFromUSD(DB.walletUSD))}</div>
            <div class="stat-change"><i class="fa-solid fa-shield"></i> <span data-i18n="verified">${escapeHtml(t("verified"))}</span></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-bolt"></i> <span data-i18n="quickPay">${escapeHtml(t("quickPay"))}</span></div>
              <span class="badge" id="walletProviderBadge">M-Pesa</span>
            </div>
            <div class="content-pad">
              <div class="tile-grid">
                <div class="pay-tile" data-pay="mpesa"><div class="pay-logo">M</div><div><div style="font-weight:900;">M-Pesa</div><div style="color:var(--text-light);font-size:.82rem;">Kenya</div></div></div>
                <div class="pay-tile" data-pay="mtn"><div class="pay-logo">MT</div><div><div style="font-weight:900;">MTN</div><div style="color:var(--text-light);font-size:.82rem;">MoMo</div></div></div>
                <div class="pay-tile" data-pay="airtel"><div class="pay-logo">A</div><div><div style="font-weight:900;">Airtel</div><div style="color:var(--text-light);font-size:.82rem;">Money</div></div></div>
              </div>

              <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                  <div style="color:var(--text-light); font-size:.85rem;" data-i18n="phoneNumber">${escapeHtml(t("phoneNumber"))}</div>
                  <input id="walletPhone" value="+254700000000" />
                </div>
                <div>
                  <div style="color:var(--text-light); font-size:.85rem;" data-i18n="amount">${escapeHtml(t("amount"))}</div>
                  <input id="walletAmount" type="number" min="1" step="0.01" value="100" />
                </div>
                <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:10px;">
                  <button class="action-btn" id="walletSendBtn"><i class="fa-solid fa-paper-plane"></i> <span data-i18n="sendMoney">${escapeHtml(t("sendMoney"))}</span></button>
                </div>
              </div>

              <div style="margin-top:10px; color:var(--text-light); font-size:.9rem;">
                Demo transfers persist in your browser (localStorage).
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function aiHubHTML(){
      return `
        <div class="content-pad">
          <div style="display:flex; flex-wrap:wrap; gap:10px;">
            <button class="action-btn" data-nav="disease"><i class="fa-solid fa-camera"></i> <span data-i18n="aiDiseaseDetection">${escapeHtml(t("aiDiseaseDetection"))}</span></button>
            <button class="action-btn" data-nav="priceai"><i class="fa-solid fa-brain"></i> <span data-i18n="priceAI">${escapeHtml(t("priceAI"))}</span></button>
            <button class="action-btn" data-nav="soil"><i class="fa-solid fa-flask"></i> <span data-i18n="soilAnalysis">${escapeHtml(t("soilAnalysis"))}</span></button>
            <button class="action-btn" data-nav="logistics"><i class="fa-solid fa-truck"></i> <span data-i18n="logistics">${escapeHtml(t("logistics"))}</span></button>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Automation</div>
              <div class="badge">Demo</div>
            </div>
            <div class="content-pad" style="color:var(--text-light); line-height:1.7;">
              All AI modules above are active. Upload a crop photo to run disease detection and earn XP.
            </div>
          </div>
        </div>
      `;
    }

    function diseaseHTML(){
      return `
        <div class="content-pad">
          <div class="upload-box">
            <div>
              <div style="font-weight:900;" data-i18n="tapToUpload">${escapeHtml(t("tapToUpload"))}</div>
              <div style="color:var(--text-light); font-size:.9rem;">JPEG/PNG supported</div>
            </div>
            <input id="diseaseFile" type="file" accept="image/*" />
          </div>

          <div id="diseaseResult" style="margin-top:12px; display:none;">
            <div class="card" style="padding:12px;">
              <div style="display:flex; justify-content:space-between; gap:10px;">
                <div style="font-weight:900;" id="diseaseTitle">${escapeHtml(t("healthyDetected"))}</div>
                <div class="badge"><span data-i18n="confidence">${escapeHtml(t("confidence"))}</span>: <span id="diseaseConfidence">‚Äî</span></div>
              </div>
              <div style="margin-top:8px; color:var(--text-light); line-height:1.7;" id="diseaseAdvice">${escapeHtml(t("healthyAdvice"))}</div>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> <span data-i18n="history">${escapeHtml(t("history"))}</span></div>
              <div class="badge" id="diseaseCount">0</div>
            </div>
            <div class="content-pad" id="diseaseHistory" style="color:var(--text-light); line-height:1.7;">
              No scans yet.
            </div>
          </div>
        </div>
      `;
    }

    function priceAIHTML(){
      return `
        <div class="content-pad">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
            <div>
              <div style="color:var(--text-light); font-size:.85rem;">Crop</div>
              <select id="priceCrop"><option>Maize</option><option>Beans</option><option>Coffee</option><option>Mango</option></select>
            </div>
            <div>
              <div style="color:var(--text-light); font-size:.85rem;">Quantity (kg)</div>
              <input id="priceQty" type="number" min="50" step="50" value="1000"/>
            </div>
            <div>
              <div style="color:var(--text-light); font-size:.85rem;">Target Market</div>
              <select id="priceMarket"><option>Nairobi</option><option>Kigali</option><option>Addis Ababa</option><option>Djibouti</option></select>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; justify-content:flex-end;">
            <button class="action-btn" id="runPriceAI"><i class="fa-solid fa-wand-magic-sparkles"></i> Run Price AI</button>
          </div>

          <div class="card" style="margin-top:12px; padding:12px;">
            <div style="font-weight:900;">AI Output</div>
            <div id="priceAIOut" style="margin-top:8px; color:var(--text-light); line-height:1.7;">
              Run the model to generate forecast + a negotiation recommendation.
            </div>
          </div>
        </div>
      `;
    }

    function soilHTML(){
      return `
        <div class="content-pad">
          <div class="upload-box">
            <div>
              <div style="font-weight:900;">Upload soil photo / report</div>
              <div style="color:var(--text-light); font-size:.9rem;">Demo analysis</div>
            </div>
            <input id="soilFile" type="file" accept="image/*,.pdf" />
          </div>

          <div class="card" style="margin-top:12px; padding:12px;">
            <div style="font-weight:900;">Soil AI Recommendation</div>
            <div id="soilOut" style="margin-top:8px; color:var(--text-light); line-height:1.7;">
              Upload a file to generate a recommendation.
            </div>
          </div>
        </div>
      `;
    }

    function logisticsHTML(){
      return `
        <div class="content-pad">
          <div id="map2"></div>
          <div style="margin-top:10px; color:var(--text-light); line-height:1.7;">
            Demo markers: warehouse, farm, in-transit route.
          </div>
        </div>
      `;
    }

    // ---------- NAV ----------
    function showSection(name){
      const main = document.getElementById("mainContent");
      if(!main) return;

      main.querySelectorAll("[data-section]").forEach(s=> s.style.display="none");
      const target = main.querySelector(`[data-section="${name}"]`);
      if(target) target.style.display="";

      state.section = name;
      localStorage.setItem(LS.section, name);

      document.querySelectorAll(".menu-link, .nav-btn").forEach(x=> x.classList.remove("active"));
      document.querySelectorAll(`[data-nav="${name}"]`).forEach(x=> x.classList.add("active"));

      // Gamification nav hooks
      if(name === "market") { GAM.actions.navMarket += 1; addXP(10, "Visited Market"); }
      if(name === "logistics") { GAM.actions.navLogistics += 1; addXP(10, "Visited Logistics"); }
      saveGAM(); evaluateBadges();

      if(name === "dashboard") setTimeout(()=> initMap("map"), 40);
      if(name === "logistics") setTimeout(()=> initMap("map2"), 40);
    }

    function bindNav(){
      document.body.addEventListener("click", (e)=>{
        const nav = e.target.closest("[data-nav]");
        if(nav){
          e.preventDefault();
          showSection(nav.dataset.nav);
        }
      });
    }

    // ---------- LANGUAGE / CURRENCY ----------
    function injectLanguageSelector(){
      const navRight = document.querySelector(".nav-right");
      if(!navRight || document.getElementById("langSelect")) return;
      const sel = document.createElement("select");
      sel.id = "langSelect";
      sel.title = "Language";
      sel.innerHTML = `
        <option value="en">üá∫üá∏ EN</option>
        <option value="es">üá™üá∏ ES</option>
        <option value="fr">üá´üá∑ FR</option>
        <option value="ar">üá∏üá¶ AR</option>
      `;
      sel.value = state.lang;
      sel.addEventListener("change", ()=> setLanguage(sel.value, true));
      navRight.insertBefore(sel, navRight.firstChild);
    }

    function applyTranslations(){
      document.getElementById("appName").textContent = t("appName");
      document.querySelectorAll("[data-i18n]").forEach(el => el.textContent = t(el.dataset.i18n));
      const chatInput = document.getElementById("chatInput");
      if(chatInput) chatInput.placeholder = t("typeMessage");
      renderGamification(); // re-render panel titles in new language
    }

    function setLanguage(lang, toast){
      state.lang = lang;
      localStorage.setItem(LS.lang, lang);
      setDir();
      applyTranslations();
      renderStats();
      renderChat();
      if(toast) showToast(t("languageChanged",{lang:lang.toUpperCase()}), "success");
    }

    function setCurrency(code, toast){
      state.currency = code;
      localStorage.setItem(LS.currency, code);
      renderStats();
      if(toast) showToast(t("currencyChanged",{currency:code}), "success");
    }

    // ---------- STATS ----------
    function renderStats(){
      const revenueEl = document.getElementById("revenue");
      const walletEl = document.getElementById("wallet");
      const walletBig = document.getElementById("walletBalanceBig");
      const delta = document.getElementById("walletDelta");
      if(revenueEl) revenueEl.textContent = moneyFromUSD(DB.baseRevenueUSD);
      if(walletEl) walletEl.textContent = moneyFromUSD(DB.walletUSD);
      if(walletBig) walletBig.textContent = moneyFromUSD(DB.walletUSD);
      if(delta) delta.innerHTML = `<i class="fa-solid fa-arrow-up"></i> +${escapeHtml(moneyFromUSD(DB.walletDeltaUSD || 1200))}`;
    }

    // ---------- CHAT ----------
    function setChatTab(tab){
      state.chatTab = tab;
      localStorage.setItem(LS.chatTab, tab);
      document.querySelectorAll(".chat-tab").forEach(x=> x.classList.remove("active"));
      document.querySelectorAll(`.chat-tab[data-chat="${tab}"]`).forEach(x=> x.classList.add("active"));
      renderChat();
    }

    function renderChat(){
      const box = document.getElementById("chatMessages");
      if(!box) return;
      const tab = state.chatTab;

      const msgs = DB.chat.filter(m => tab==="all" ? true : (m.tab===tab));
      box.innerHTML = msgs.map(m=>{
        const isMe = m.from === "ME";
        const avatar = isMe ? "ME" : (m.from === "AI" ? "AI" : (m.from==="Buyer" ? "B" : "S"));
        const avatarStyle = isMe
          ? `background: var(--accent); color:#08110d;`
          : (m.from==="AI" ? `background: linear-gradient(135deg, var(--purple), #e91e63); color:#fff;` : `background: rgba(255,255,255,.10); color: var(--text);`);
        return `
          <div class="message ${isMe ? "own" : ""}">
            ${isMe ? "" : `<div class="msg-avatar" style="${avatarStyle}">${avatar}</div>`}
            <div class="msg-bubble ${isMe ? "own" : ""}">
              ${m.from==="AI" ? `<div style="font-size:.72rem; font-weight:900; opacity:.9; margin-bottom:4px;">AgriAI</div>` : ""}
              ${escapeHtml(m.text)}
              <div style="margin-top:6px; font-size:.75rem; color:var(--text-light);">${escapeHtml(new Intl.DateTimeFormat(locale(), {timeStyle:"short"}).format(new Date(m.ts)))}</div>
            </div>
            ${isMe ? `<div class="msg-avatar" style="${avatarStyle}">ME</div>` : ""}
          </div>
        `;
      }).join("");

      box.scrollTop = box.scrollHeight;
    }

    function sendChat(){
      const input = document.getElementById("chatInput");
      if(!input) return;
      const text = input.value.trim();
      if(!text) return;

      DB.chat.push({ id:"m"+Math.random().toString(16).slice(2), tab:"all", from:"ME", text, ts: nowISO() });
      input.value = "";
      saveData();
      renderChat();

      GAM.actions.chats += 1;
      addXP(8, "Sent a message");
      saveGAM(); evaluateBadges();

      setTimeout(()=>{
        DB.chat.push({ id:"a"+Math.random().toString(16).slice(2), tab:"ai", from:"AI", text: t("aiReply"), ts: nowISO() });
        saveData();

        GAM.actions.aiChats += 1;
        addXP(6, "AI interaction");
        saveGAM(); evaluateBadges();

        renderChat();
      }, 550);
    }

    function bindChat(){
      const tabs = document.getElementById("chatTabs");
      if(tabs && !tabs.__b){
        tabs.__b = true;
        tabs.addEventListener("click", (e)=>{
          const tEl = e.target.closest(".chat-tab");
          if(!tEl) return;
          setChatTab(tEl.dataset.chat);
        });
      }
      const btn = document.getElementById("sendBtn");
      const input = document.getElementById("chatInput");
      if(btn && !btn.__b){
        btn.__b = true;
        btn.addEventListener("click", sendChat);
      }
      if(input && !input.__b){
        input.__b = true;
        input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendChat(); });
      }
    }

    // ---------- QUICK PAY ----------
    function setPayProvider(p){
      state.payProvider = p;
      const badge = document.getElementById("walletProviderBadge");
      const label = p==="mpesa" ? "M-Pesa" : p==="mtn" ? "MTN" : "Airtel";
      if(badge) badge.textContent = label;
    }

    function sendMoneyQuickPay(){
      const phone = (document.getElementById("walletPhone")?.value || "").trim();
      const amt = Number(document.getElementById("walletAmount")?.value || 0);
      if(!phone || !isFinite(amt) || amt<=0){
        showToast("Enter phone + amount.", "error");
        return;
      }
      const amtUSD = amt / (rates[state.currency] || 1);
      DB.walletUSD = Math.max(0, DB.walletUSD - amtUSD);
      saveData();
      renderStats();

      GAM.actions.quickPays += 1;
      addXP(15, "Used Quick Pay");
      saveGAM(); evaluateBadges();

      showToast(`Sent ${moneyFromUSD(amtUSD)} via ${state.payProvider.toUpperCase()} to ${phone}`, "success");
    }

    function bindWallet(){
      document.querySelectorAll(".pay-tile").forEach(tile=>{
        if(tile.__b) return;
        tile.__b = true;
        tile.addEventListener("click", ()=> setPayProvider(tile.dataset.pay));
      });

      const btn = document.getElementById("walletSendBtn");
      if(btn && !btn.__b){
        btn.__b = true;
        btn.addEventListener("click", sendMoneyQuickPay);
      }
    }

    // ---------- DISEASE / SOIL / PRICE AI ----------
    function renderDiseaseHistory(){
      const wrap = document.getElementById("diseaseHistory");
      const count = document.getElementById("diseaseCount");
      if(count) count.textContent = String(DB.diseaseHistory.length);
      if(!wrap) return;

      if(DB.diseaseHistory.length === 0){
        wrap.textContent = "No scans yet.";
        return;
      }
      wrap.innerHTML = DB.diseaseHistory.map(x=>`
        <div style="padding:10px; border:1px solid var(--border); border-radius:14px; background: rgba(255,255,255,.06); margin-bottom:10px;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div style="font-weight:900;">${escapeHtml(x.outcome)}</div>
            <div class="badge">${escapeHtml(x.confidence)}</div>
          </div>
          <div style="margin-top:6px; color:var(--text-light);">
            ${escapeHtml(x.fileName)} ‚Ä¢ ${escapeHtml(new Intl.DateTimeFormat(locale(), {dateStyle:"medium", timeStyle:"short"}).format(new Date(x.ts)))}
          </div>
        </div>
      `).join("");
    }

    function bindDisease(){
      const file = document.getElementById("diseaseFile");
      if(!file || file.__b) return;
      file.__b = true;

      file.addEventListener("change", ()=>{
        const resultBox = document.getElementById("diseaseResult");
        const title = document.getElementById("diseaseTitle");
        const conf = document.getElementById("diseaseConfidence");
        const advice = document.getElementById("diseaseAdvice");

        const outcomes = [
          { title: t("healthyDetected"), confidence: "96%", advice: t("healthyAdvice") },
          { title: "Early Leaf Spot Risk Detected", confidence: "88%", advice: "Recommend isolate affected area, improve airflow, and apply approved fungicide per local guidance." },
          { title: "Possible Nutrient Stress Detected", confidence: "84%", advice: "Recommend soil test + balanced NPK; check irrigation consistency." }
        ];
        const pick = outcomes[Math.floor(Math.random()*outcomes.length)];

        if(resultBox) resultBox.style.display = "";
        if(title) title.textContent = pick.title;
        if(conf) conf.textContent = pick.confidence;
        if(advice) advice.textContent = pick.advice;

        DB.diseaseHistory.unshift({
          id:"d"+Math.random().toString(16).slice(2),
          fileName: file.files?.[0]?.name || "crop-image",
          outcome: pick.title,
          confidence: pick.confidence,
          ts: nowISO()
        });
        DB.diseaseHistory = DB.diseaseHistory.slice(0, 10);
        saveData();
        renderDiseaseHistory();

        GAM.actions.diseaseScans += 1;
        addXP(18, "Ran Disease Scan");
        saveGAM(); evaluateBadges();

        showToast("Scan complete", "success");
      });
    }

    function bindSoil(){
      const file = document.getElementById("soilFile");
      if(!file || file.__b) return;
      file.__b = true;

      file.addEventListener("change", ()=>{
        const out = document.getElementById("soilOut");
        const recs = [
          "Soil AI: pH slightly acidic. Recommend lime application + compost; retest in 21 days.",
          "Soil AI: low potassium detected. Recommend K-rich fertilizer + improved drainage plan.",
          "Soil AI: nutrient profile balanced. Recommend standard schedule + monitor moisture levels."
        ];
        if(out) out.textContent = recs[Math.floor(Math.random()*recs.length)];

        GAM.actions.soilRuns += 1;
        addXP(18, "Ran Soil Analysis");
        saveGAM(); evaluateBadges();

        showToast("Soil analysis complete", "success");
      });
    }

    function bindPriceAI(){
      const btn = document.getElementById("runPriceAI");
      if(!btn || btn.__b) return;
      btn.__b = true;

      btn.addEventListener("click", ()=>{
        const crop = document.getElementById("priceCrop")?.value || "Crop";
        const qty = Number(document.getElementById("priceQty")?.value || 1000);
        const mk = document.getElementById("priceMarket")?.value || "Market";
        const out = document.getElementById("priceAIOut");
        const baseUSD = crop==="Coffee" ? 6.3 : crop==="Beans" ? 0.95 : crop==="Mango" ? 0.78 : 0.42;
        const swing = (Math.random()*0.10 - 0.02);
        const forecastUSD = baseUSD * (1 + swing);
        const suggestion = qty >= 1000
          ? "Recommendation: offer 2% bulk discount for 1000kg+ to close faster."
          : "Recommendation: keep price firm and prioritize verified buyer escrow.";
        if(out){
          out.innerHTML = `
            Forecast for <strong>${escapeHtml(crop)}</strong> in <strong>${escapeHtml(mk)}</strong>:
            <div style="margin-top:8px;">
              Estimated price: <strong>${escapeHtml(moneyFromUSD(forecastUSD))}</strong> / kg
            </div>
            <div style="margin-top:8px; color:var(--text-light);">${escapeHtml(suggestion)}</div>
          `;
        }

        GAM.actions.priceRuns += 1;
        addXP(16, "Ran Price AI");
        saveGAM(); evaluateBadges();

        showToast("Price AI updated", "success");
      });
    }

    // ---------- MAP ----------
    const mapCache = new Map();
    function initMap(elId){
      const el = document.getElementById(elId);
      if(!el) return;
      if(mapCache.has(elId)) return;
      if(typeof L === "undefined") return;

      const map = L.map(elId, { zoomControl:true }).setView([-1.2921, 36.8219], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

      const markers = [
        { pos: [-1.2921, 36.8219], title: "Nairobi - Warehouse" },
        { pos: [-0.0236, 37.9062], title: "Mt. Kenya - Farm" },
        { pos: [-1.2864, 36.8172], title: "In Transit" }
      ];
      markers.forEach(m => L.marker(m.pos).addTo(map).bindPopup(m.title));

      mapCache.set(elId, map);
    }

    // ---------- INIT ----------
    function init(){
      injectLanguageSelector();
      setDir();
      buildSections();
      bindNav();
      bindChat();

      const cur = document.getElementById("currency");
      cur.value = state.currency;
      cur.addEventListener("change", ()=> setCurrency(cur.value, true));

      const langSel = document.getElementById("langSelect");
      if(langSel) langSel.value = state.lang;

      applyTranslations();
      renderStats();
      renderGamification();

      // Restore chat tab
      setChatTab(state.chatTab);

      // Restore section
      showSection(state.section);

      // Bind module handlers (after sections exist)
      bindWallet();
      bindDisease();
      bindPriceAI();
      bindSoil();
      renderDiseaseHistory();

      // init maps
      setTimeout(()=> initMap("map"), 80);
      setTimeout(()=> initMap("map2"), 100);
    }

    // Expose helpers
    window.setLanguage = (l, toast)=> setLanguage(l, toast);
    window.setCurrency = (c, toast)=> setCurrency(c, toast);
    window.showSection = (s)=> showSection(s);
    window.openModal = (title, html)=> openModal(title, html);

    // Show errors on screen if something breaks
    window.addEventListener("error", (e)=>{
      const msg = (e?.error?.stack || e.message || "Unknown error");
      document.body.innerHTML = `<div style="padding:20px;font-family:Arial;color:#fff;background:#111">
        <h2>AgriTrade Error</h2><pre style="white-space:pre-wrap">${escapeHtml(msg)}</pre>
      </div>`;
    }, { once:true });

    init();
  })();
  </script>
</body>
</html>
