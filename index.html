<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgriTrade Africa â€” Investor Demo</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#f5fff7;
      --bg2:#ecfdf3;
      --card: rgba(255,255,255,.93);
      --text:#0b1220;
      --muted: rgba(11,18,32,.68);
      --accent:#16a34a;
      --accent2:#22c55e;
      --danger:#dc2626;
      --warn:#f59e0b;
      --info:#2563eb;
      --border: rgba(11,18,32,.12);
      --shadow: 0 18px 40px rgba(11,18,32,.10);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(800px 450px at 90% 20%, rgba(34,197,94,.14), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    a{color:inherit; text-decoration:none}
    hr{border:none;border-top:1px solid rgba(11,18,32,.10); margin:10px 0}
    .navbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(12px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900;}
    .logo{
      width:36px; height:36px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 22px rgba(11,18,32,.12);
      overflow:hidden;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }
    .nav-center{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
      box-shadow: 0 6px 18px rgba(11,18,32,.06);
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.98)}
    .btn:active{transform: translateY(1px)}
    .btn.active{outline:2px solid rgba(22,163,74,.18); border-color: rgba(22,163,74,.30)}
    .btn.primary{
      border-color: rgba(22,163,74,.28);
      background: rgba(22,163,74,.12);
    }
    .btn.danger{
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.08);
    }
    .btn.warn{
      border-color: rgba(245,158,11,.30);
      background: rgba(245,158,11,.10);
    }
    .btn.small{padding:7px 10px; border-radius:10px; font-size:.9rem}

    .nav-right{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    select, input, textarea{
      border:1px solid var(--border);
      background: rgba(255,255,255,.94);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      outline:none;
      box-shadow: 0 6px 18px rgba(11,18,32,.06);
    }
    textarea{min-height:84px; resize:vertical}
    option{background:#fff; color:var(--text)}

    .layout{
      display:grid;
      grid-template-columns: 270px 1fr 380px;
      gap:14px;
      padding:14px;
      max-width: 1580px;
      margin: 0 auto;
    }
    @media(max-width:1240px){
      .layout{grid-template-columns: 250px 1fr;}
      .right{display:none}
    }
    @media(max-width:760px){
      .layout{grid-template-columns: 1fr;}
      .left{display:none}
      .right{display:none}
    }

    .panel{
      border:1px solid var(--border);
      background: rgba(255,255,255,.78);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .left{padding:12px}
    .menu-title{font-size:.85rem; color:var(--muted); margin:10px 8px 8px;}
    .menu-link{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease;
    }
    .menu-link:hover{background: rgba(22,163,74,.10)}
    .menu-link.active{background: rgba(22,163,74,.14); outline:1px solid rgba(22,163,74,.22)}
    .menu-icon{
      width:34px; height:34px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(22,163,74,.10);
      border:1px solid rgba(22,163,74,.20);
    }

    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.90);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.96);
      flex-wrap:wrap;
    }
    .card-title{font-weight:900; display:flex; align-items:center; gap:10px}
    .content-pad{padding:12px 14px}
    .muted{color:var(--muted)}

    .grid4{display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px;}
    @media(max-width:1180px){ .grid4{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media(max-width:760px){ .grid4{grid-template-columns: 1fr;} }

    .stat{
      padding:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.94);
      border-radius: 14px;
      box-shadow: 0 8px 22px rgba(11,18,32,.06);
    }
    .stat-title{font-size:.85rem; color:var(--muted)}
    .stat-value{font-size:1.6rem; font-weight:900; margin-top:6px}
    .stat-change{font-size:.85rem; margin-top:6px; color:#166534}

    #map{height:560px; border-radius:14px; border:1px solid var(--border); overflow:hidden; background:#fff;}
    #mapMirror{height:560px; border-radius:14px; border:1px solid var(--border); overflow:hidden; background:#fff;}

    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(11,18,32,.12);
      background: rgba(255,255,255,.92);
      font-size:.78rem;
      color: var(--muted);
      white-space:nowrap;
      gap:8px;
    }

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}

    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--border); background: rgba(255,255,255,.94);}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(11,18,32,.08); text-align:left; font-size:.92rem;}
    th{font-size:.82rem; color:var(--muted); background: rgba(22,163,74,.06)}
    tr:last-child td{border-bottom:none}

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.95);
      box-shadow: 0 8px 22px rgba(11,18,32,.06);
      font-size:.85rem;
      user-select:none;
    }
    .dot{width:10px; height:10px; border-radius:99px; background:#9ca3af}
    .dot.on{background: var(--accent)}
    .kpi{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:1180px){ .kpi{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media(max-width:760px){ .kpi{grid-template-columns: 1fr;} }

    /* Right panel: chat + gamification */
    .right{padding:12px}
    .chat-box{
      border:1px solid var(--border);
      background: rgba(255,255,255,.94);
      border-radius: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height: 560px;
      box-shadow: 0 10px 26px rgba(11,18,32,.07);
    }
    .tabs{display:flex; gap:8px; padding:10px; border-bottom:1px solid rgba(11,18,32,.08); background: rgba(255,255,255,.96); flex-wrap:wrap;}
    .tab{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      cursor:pointer;
      font-size:.82rem;
      color:var(--muted);
      user-select:none;
      background: rgba(255,255,255,.92);
    }
    .tab.active{color:var(--text); outline:2px solid rgba(22,163,74,.16)}
    .chat-messages{padding:10px; overflow:auto; flex:1}
    .message{display:flex; gap:10px; margin:10px 0}
    .message.own{justify-content:flex-end}
    .avatar{
      width:34px; height:34px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background: rgba(22,163,74,.10);
      font-weight:900; font-size:.78rem;
    }
    .bubble{
      max-width: 78%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.94);
      padding:10px 12px;
      border-radius: 14px;
      line-height:1.55;
    }
    .bubble.own{background: rgba(22,163,74,.12)}
    .chat-input{display:flex; gap:8px; padding:10px; border-top:1px solid rgba(11,18,32,.08); background: rgba(255,255,255,.96);}
    .chat-input input{flex:1}

    .toast-container{
      position:fixed;
      right:20px;
      bottom:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
    }
    .toast{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.96);
      box-shadow: var(--shadow);
      max-width: 560px;
    }
    .toast.success i{color:#16a34a}
    .toast.error i{color:#dc2626}
    .toast.warn i{color:#f59e0b}
    .toast.info i{color:#2563eb}

    /* Provider tiles */
    .tile-grid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;}
    .tile{
      border:1px solid var(--border);
      background: rgba(255,255,255,.94);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
      box-shadow: 0 8px 22px rgba(11,18,32,.06);
      user-select:none;
    }
    .tile:hover{background: rgba(22,163,74,.08)}
    .tile.active{outline:2px solid rgba(22,163,74,.18); border-color: rgba(22,163,74,.30)}
    .tile-logo{
      width:36px; height:36px; border-radius:12px;
      border:1px solid var(--border);
      background: rgba(22,163,74,.12);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
    }

    /* Progress bar */
    .bar{
      height:10px; border-radius:999px; border:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.9);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      transition: width .25s ease;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(11,18,32,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:99999;
    }
    .modal{
      width:min(720px, 100%);
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.96);
      box-shadow: 0 22px 70px rgba(11,18,32,.25);
      overflow:hidden;
    }
    .modal .modal-head{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px;
      border-bottom:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.96);
    }
    .modal .modal-body{padding:12px 14px}
    .modal .modal-foot{
      padding:12px 14px;
      display:flex; justify-content:flex-end; gap:10px;
      border-top:1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.96);
      flex-wrap:wrap;
    }
    .field-grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media(max-width:700px){ .field-grid{grid-template-columns: 1fr;} }

    .hint{
      font-size:.85rem; color:var(--muted);
      line-height:1.6;
    }
    .error{color: var(--danger); font-size:.9rem;}
    .ok{color:#166534; font-size:.9rem;}

    /* Loading shimmer */
    .loading{
      display:inline-flex; gap:8px; align-items:center;
      font-size:.92rem; color: var(--muted);
    }
    .spinner{
      width:16px; height:16px; border-radius:999px;
      border:2px solid rgba(11,18,32,.12);
      border-top-color: rgba(22,163,74,.75);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* QR canvas */
    .qr-wrap{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .qr{
      width:140px; height:140px;
      border-radius:14px;
      border:1px solid rgba(11,18,32,.12);
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }

    [dir="rtl"] body { direction: rtl; }
    [dir="rtl"] .navbar { flex-direction: row-reverse; }
    [dir="rtl"] .nav-center { flex-direction: row-reverse; }
    [dir="rtl"] .nav-right { flex-direction: row-reverse; }
    [dir="rtl"] .menu-link{justify-content:flex-end}
    [dir="rtl"] .toast-container{right:auto; left:20px}
    [dir="rtl"] .message{ text-align:right }
    [dir="rtl"] .message.own{ flex-direction: row }
  </style>
</head>

<body>
  <div class="navbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" width="36" height="36">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#16a34a"/>
              <stop offset="1" stop-color="#22c55e"/>
            </linearGradient>
          </defs>
          <rect x="6" y="6" width="52" height="52" rx="14" fill="url(#g)"/>
          <path d="M44 18c-10 2-18 10-20 20 10-2 18-10 20-20Z" fill="#ffffff" opacity="0.95"/>
          <path d="M22 42c7-8 14-13 22-16" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" opacity="0.95"/>
        </svg>
      </div>
      <div>
        <div id="appName" style="font-weight:900; line-height:1;">AgriTrade Africa</div>
        <div class="muted" style="font-size:.8rem; margin-top:2px;">Investor Demo â€¢ LocalStorage Sim</div>
      </div>
    </div>

    <div class="nav-center">
      <button class="btn active" data-nav="dashboard" onclick="__agri_nav('dashboard')"><i class="fa-solid fa-chart-line"></i> <span data-i18n="navDashboard">Dashboard</span></button>
      <button class="btn" data-nav="market" onclick="__agri_nav('market')"><i class="fa-solid fa-store"></i> <span data-i18n="navMarket">Market</span></button>
      <button class="btn" data-nav="wallet" onclick="__agri_nav('wallet')"><i class="fa-solid fa-wallet"></i> <span data-i18n="navWallet">Wallet</span></button>
      <button class="btn" data-nav="ai" onclick="__agri_nav('ai')"><i class="fa-solid fa-robot"></i> <span data-i18n="navAITools">AI Tools</span></button>
      <button class="btn" data-nav="orders" onclick="__agri_nav('orders')"><i class="fa-solid fa-box"></i> <span data-i18n="orders">Orders</span></button>
      <button class="btn" data-nav="logistics" onclick="__agri_nav('logistics')"><i class="fa-solid fa-truck"></i> <span data-i18n="logistics">Logistics</span></button>
      <button class="btn" data-nav="progress" onclick="__agri_nav('progress')"><i class="fa-solid fa-trophy"></i> <span data-i18n="progress">Progress</span></button>
    </div>

    <div class="nav-right">
      <div class="pill" title="JS status">
        <span class="dot on"></span>
        <span>JS: ON</span>
        <span class="badge" id="clickCount">0</span>
      </div>

      <div class="pill" title="Your gamification status">
        <i class="fa-solid fa-star" style="color: var(--warn)"></i>
        <span><span data-i18n="level">Level</span>: <strong id="navLevel">â€”</strong></span>
        <span class="badge">XP <strong id="navXP">â€”</strong></span>
      </div>

      <select id="langSelect" title="Language">
        <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
        <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
        <option value="fr">ðŸ‡«ðŸ‡· FR</option>
        <option value="ar">ðŸ‡¸ðŸ‡¦ AR</option>
      </select>

      <select id="currency" title="Currency">
        <option value="USD">USD</option>
        <option value="KES">KES</option>
        <option value="ETB">ETB</option>
        <option value="RWF">RWF</option>
      </select>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT -->
    <aside class="panel left">
      <div class="menu-title" data-i18n="nav">NAV</div>

      <div class="menu-link active" data-nav="dashboard" onclick="__agri_nav('dashboard')">
        <div class="menu-icon"><i class="fa-solid fa-chart-line"></i></div>
        <div data-i18n="navDashboard">Dashboard</div>
      </div>

      <div class="menu-link" data-nav="market" onclick="__agri_nav('market')">
        <div class="menu-icon"><i class="fa-solid fa-store"></i></div>
        <div data-i18n="navMarket">Market</div>
      </div>

      <div class="menu-link" data-nav="wallet" onclick="__agri_nav('wallet')">
        <div class="menu-icon"><i class="fa-solid fa-wallet"></i></div>
        <div data-i18n="navWallet">Wallet</div>
      </div>

      <div class="menu-link" data-nav="orders" onclick="__agri_nav('orders')">
        <div class="menu-icon"><i class="fa-solid fa-box"></i></div>
        <div data-i18n="orders">Orders</div>
      </div>

      <div class="menu-link" data-nav="logistics" onclick="__agri_nav('logistics')">
        <div class="menu-icon"><i class="fa-solid fa-truck"></i></div>
        <div data-i18n="logistics">Logistics</div>
      </div>

      <div class="menu-title" data-i18n="aiAutomation">AI & Automation</div>

      <div class="menu-link" data-nav="ai" onclick="__agri_nav('ai')">
        <div class="menu-icon"><i class="fa-solid fa-robot"></i></div>
        <div data-i18n="navAITools">AI Tools</div>
      </div>

      <div class="menu-title" data-i18n="gamification">Gamification</div>
      <div class="menu-link" data-nav="progress" onclick="__agri_nav('progress')">
        <div class="menu-icon"><i class="fa-solid fa-trophy"></i></div>
        <div data-i18n="progress">Progress</div>
      </div>

      <div class="menu-title">Export</div>
      <div class="menu-link" onclick="Exports.exportAll()">
        <div class="menu-icon"><i class="fa-solid fa-file-export"></i></div>
        <div>Export All CSV</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main id="mainContent">
      <!-- DASHBOARD -->
      <section class="card" data-section="dashboard" id="section-dashboard">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-gauge-high"></i> <span data-i18n="navDashboard">Dashboard</span></div>
          <div class="badge"><i class="fa-solid fa-signal"></i> <span data-i18n="live">Live</span></div>
        </div>

        <div class="content-pad">
          <div class="grid4">
            <div class="stat">
              <div class="stat-title" data-i18n="totalRevenue">Total Revenue</div>
              <div class="stat-value" id="revenue">â€”</div>
              <div class="stat-change"><i class="fa-solid fa-arrow-up"></i> <span id="revPct">15%</span></div>
            </div>
            <div class="stat">
              <div class="stat-title" data-i18n="walletBalanceLabel">Wallet Balance</div>
              <div class="stat-value" id="walletKpi">â€”</div>
              <div class="stat-change" id="walletDelta"><i class="fa-solid fa-arrow-up"></i> +â€”</div>
            </div>
            <div class="stat">
              <div class="stat-title" data-i18n="activeContracts">Active Contracts</div>
              <div class="stat-value" id="contractsKpi">12</div>
              <div class="stat-change"><i class="fa-solid fa-circle-check"></i> <span data-i18n="verified">Verified</span></div>
            </div>
            <div class="stat">
              <div class="stat-title" data-i18n="trustScore">Trust Score</div>
              <div class="stat-value" id="trustKpi">94</div>
              <div class="stat-change"><i class="fa-solid fa-shield"></i> <span data-i18n="verified">Verified</span></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-map-location-dot"></i> <span data-i18n="liveLogistics">Live Logistics</span></div>
              <div class="badge">Map</div>
            </div>
            <div class="content-pad">
              <div id="map"></div>
              <div id="mapFallback" class="muted" style="display:none; margin-top:8px;">
                Map library did not load, but the app is running.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- MARKET -->
      <section class="card" data-section="market" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-store"></i> <span data-i18n="navMarket">Market</span></div>
          <div class="row">
            <input id="marketSearch" class="grow" placeholder="Search listings..." />
            <button class="btn primary" onclick="Market.openCreateModal()"><i class="fa-solid fa-plus"></i> <span data-i18n="createListing">Create Listing</span></button>
            <button class="btn" onclick="Exports.exportListings()"><i class="fa-solid fa-file-csv"></i> CSV</button>
          </div>
        </div>

        <div class="content-pad">
          <div class="muted" style="margin-bottom:10px;">
            <span data-i18n="marketHint">Create listings, edit price/qty, and place orders. Data persists in your browser.</span>
          </div>
          <div id="marketList"></div>
        </div>
      </section>

      <!-- WALLET -->
      <section class="card" data-section="wallet" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-wallet"></i> <span data-i18n="navWallet">Wallet</span></div>
          <div class="row">
            <span class="badge"><span data-i18n="availableBalance">Available Balance</span>: <strong id="walletBalance">â€”</strong></span>
            <button class="btn" onclick="Wallet.depositDemo()"><i class="fa-solid fa-circle-plus"></i> <span data-i18n="deposit">Deposit</span></button>
            <button class="btn" onclick="Exports.exportLedger()"><i class="fa-solid fa-file-csv"></i> CSV</button>
          </div>
        </div>

        <div class="content-pad">
          <div class="card" style="margin-bottom:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-bolt"></i> <span data-i18n="quickPay">Quick Pay</span></div>
              <div class="badge">M-Pesa â€¢ MTN â€¢ Airtel</div>
            </div>
            <div class="content-pad">
              <div class="tile-grid" style="margin-bottom:10px;">
                <div class="tile" id="tileMP" onclick="Wallet.selectProvider('M-Pesa')"><div class="tile-logo">MP</div><div><strong>M-Pesa</strong><div class="muted" style="font-size:.85rem;">Safaricom</div></div></div>
                <div class="tile" id="tileMT" onclick="Wallet.selectProvider('MTN')"><div class="tile-logo">MT</div><div><strong>MTN</strong><div class="muted" style="font-size:.85rem;">Mobile Money</div></div></div>
                <div class="tile" id="tileAR" onclick="Wallet.selectProvider('Airtel')"><div class="tile-logo">AR</div><div><strong>Airtel</strong><div class="muted" style="font-size:.85rem;">Money</div></div></div>
              </div>

              <div class="row" style="margin-bottom:10px;">
                <span class="badge"><span data-i18n="provider">Provider</span>: <strong id="payProvider">M-Pesa</strong></span>
                <span class="badge"><span data-i18n="fee">Fee</span>: <strong id="payFee">â€”</strong></span>
                <span class="badge">Receipt: <strong id="receiptHint">Ready</strong></span>
              </div>

              <div class="row" style="margin-bottom:10px;">
                <input id="payPhone" class="grow" placeholder="Phone Number" />
                <input id="payAmount" type="number" min="1" step="1" placeholder="Amount" />
                <button class="btn primary" onclick="Wallet.sendMoney()"><i class="fa-solid fa-paper-plane"></i> <span data-i18n="sendMoney">Send Money</span></button>
              </div>

              <div class="error" id="payValidation" style="display:none;"></div>

              <div class="card" style="margin-top:10px;">
                <div class="card-header">
                  <div class="card-title"><i class="fa-solid fa-receipt"></i> Receipt</div>
                  <div class="row">
                    <button class="btn small" onclick="Wallet.printReceipt()"><i class="fa-solid fa-print"></i> Print</button>
                  </div>
                </div>
                <div class="content-pad" id="receiptBox" style="line-height:1.7;">
                  <div class="muted">Send a payment to generate a receipt.</div>
                </div>
              </div>

            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-receipt"></i> <span data-i18n="walletLedger">Wallet Ledger</span></div>
              <button class="btn danger" onclick="Wallet.reset()"><i class="fa-solid fa-rotate-left"></i> <span data-i18n="reset">Reset</span></button>
            </div>
            <div class="content-pad">
              <div id="ledgerTable"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ORDERS -->
      <section class="card" data-section="orders" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-box"></i> <span data-i18n="orders">Orders</span></div>
          <div class="row">
            <button class="btn" onclick="Orders.seedOne()"><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="simulateOrder">Simulate Order</span></button>
            <button class="btn" onclick="Exports.exportOrders()"><i class="fa-solid fa-file-csv"></i> CSV</button>
            <button class="btn danger" onclick="Orders.reset()"><i class="fa-solid fa-trash"></i> <span data-i18n="clear">Clear</span></button>
          </div>
        </div>
        <div class="content-pad">
          <div id="ordersTable"></div>
        </div>
      </section>

      <!-- AI TOOLS -->
      <section class="card" data-section="ai" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-robot"></i> <span data-i18n="navAITools">AI Tools</span></div>
          <div class="badge"><span data-i18n="aiPredictionAccuracy">Predictions accurate 94% of the time</span></div>
        </div>

        <div class="content-pad">
          <div class="kpi" style="margin-bottom:12px;">
            <div class="card">
              <div class="content-pad">
                <div class="row" style="justify-content:space-between;">
                  <div><strong data-i18n="priceAI">Price AI</strong><div class="muted" style="font-size:.85rem;" data-i18n="priceAiHint">Estimate price by crop & grade</div></div>
                  <button class="btn" onclick="__agri_nav('aiPrice')"><i class="fa-solid fa-tag"></i> <span data-i18n="open">Open</span></button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="content-pad">
                <div class="row" style="justify-content:space-between;">
                  <div><strong data-i18n="soilAnalysis">Soil Analysis</strong><div class="muted" style="font-size:.85rem;" data-i18n="soilHint">Upload report image</div></div>
                  <button class="btn" onclick="__agri_nav('aiSoil')"><i class="fa-solid fa-flask"></i> <span data-i18n="open">Open</span></button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="content-pad">
                <div class="row" style="justify-content:space-between;">
                  <div><strong data-i18n="diseaseScanner">Disease Scanner</strong><div class="muted" style="font-size:.85rem;" data-i18n="diseaseHint">Upload crop photo</div></div>
                  <button class="btn" onclick="__agri_nav('disease')"><i class="fa-solid fa-camera"></i> <span data-i18n="open">Open</span></button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-comments"></i> <span data-i18n="aiCommandCenter">AI Command Center</span></div>
              <div class="badge">AgriAI</div>
            </div>
            <div class="content-pad">
              <div class="muted" data-i18n="aiTip">ðŸ’¡ Tip: Offer bulk discount for 1000kg+ to increase deal size</div>
              <div class="row" style="margin-top:10px;">
                <input id="aiPrompt" class="grow" placeholder="Ask AgriAI..." />
                <button class="btn primary" onclick="AI.ask()"><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="ask">Ask</span></button>
              </div>
              <div id="aiAnswer" class="card" style="margin-top:10px;">
                <div class="content-pad muted" id="aiAnswerText">â€”</div>
              </div>

              <div class="card" style="margin-top:12px;">
                <div class="card-header">
                  <div class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> AI History</div>
                  <button class="btn small danger" onclick="AI.clearHistory()"><i class="fa-solid fa-trash"></i> Clear</button>
                </div>
                <div class="content-pad" id="aiHistory"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- AI PRICE -->
      <section class="card" data-section="aiPrice" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-tag"></i> <span data-i18n="priceAI">Price AI</span></div>
          <button class="btn" onclick="__agri_nav('ai')"><i class="fa-solid fa-arrow-left"></i> <span data-i18n="back">Back</span></button>
        </div>
        <div class="content-pad">
          <div class="row" style="margin-bottom:10px;">
            <select id="priceCrop">
              <option value="maize">Maize</option>
              <option value="beans">Beans</option>
              <option value="coffee">Coffee</option>
              <option value="cassava">Cassava</option>
            </select>
            <select id="priceGrade">
              <option value="A">Grade A</option>
              <option value="B">Grade B</option>
              <option value="C">Grade C</option>
            </select>
            <input id="priceQty" type="number" min="1" step="1" placeholder="Qty (kg)" />
            <button class="btn primary" onclick="AI.calcPrice()"><i class="fa-solid fa-calculator"></i> <span data-i18n="estimate">Estimate</span></button>
          </div>
          <div class="card">
            <div class="content-pad">
              <div class="muted" data-i18n="estimatedPayout">Estimated payout</div>
              <div style="font-size:1.6rem;font-weight:900;" id="priceOut">â€”</div>
              <div class="muted" id="priceNote" style="margin-top:6px;">â€”</div>
            </div>
          </div>
        </div>
      </section>

      <!-- AI SOIL -->
      <section class="card" data-section="aiSoil" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-flask"></i> <span data-i18n="soilAnalysis">Soil Analysis</span></div>
          <button class="btn" onclick="__agri_nav('ai')"><i class="fa-solid fa-arrow-left"></i> <span data-i18n="back">Back</span></button>
        </div>
        <div class="content-pad">
          <div class="row" style="margin-bottom:10px;">
            <input id="soilFile" type="file" accept="image/*,application/pdf" />
            <button class="btn primary" onclick="AI.soilAnalyze()"><i class="fa-solid fa-microscope"></i> <span data-i18n="analyze">Analyze</span></button>
          </div>
          <div class="card">
            <div class="content-pad" id="soilResult" style="line-height:1.7;">
              <div class="muted" data-i18n="soilResultHint">Upload a soil report image/PDF to simulate nutrient analysis.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- DISEASE -->
      <section class="card" data-section="disease" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-camera"></i> <span data-i18n="aiDiseaseDetection">AI Disease Detection</span></div>
          <div class="row">
            <button class="btn" onclick="__agri_nav('ai')"><i class="fa-solid fa-arrow-left"></i> <span data-i18n="back">Back</span></button>
          </div>
        </div>
        <div class="content-pad">
          <div class="row" style="margin-bottom:10px;">
            <input id="diseaseFile" type="file" accept="image/*" />
            <button class="btn primary" onclick="AI.diseaseScan()"><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="scanCrop">Scan Crop</span></button>
          </div>
          <div class="card">
            <div class="content-pad" id="diseaseResult" style="line-height:1.7;">
              <div class="muted" data-i18n="tapToUpload">Tap to upload crop photo</div>
            </div>
          </div>
        </div>
      </section>

      <!-- LOGISTICS -->
      <section class="card" data-section="logistics" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-truck"></i> <span data-i18n="logistics">Logistics</span></div>
          <div class="row">
            <span class="badge"><i class="fa-solid fa-location-dot"></i> Nairobi â†’ Hub â†’ Buyer</span>
            <button class="btn" onclick="Maps.fitAll()"><i class="fa-solid fa-expand"></i> Fit Map</button>
          </div>
        </div>
        <div class="content-pad">
          <div class="muted" data-i18n="logisticsHint">Track shipments. Map stays interactive and resizes correctly.</div>
          <div class="card" style="margin-top:10px;">
            <div class="content-pad">
              <div id="mapMirror"></div>
              <div id="mapMirrorFallback" class="muted" style="display:none; margin-top:8px;">Map library did not load.</div>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-route"></i> Timeline</div>
              <button class="btn small" onclick="Logistics.addCheckpoint()"><i class="fa-solid fa-plus"></i> Add Checkpoint</button>
            </div>
            <div class="content-pad" id="logTimeline"></div>
          </div>
        </div>
      </section>

      <!-- PROGRESS / GAMIFICATION -->
      <section class="card" data-section="progress" style="display:none;">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-trophy"></i> <span data-i18n="progress">Progress</span></div>
          <div class="row">
            <button class="btn primary" onclick="Game.unlockProgress()"><i class="fa-solid fa-unlock"></i> <span data-i18n="unlockProgress">Unlock Progress</span></button>
            <button class="btn" onclick="Game.claimReward()"><i class="fa-solid fa-gift"></i> Claim Reward</button>
            <button class="btn danger" onclick="Game.reset()"><i class="fa-solid fa-rotate-left"></i> <span data-i18n="reset">Reset</span></button>
          </div>
        </div>
        <div class="content-pad">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <span class="badge"><span data-i18n="level">Level</span>: <strong id="lvl">â€”</strong></span>
            <span class="badge">XP: <strong id="xp">â€”</strong></span>
            <span class="badge"><span data-i18n="nextReward">Next reward</span>: <strong id="nextReward">â€”</strong></span>
          </div>
          <div class="bar"><div id="xpBar"></div></div>

          <div class="card" style="margin-top:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-list-check"></i> Action Checklist</div>
              <span class="badge">Do actions to earn XP</span>
            </div>
            <div class="content-pad" id="checklist"></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-award"></i> <span data-i18n="achievements">Achievements</span></div>
            </div>
            <div class="content-pad" id="badges" style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;"></div>
          </div>
        </div>
      </section>

    </main>

    <!-- RIGHT -->
    <aside class="panel right">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="fa-solid fa-comments"></i> <span data-i18n="messages">Messages</span></div>
          <div class="badge">AgriChat</div>
        </div>

        <div class="chat-box">
          <div class="tabs">
            <div class="tab active" data-tab="buyers" onclick="Chat.switch('buyers')"><span data-i18n="buyers">Buyers</span></div>
            <div class="tab" data-tab="sellers" onclick="Chat.switch('sellers')"><span data-i18n="sellers">Sellers</span></div>
            <div class="tab" data-tab="ai" onclick="Chat.switch('ai')"><span data-i18n="ai">AI</span></div>
          </div>

          <div class="chat-messages" id="chatMessages"></div>

          <div class="chat-input">
            <input id="chatInput" placeholder="Type message..." onkeydown="if(event.key==='Enter'){Chat.send()}" />
            <button class="btn primary" onclick="Chat.send()"><i class="fa-solid fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <!-- MODAL -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="UI.closeModalOnBackdrop(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="card-title" id="modalTitle"><i class="fa-solid fa-layer-group"></i> Modal</div>
        <button class="btn small" onclick="UI.closeModal()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-foot" id="modalFoot"></div>
    </div>
  </div>

  <script>
  (function(){
    // ---------- STORAGE KEYS ----------
    const LS = {
      lang:"agri_lang",
      currency:"agri_currency",
      section:"agri_section",
      listings:"agri_listings",
      orders:"agri_orders",
      wallet:"agri_wallet",
      game:"agri_game",
      chat:"agri_chat",
      aiHistory:"agri_ai_history",
      logistics:"agri_logistics_timeline"
    };

    // ---------- FX + LOCALE ----------
    const rates = { USD:1, KES:130.5, ETB:54.2, RWF:1220 };
    const LOCALES = { en:"en-US", es:"es-ES", fr:"fr-FR", ar:"ar" };
    const RTL = new Set(["ar"]);

    const state = {
      lang: localStorage.getItem(LS.lang) || "en",
      currency: localStorage.getItem(LS.currency) || "USD",
      section: localStorage.getItem(LS.section) || "dashboard",
      clicks: 0
    };

    // ---------- I18N ----------
    const I18N = {
      en: {
        appName:"AgriTrade Africa",
        nav:"NAV",
        navDashboard:"Dashboard",
        navMarket:"Market",
        navWallet:"Wallet",
        navAITools:"AI Tools",
        orders:"Orders",
        logistics:"Logistics",
        aiAutomation:"AI & Automation",
        diseaseScanner:"Disease Scanner",
        aiDiseaseDetection:"AI Disease Detection",
        aiCommandCenter:"AI Command Center",
        aiPredictionAccuracy:"Predictions accurate 94% of the time",
        totalRevenue:"Total Revenue",
        walletBalanceLabel:"Wallet Balance",
        activeContracts:"Active Contracts",
        trustScore:"Trust Score",
        verified:"Verified",
        live:"Live",
        liveLogistics:"Live Logistics",
        marketHint:"Create listings, edit price/qty, and place orders. Data persists in your browser.",
        createListing:"Create Listing",
        availableBalance:"Available Balance",
        deposit:"Deposit",
        quickPay:"Quick Pay",
        provider:"Provider",
        fee:"Fee",
        sendMoney:"Send Money",
        walletLedger:"Wallet Ledger",
        reset:"Reset",
        simulateOrder:"Simulate Order",
        clear:"Clear",
        open:"Open",
        back:"Back",
        priceAI:"Price AI",
        priceAiHint:"Estimate price by crop & grade",
        soilAnalysis:"Soil Analysis",
        soilHint:"Upload report image",
        ask:"Ask",
        aiTip:"ðŸ’¡ Tip: Offer bulk discount for 1000kg+ to increase deal size",
        estimate:"Estimate",
        estimatedPayout:"Estimated payout",
        analyze:"Analyze",
        soilResultHint:"Upload a soil report image/PDF to simulate nutrient analysis.",
        scanCrop:"Scan Crop",
        tapToUpload:"Tap to upload crop photo",
        logisticsHint:"Track shipments. Map stays interactive and resizes correctly.",
        messages:"Messages",
        buyers:"Buyers",
        sellers:"Sellers",
        ai:"AI",
        typeMessage:"Type message...",
        progress:"Progress",
        gamification:"Gamification",
        unlockProgress:"Unlock Progress",
        achievements:"Achievements",
        level:"Level",
        nextReward:"Next reward"
      },
      es: {
        appName:"AgriTrade Ãfrica",
        nav:"NAV",
        navDashboard:"Panel",
        navMarket:"Mercado",
        navWallet:"Billetera",
        navAITools:"Herramientas IA",
        orders:"Pedidos",
        logistics:"LogÃ­stica",
        aiAutomation:"IA y automatizaciÃ³n",
        diseaseScanner:"EscÃ¡ner de enfermedades",
        aiDiseaseDetection:"DetecciÃ³n de enfermedades con IA",
        aiCommandCenter:"Centro de mando IA",
        aiPredictionAccuracy:"Predicciones precisas el 94% del tiempo",
        totalRevenue:"Ingresos totales",
        walletBalanceLabel:"Saldo de billetera",
        activeContracts:"Contratos activos",
        trustScore:"PuntuaciÃ³n de confianza",
        verified:"Verificado",
        live:"En vivo",
        liveLogistics:"LogÃ­stica en vivo",
        marketHint:"Crea anuncios, edita precio/cantidad y realiza pedidos. Los datos se guardan en tu navegador.",
        createListing:"Crear anuncio",
        availableBalance:"Saldo disponible",
        deposit:"Depositar",
        quickPay:"Pago rÃ¡pido",
        provider:"Proveedor",
        fee:"ComisiÃ³n",
        sendMoney:"Enviar dinero",
        walletLedger:"Libro de la billetera",
        reset:"Restablecer",
        simulateOrder:"Simular pedido",
        clear:"Borrar",
        open:"Abrir",
        back:"Volver",
        priceAI:"IA de precios",
        priceAiHint:"Estimar por cultivo y calidad",
        soilAnalysis:"AnÃ¡lisis de suelo",
        soilHint:"Sube imagen del reporte",
        ask:"Preguntar",
        aiTip:"ðŸ’¡ Consejo: Ofrece descuento por 1000kg+ para aumentar el valor del trato",
        estimate:"Estimar",
        estimatedPayout:"Pago estimado",
        analyze:"Analizar",
        soilResultHint:"Sube una imagen/PDF para simular anÃ¡lisis de nutrientes.",
        scanCrop:"Escanear cultivo",
        tapToUpload:"Sube una foto del cultivo",
        logisticsHint:"Rastrea envÃ­os. El mapa se mantiene interactivo.",
        messages:"Mensajes",
        buyers:"Compradores",
        sellers:"Vendedores",
        ai:"IA",
        typeMessage:"Escribe un mensaje...",
        progress:"Progreso",
        gamification:"GamificaciÃ³n",
        unlockProgress:"Desbloquear progreso",
        achievements:"Logros",
        level:"Nivel",
        nextReward:"Siguiente recompensa"
      },
      fr: {
        appName:"AgriTrade Afrique",
        nav:"NAV",
        navDashboard:"Tableau de bord",
        navMarket:"MarchÃ©",
        navWallet:"Portefeuille",
        navAITools:"Outils IA",
        orders:"Commandes",
        logistics:"Logistique",
        aiAutomation:"IA & automatisation",
        diseaseScanner:"Scanner de maladies",
        aiDiseaseDetection:"DÃ©tection des maladies par IA",
        aiCommandCenter:"Centre de commande IA",
        aiPredictionAccuracy:"PrÃ©dictions exactes 94% du temps",
        totalRevenue:"Revenu total",
        walletBalanceLabel:"Solde du portefeuille",
        activeContracts:"Contrats actifs",
        trustScore:"Indice de confiance",
        verified:"VÃ©rifiÃ©",
        live:"En direct",
        liveLogistics:"Logistique en direct",
        marketHint:"CrÃ©ez des annonces, modifiez prix/quantitÃ© et passez des commandes. DonnÃ©es enregistrÃ©es dans le navigateur.",
        createListing:"CrÃ©er une annonce",
        availableBalance:"Solde disponible",
        deposit:"DÃ©pÃ´t",
        quickPay:"Paiement rapide",
        provider:"Fournisseur",
        fee:"Frais",
        sendMoney:"Envoyer de lâ€™argent",
        walletLedger:"Journal du portefeuille",
        reset:"RÃ©initialiser",
        simulateOrder:"Simuler commande",
        clear:"Effacer",
        open:"Ouvrir",
        back:"Retour",
        priceAI:"IA des prix",
        priceAiHint:"Estimer par culture et qualitÃ©",
        soilAnalysis:"Analyse du sol",
        soilHint:"TÃ©lÃ©verser rapport",
        ask:"Demander",
        aiTip:"ðŸ’¡ Astuce : remise 1000kg+ pour augmenter la taille des ventes",
        estimate:"Estimer",
        estimatedPayout:"Paiement estimÃ©",
        analyze:"Analyser",
        soilResultHint:"TÃ©lÃ©versez image/PDF pour simuler lâ€™analyse des nutriments.",
        scanCrop:"Scanner la culture",
        tapToUpload:"TÃ©lÃ©versez une photo de la culture",
        logisticsHint:"Suivi des expÃ©ditions. Carte interactive.",
        messages:"Messages",
        buyers:"Acheteurs",
        sellers:"Vendeurs",
        ai:"IA",
        typeMessage:"Tapez un message...",
        progress:"Progression",
        gamification:"Gamification",
        unlockProgress:"DÃ©bloquer",
        achievements:"SuccÃ¨s",
        level:"Niveau",
        nextReward:"Prochaine rÃ©compense"
      },
      ar: {
        appName:"Ø£Ø¬Ø±ÙŠØªØ±ÙŠØ¯ Ø£ÙØ±ÙŠÙ‚ÙŠØ§",
        nav:"Ø§Ù„ØªÙ†Ù‚Ù„",
        navDashboard:"Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
        navMarket:"Ø§Ù„Ø³ÙˆÙ‚",
        navWallet:"Ø§Ù„Ù…Ø­ÙØ¸Ø©",
        navAITools:"Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡",
        orders:"Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
        logistics:"Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª",
        aiAutomation:"Ø§Ù„Ø°ÙƒØ§Ø¡ ÙˆØ§Ù„Ø£ØªÙ…ØªØ©",
        diseaseScanner:"Ù…Ø§Ø³Ø­ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶",
        aiDiseaseDetection:"ÙƒØ´Ù Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡",
        aiCommandCenter:"Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø°ÙƒØ§Ø¡",
        aiPredictionAccuracy:"ØªÙˆÙ‚Ø¹Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ù†Ø³Ø¨Ø© 94%",
        totalRevenue:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
        walletBalanceLabel:"Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©",
        activeContracts:"Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·Ø©",
        trustScore:"Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ù‚Ø©",
        verified:"Ù…ÙˆØ«Ù‘Ù‚",
        live:"Ù…Ø¨Ø§Ø´Ø±",
        liveLogistics:"Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©",
        marketHint:"Ø£Ù†Ø´Ø¦ Ø¹Ø±ÙˆØ¶Ù‹Ø§ØŒ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„ÙƒÙ…ÙŠØ©ØŒ ÙˆØ£Ù†Ø´Ø¦ Ø·Ù„Ø¨Ø§Øª. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.",
        createListing:"Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶",
        availableBalance:"Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­",
        deposit:"Ø¥ÙŠØ¯Ø§Ø¹",
        quickPay:"Ø¯ÙØ¹ Ø³Ø±ÙŠØ¹",
        provider:"Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯",
        fee:"Ø§Ù„Ø±Ø³ÙˆÙ…",
        sendMoney:"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø§Ù„",
        walletLedger:"Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­ÙØ¸Ø©",
        reset:"Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·",
        simulateOrder:"Ù…Ø­Ø§ÙƒØ§Ø© Ø·Ù„Ø¨",
        clear:"Ù…Ø³Ø­",
        open:"ÙØªØ­",
        back:"Ø±Ø¬ÙˆØ¹",
        priceAI:"Ø°ÙƒØ§Ø¡ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±",
        priceAiHint:"ØªÙ‚Ø¯ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØµÙˆÙ„ ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©",
        soilAnalysis:"ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø©",
        soilHint:"Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ±",
        ask:"Ø§Ø³Ø£Ù„",
        aiTip:"ðŸ’¡ Ù†ØµÙŠØ­Ø©: Ø®ØµÙ… 1000 ÙƒØº+ Ù„Ø²ÙŠØ§Ø¯Ø© Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙÙ‚Ø©",
        estimate:"ØªÙ‚Ø¯ÙŠØ±",
        estimatedPayout:"Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹",
        analyze:"ØªØ­Ù„ÙŠÙ„",
        soilResultHint:"Ø§Ø±ÙØ¹ ØµÙˆØ±Ø©/Ù…Ù„Ù PDF Ù„Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØºØ°ÙŠØ§Øª.",
        scanCrop:"ÙØ­Øµ Ø§Ù„Ù…Ø­ØµÙˆÙ„",
        tapToUpload:"Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ù…Ø­ØµÙˆÙ„",
        logisticsHint:"ØªØªØ¨Ø¹ Ø§Ù„Ø´Ø­Ù†Ø§Øª. Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªØ¸Ù„ ØªÙØ§Ø¹Ù„ÙŠØ©.",
        messages:"Ø§Ù„Ø±Ø³Ø§Ø¦Ù„",
        buyers:"Ø§Ù„Ù…Ø´ØªØ±ÙˆÙ†",
        sellers:"Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙˆÙ†",
        ai:"Ø§Ù„Ø°ÙƒØ§Ø¡",
        typeMessage:"Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...",
        progress:"Ø§Ù„ØªÙ‚Ø¯Ù…",
        gamification:"Ø§Ù„ØªØ­ÙÙŠØ²",
        unlockProgress:"ÙØªØ­ Ø§Ù„ØªÙ‚Ø¯Ù…",
        achievements:"Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª",
        level:"Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
        nextReward:"Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©"
      }
    };

    const t = (k)=> (I18N[state.lang] && I18N[state.lang][k]) || I18N.en[k] || k;
    const locale = ()=> LOCALES[state.lang] || "en-US";

    function setDir(){
      const rtl = RTL.has(state.lang);
      document.documentElement.setAttribute("dir", rtl ? "rtl" : "ltr");
      document.documentElement.setAttribute("lang", state.lang);
    }

    function moneyFromUSD(usd){
      const r = rates[state.currency] || 1;
      const v = usd * r;
      try { return new Intl.NumberFormat(locale(), { style:"currency", currency: state.currency, maximumFractionDigits:2 }).format(v); }
      catch { return v.toLocaleString(locale()) + " " + state.currency; }
    }

    function showToast(msg, type="info"){
      const c = document.getElementById("toastContainer");
      if(!c) return;
      const el = document.createElement("div");
      el.className = "toast " + type;
      const icon = type==="success" ? "check-circle" : type==="error" ? "exclamation-circle" : type==="warn" ? "triangle-exclamation" : "info-circle";
      el.innerHTML = `<i class="fas fa-${icon}"></i><span>${String(msg)}</span>`;
      c.appendChild(el);
      setTimeout(()=> el.remove(), 2800);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---------- STORE ----------
    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      }catch{ return fallback; }
    }
    function saveJSON(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    const Store = {
      listings: ()=> loadJSON(LS.listings, null),
      setListings: (v)=> saveJSON(LS.listings, v),
      wallet: ()=> loadJSON(LS.wallet, null),
      setWallet: (v)=> saveJSON(LS.wallet, v),
      orders: ()=> loadJSON(LS.orders, null),
      setOrders: (v)=> saveJSON(LS.orders, v),
      game: ()=> loadJSON(LS.game, null),
      setGame: (v)=> saveJSON(LS.game, v),
      chat: ()=> loadJSON(LS.chat, null),
      setChat: (v)=> saveJSON(LS.chat, v),
      aiHistory: ()=> loadJSON(LS.aiHistory, []),
      setAiHistory: (v)=> saveJSON(LS.aiHistory, v),
      logisticsTimeline: ()=> loadJSON(LS.logistics, null),
      setLogisticsTimeline: (v)=> saveJSON(LS.logistics, v),
    };

    // ---------- DEFAULT DATA ----------
    const uuid = ()=> (crypto?.randomUUID ? crypto.randomUUID() : ("id-"+Math.random().toString(16).slice(2)));

    const defaultListings = [
      { id: uuid(), crop:"Maize", grade:"A", qtyKg: 1200, pricePerKgUSD: 0.42, location:"Nakuru, KE", seller:"Kiptoo Farm Co-op", updatedAt: Date.now() },
      { id: uuid(), crop:"Beans", grade:"B", qtyKg: 650, pricePerKgUSD: 0.88, location:"Musanze, RW", seller:"Imbuto Traders", updatedAt: Date.now() },
      { id: uuid(), crop:"Coffee", grade:"A", qtyKg: 300, pricePerKgUSD: 3.10, location:"Jimma, ET", seller:"Oromia Growers", updatedAt: Date.now() }
    ];

    const defaultWallet = {
      balanceUSD: 8320.50,
      ledger: [
        { id: uuid(), type:"credit", provider:"Settlement", amountUSD: 1200, note:"Contract payout", ts: Date.now()-86400000 },
        { id: uuid(), type:"debit", provider:"M-Pesa", amountUSD: 85, note:"Logistics fee", ts: Date.now()-42000000 }
      ],
      lastReceipt: null
    };

    const defaultOrders = [
      { id: "ORD-10021", crop:"Maize", qtyKg: 500, priceUSD: 0.42, buyer:"Nairobi Foods Ltd", status:"Pending", ts: Date.now()-7200000 },
      { id: "ORD-10022", crop:"Beans", qtyKg: 200, priceUSD: 0.88, buyer:"Kigali Market Hub", status:"In Transit", ts: Date.now()-17200000 }
    ];

    const defaultGame = { xp: 120, level: 1, unlocked: {}, lastClaimAt: 0 };

    const defaultChat = {
      tab:"buyers",
      messages: [
        { role:"ai", tab:"ai", text:"Welcome to AgriChat. Try: â€œFind maize buyers for 1000kgâ€", ts: Date.now()-60000 }
      ]
    };

    const defaultTimeline = [
      { id: uuid(), label:"Farm pickup confirmed", ts: Date.now()-7200000 },
      { id: uuid(), label:"Warehouse received & graded", ts: Date.now()-5400000 },
      { id: uuid(), label:"Truck departed Nairobi hub", ts: Date.now()-3600000 }
    ];

    // Seed localStorage once
    function ensureSeed(){
      if(!localStorage.getItem(LS.listings)) Store.setListings(defaultListings);
      if(!localStorage.getItem(LS.wallet)) Store.setWallet(defaultWallet);
      if(!localStorage.getItem(LS.orders)) Store.setOrders(defaultOrders);
      if(!localStorage.getItem(LS.game)) Store.setGame(defaultGame);
      if(!localStorage.getItem(LS.chat)) Store.setChat(defaultChat);
      if(!localStorage.getItem(LS.logistics)) Store.setLogisticsTimeline(defaultTimeline);
    }

    // ---------- UI MODAL ----------
    const UI = {
      openModal({title, icon="fa-layer-group", bodyHTML, footHTML}){
        document.getElementById("modalTitle").innerHTML = `<i class="fa-solid ${icon}"></i> ${title}`;
        document.getElementById("modalBody").innerHTML = bodyHTML;
        document.getElementById("modalFoot").innerHTML = footHTML || `
          <button class="btn" onclick="UI.closeModal()"><i class="fa-solid fa-xmark"></i> Close</button>
        `;
        document.getElementById("modalBackdrop").style.display = "flex";
      },
      closeModal(){ document.getElementById("modalBackdrop").style.display = "none"; },
      closeModalOnBackdrop(e){ if(e.target && e.target.id==="modalBackdrop") UI.closeModal(); }
    };
    window.UI = UI;

    // ---------- NAV ----------
    window.__agri_nav = function(name){
      state.clicks++;
      const cc = document.getElementById("clickCount");
      if(cc) cc.textContent = String(state.clicks);

      document.querySelectorAll("[data-section]").forEach(s=> s.style.display="none");
      const target = document.querySelector(`[data-section="${name}"]`);
      if(target) target.style.display="";

      document.querySelectorAll(".menu-link,.btn").forEach(x=> x.classList.remove("active"));
      document.querySelectorAll(`[data-nav="${name}"]`).forEach(x=> x.classList.add("active"));

      state.section = name;
      localStorage.setItem(LS.section, name);

      if(name==="dashboard") setTimeout(()=> Maps.initMain(), 120);
      if(name==="logistics") setTimeout(()=> Maps.initMirror(), 140);
    };

    function applyTranslations(){
      document.getElementById("appName").textContent = t("appName");
      document.querySelectorAll("[data-i18n]").forEach(el => el.textContent = t(el.dataset.i18n));
      const chatInput = document.getElementById("chatInput");
      if(chatInput) chatInput.placeholder = t("typeMessage");
    }

    // ---------- DASHBOARD ----------
    const Dashboard = {
      render(){
        const orders = Store.orders() || [];
        const wallet = Store.wallet();
        const revenueUSD = orders.reduce((sum,o)=> sum + (o.qtyKg * o.priceUSD), 0) + 24500;

        document.getElementById("revenue").textContent = moneyFromUSD(revenueUSD);
        document.getElementById("walletKpi").textContent = moneyFromUSD(wallet.balanceUSD);
        document.getElementById("walletBalance").textContent = moneyFromUSD(wallet.balanceUSD);
        document.getElementById("walletDelta").innerHTML = `<i class="fa-solid fa-arrow-up"></i> +${moneyFromUSD(1200)}`;
      }
    };

    // ---------- MARKET (MODALS) ----------
    const Market = {
      openCreateModal(){
        UI.openModal({
          title: "Create Market Listing",
          icon: "fa-store",
          bodyHTML: `
            <div class="field-grid">
              <div>
                <div class="hint">Crop</div>
                <input id="mCrop" placeholder="e.g., Maize" value="Maize"/>
              </div>
              <div>
                <div class="hint">Grade</div>
                <select id="mGrade">
                  <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                </select>
              </div>
              <div>
                <div class="hint">Quantity (kg)</div>
                <input id="mQty" type="number" min="1" value="500"/>
              </div>
              <div>
                <div class="hint">Price per kg (USD)</div>
                <input id="mPrice" type="number" min="0.01" step="0.01" value="0.50"/>
              </div>
              <div>
                <div class="hint">Location</div>
                <input id="mLoc" placeholder="City, Country" value="Nairobi, KE"/>
              </div>
              <div>
                <div class="hint">Seller</div>
                <input id="mSeller" placeholder="Seller name" value="Demo Seller"/>
              </div>
            </div>
            <div class="error" id="mErr" style="display:none; margin-top:10px;"></div>
          `,
          footHTML: `
            <button class="btn" onclick="UI.closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button class="btn primary" onclick="Market.createFromModal()"><i class="fa-solid fa-check"></i> Create</button>
          `
        });
      },
      createFromModal(){
        const crop = (document.getElementById("mCrop").value||"").trim();
        const grade = (document.getElementById("mGrade").value||"A").trim().toUpperCase();
        const qty = Number(document.getElementById("mQty").value);
        const price = Number(document.getElementById("mPrice").value);
        const loc = (document.getElementById("mLoc").value||"").trim();
        const seller = (document.getElementById("mSeller").value||"").trim();
        const err = document.getElementById("mErr");

        const fail=(m)=>{ err.style.display="block"; err.textContent=m; };

        if(!crop) return fail("Crop is required.");
        if(!["A","B","C"].includes(grade)) return fail("Grade must be A, B, or C.");
        if(!Number.isFinite(qty) || qty<=0) return fail("Quantity must be greater than 0.");
        if(!Number.isFinite(price) || price<=0) return fail("Price must be greater than 0.");
        if(!loc) return fail("Location is required.");
        if(!seller) return fail("Seller is required.");

        const listings = Store.listings();
        listings.unshift({
          id: uuid(),
          crop, grade,
          qtyKg: Math.round(qty),
          pricePerKgUSD: price,
          location: loc,
          seller,
          updatedAt: Date.now()
        });
        Store.setListings(listings);
        UI.closeModal();
        Game.addXP(25, "Created listing");
        Market.render();
        showToast("Listing created", "success");
      },
      openEditModal(id){
        const listings = Store.listings();
        const item = listings.find(x=> x.id===id);
        if(!item) return;

        UI.openModal({
          title: "Edit Listing",
          icon: "fa-pen-to-square",
          bodyHTML: `
            <div class="field-grid">
              <div>
                <div class="hint">Crop</div>
                <input id="eCrop" value="${escapeHtml(item.crop)}"/>
              </div>
              <div>
                <div class="hint">Grade</div>
                <select id="eGrade">
                  <option value="A" ${item.grade==="A"?"selected":""}>A</option>
                  <option value="B" ${item.grade==="B"?"selected":""}>B</option>
                  <option value="C" ${item.grade==="C"?"selected":""}>C</option>
                </select>
              </div>
              <div>
                <div class="hint">Quantity (kg)</div>
                <input id="eQty" type="number" min="1" value="${item.qtyKg}"/>
              </div>
              <div>
                <div class="hint">Price per kg (USD)</div>
                <input id="ePrice" type="number" min="0.01" step="0.01" value="${item.pricePerKgUSD}"/>
              </div>
              <div>
                <div class="hint">Location</div>
                <input id="eLoc" value="${escapeHtml(item.location)}"/>
              </div>
              <div>
                <div class="hint">Seller</div>
                <input id="eSeller" value="${escapeHtml(item.seller)}"/>
              </div>
            </div>
            <div class="error" id="eErr" style="display:none; margin-top:10px;"></div>
          `,
          footHTML: `
            <button class="btn danger" onclick="Market.remove('${id}')"><i class="fa-solid fa-trash"></i> Remove</button>
            <span class="grow"></span>
            <button class="btn" onclick="UI.closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button class="btn primary" onclick="Market.saveEdit('${id}')"><i class="fa-solid fa-check"></i> Save</button>
          `
        });
      },
      saveEdit(id){
        const listings = Store.listings();
        const item = listings.find(x=> x.id===id);
        if(!item) return;

        const crop = (document.getElementById("eCrop").value||"").trim();
        const grade = (document.getElementById("eGrade").value||"A").trim().toUpperCase();
        const qty = Number(document.getElementById("eQty").value);
        const price = Number(document.getElementById("ePrice").value);
        const loc = (document.getElementById("eLoc").value||"").trim();
        const seller = (document.getElementById("eSeller").value||"").trim();
        const err = document.getElementById("eErr");
        const fail=(m)=>{ err.style.display="block"; err.textContent=m; };

        if(!crop) return fail("Crop is required.");
        if(!["A","B","C"].includes(grade)) return fail("Grade must be A, B, or C.");
        if(!Number.isFinite(qty) || qty<=0) return fail("Quantity must be greater than 0.");
        if(!Number.isFinite(price) || price<=0) return fail("Price must be greater than 0.");
        if(!loc) return fail("Location is required.");
        if(!seller) return fail("Seller is required.");

        item.crop=crop; item.grade=grade; item.qtyKg=Math.round(qty);
        item.pricePerKgUSD=price; item.location=loc; item.seller=seller;
        item.updatedAt=Date.now();
        Store.setListings(listings);

        UI.closeModal();
        Game.addXP(10, "Edited listing");
        Market.render();
        showToast("Listing updated", "success");
      },
      openOrderModal(listingId){
        const listings = Store.listings();
        const item = listings.find(x=> x.id===listingId);
        if(!item) return;

        UI.openModal({
          title: "Place Order",
          icon: "fa-cart-shopping",
          bodyHTML: `
            <div class="hint"><strong>${escapeHtml(item.crop)}</strong> â€¢ Grade ${escapeHtml(item.grade)} â€¢ Available ${item.qtyKg.toLocaleString(locale())} kg</div>
            <hr>
            <div class="field-grid">
              <div>
                <div class="hint">Buyer Name</div>
                <input id="oBuyer" value="Demo Buyer Ltd"/>
              </div>
              <div>
                <div class="hint">Order Quantity (kg)</div>
                <input id="oQty" type="number" min="1" value="${Math.min(200, item.qtyKg)}"/>
              </div>
              <div>
                <div class="hint">Payment Terms</div>
                <select id="oTerms">
                  <option>Escrow (recommended)</option>
                  <option>50% upfront, 50% on delivery</option>
                  <option>Net 7</option>
                  <option>Net 14</option>
                </select>
              </div>
              <div>
                <div class="hint">Delivery Window</div>
                <select id="oDelivery">
                  <option>24â€“48 hours</option>
                  <option>2â€“4 days</option>
                  <option>5â€“7 days</option>
                </select>
              </div>
            </div>
            <div class="error" id="oErr" style="display:none; margin-top:10px;"></div>
            <div class="card" style="margin-top:10px;">
              <div class="content-pad">
                <div class="muted">Estimated Total</div>
                <div style="font-size:1.4rem;font-weight:900;" id="oTotal">â€”</div>
                <div class="muted" style="margin-top:6px;">Price/kg: <strong>${moneyFromUSD(item.pricePerKgUSD)}</strong></div>
              </div>
            </div>
          `,
          footHTML: `
            <button class="btn" onclick="UI.closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button class="btn primary" onclick="Market.placeOrderFromModal('${listingId}')"><i class="fa-solid fa-check"></i> Place Order</button>
          `
        });

        const qtyEl = document.getElementById("oQty");
        const calc = ()=>{
          const q = Number(qtyEl.value);
          const totalUSD = (Number.isFinite(q) ? q : 0) * item.pricePerKgUSD;
          document.getElementById("oTotal").textContent = moneyFromUSD(totalUSD);
        };
        qtyEl.addEventListener("input", calc);
        calc();
      },
      placeOrderFromModal(listingId){
        const listings = Store.listings();
        const item = listings.find(x=> x.id===listingId);
        if(!item) return;

        const buyer = (document.getElementById("oBuyer").value||"").trim();
        const qty = Number(document.getElementById("oQty").value);
        const terms = (document.getElementById("oTerms").value||"").trim();
        const delivery = (document.getElementById("oDelivery").value||"").trim();
        const err = document.getElementById("oErr");
        const fail=(m)=>{ err.style.display="block"; err.textContent=m; };

        if(!buyer) return fail("Buyer name is required.");
        if(!Number.isFinite(qty) || qty<=0) return fail("Order quantity must be greater than 0.");
        if(qty > item.qtyKg) return fail("Order quantity exceeds available inventory.");

        // reduce listing qty
        item.qtyKg -= Math.round(qty);
        item.updatedAt = Date.now();

        const orders = Store.orders();
        const id = "ORD-" + String(Math.floor(10000 + Math.random()*89999));
        orders.unshift({
          id,
          crop: item.crop,
          qtyKg: Math.round(qty),
          priceUSD: item.pricePerKgUSD,
          buyer,
          status: "Pending",
          terms,
          delivery,
          ts: Date.now()
        });

        Store.setListings(listings.filter(x=> x.qtyKg > 0));
        Store.setOrders(orders);

        UI.closeModal();
        Game.addXP(35, "Placed order");
        Orders.render();
        Market.render();
        Dashboard.render();
        showToast(`Order created: ${id}`, "success");
      },
      remove(id){
        if(!confirm("Remove this listing?")) return;
        const listings = Store.listings().filter(x=> x.id!==id);
        Store.setListings(listings);
        UI.closeModal();
        Game.addXP(5, "Removed listing");
        Market.render();
        showToast("Listing removed", "success");
      },
      render(){
        const wrap = document.getElementById("marketList");
        if(!wrap) return;

        const q = (document.getElementById("marketSearch")?.value || "").trim().toLowerCase();
        let listings = Store.listings();
        if(q){
          listings = listings.filter(x =>
            x.crop.toLowerCase().includes(q) ||
            x.location.toLowerCase().includes(q) ||
            x.seller.toLowerCase().includes(q) ||
            x.grade.toLowerCase().includes(q)
          );
        }

        if(!listings.length){
          wrap.innerHTML = `<div class="muted">No listings match your search.</div>`;
          return;
        }

        const rows = listings.map(x=>{
          const totalUSD = x.qtyKg * x.pricePerKgUSD;
          const updated = new Intl.DateTimeFormat(locale(), { dateStyle:"medium" }).format(new Date(x.updatedAt));
          return `
            <tr>
              <td><strong>${escapeHtml(x.crop)}</strong><div class="muted" style="font-size:.85rem;">${escapeHtml(x.location)} â€¢ Updated ${updated}</div></td>
              <td>${escapeHtml(x.grade)}</td>
              <td>${x.qtyKg.toLocaleString(locale())}</td>
              <td>${moneyFromUSD(x.pricePerKgUSD)}</td>
              <td><strong>${moneyFromUSD(totalUSD)}</strong><div class="muted" style="font-size:.85rem;">${escapeHtml(x.seller)}</div></td>
              <td class="row" style="gap:6px;">
                <button class="btn primary small" onclick="Market.openOrderModal('${x.id}')"><i class="fa-solid fa-cart-shopping"></i> Order</button>
                <button class="btn small" onclick="Market.openEditModal('${x.id}')"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
              </td>
            </tr>
          `;
        }).join("");

        wrap.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Listing</th>
                <th>Grade</th>
                <th>Qty (kg)</th>
                <th>Price/kg</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }
    };

    // ---------- WALLET ----------
    const Wallet = {
      provider: "M-Pesa",
      feeFor(provider){
        if(provider==="M-Pesa") return 0.012;
        if(provider==="MTN") return 0.010;
        if(provider==="Airtel") return 0.011;
        return 0.012;
      },
      selectProvider(p){
        Wallet.provider = p;
        document.getElementById("payProvider").textContent = p;
        document.getElementById("tileMP").classList.toggle("active", p==="M-Pesa");
        document.getElementById("tileMT").classList.toggle("active", p==="MTN");
        document.getElementById("tileAR").classList.toggle("active", p==="Airtel");
        Wallet.renderFee();
      },
      renderFee(){
        const feePct = Wallet.feeFor(Wallet.provider);
        document.getElementById("payFee").textContent = new Intl.NumberFormat(locale(), { style:"percent", maximumFractionDigits:1 }).format(feePct);
      },
      depositDemo(){
        const wallet = Store.wallet();
        wallet.balanceUSD += 250;
        wallet.ledger.unshift({ id: uuid(), type:"credit", provider:"Deposit", amountUSD: 250, note:"Demo deposit", ts: Date.now() });
        Store.setWallet(wallet);
        Game.addXP(15, "Deposit");
        Wallet.render();
        Dashboard.render();
        showToast("Deposit successful", "success");
      },
      sendMoney(){
        const phone = (document.getElementById("payPhone").value || "").trim();
        const amt = Number(document.getElementById("payAmount").value);
        const v = document.getElementById("payValidation");
        const receiptHint = document.getElementById("receiptHint");

        const showErr = (m)=>{ v.style.display="block"; v.textContent=m; };
        v.style.display="none"; v.textContent="";
        receiptHint.textContent = "Processing...";

        if(!phone || phone.length < 8){ receiptHint.textContent="Ready"; return showErr("Enter a valid phone number."); }
        if(!Number.isFinite(amt) || amt <= 0){ receiptHint.textContent="Ready"; return showErr("Enter a valid amount."); }

        const wallet = Store.wallet();
        const feePct = Wallet.feeFor(Wallet.provider);
        const feeUSD = amt * feePct;
        const totalUSD = amt + feeUSD;

        if(totalUSD > wallet.balanceUSD){ receiptHint.textContent="Ready"; return showErr("Insufficient balance."); }

        // Loading state
        v.style.display="none";
        showToast("Sending paymentâ€¦", "info");

        setTimeout(()=>{
          wallet.balanceUSD -= totalUSD;
          const receiptId = "RCPT-" + String(Math.floor(100000 + Math.random()*899999));
          const note = `Send to ${phone} (fee ${feeUSD.toFixed(2)} USD)`;
          wallet.ledger.unshift({
            id: uuid(),
            type:"debit",
            provider: Wallet.provider,
            amountUSD: amt,
            note,
            ts: Date.now()
          });
          wallet.lastReceipt = {
            receiptId,
            provider: Wallet.provider,
            phone,
            amountUSD: amt,
            feeUSD,
            totalUSD,
            ts: Date.now()
          };

          Store.setWallet(wallet);
          Game.addXP(20, "Send payment");
          Wallet.render();
          Dashboard.render();
          document.getElementById("payAmount").value = "";
          receiptHint.textContent = "Generated";
          showToast("Payment sent", "success");
        }, 650);
      },
      renderReceipt(){
        const wallet = Store.wallet();
        const box = document.getElementById("receiptBox");
        const r = wallet.lastReceipt;
        if(!r){
          box.innerHTML = `<div class="muted">Send a payment to generate a receipt.</div>`;
          return;
        }
        const when = new Intl.DateTimeFormat(locale(), { dateStyle:"medium", timeStyle:"short" }).format(new Date(r.ts));
        box.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div><strong>Receipt</strong> <span class="badge">${r.receiptId}</span></div>
            <div class="muted">${when}</div>
          </div>
          <hr>
          <div>Provider: <strong>${escapeHtml(r.provider)}</strong></div>
          <div>To: <strong>${escapeHtml(r.phone)}</strong></div>
          <div>Amount: <strong>${moneyFromUSD(r.amountUSD)}</strong></div>
          <div>Fee: <strong>${moneyFromUSD(r.feeUSD)}</strong></div>
          <div>Total: <strong>${moneyFromUSD(r.totalUSD)}</strong></div>
          <hr>
          <div class="muted">Status: Completed</div>
        `;
      },
      printReceipt(){
        const wallet = Store.wallet();
        if(!wallet.lastReceipt){ showToast("No receipt to print yet.", "warn"); return; }

        const r = wallet.lastReceipt;
        const when = new Intl.DateTimeFormat(locale(), { dateStyle:"medium", timeStyle:"short" }).format(new Date(r.ts));
        const html = `
          <html><head><title>${r.receiptId}</title></head>
          <body style="font-family:system-ui; padding:18px;">
            <h2 style="margin:0 0 6px 0;">AgriTrade Africa â€” Receipt</h2>
            <div style="opacity:.7; margin-bottom:12px;">${when}</div>
            <div><strong>Receipt ID:</strong> ${r.receiptId}</div>
            <div><strong>Provider:</strong> ${escapeHtml(r.provider)}</div>
            <div><strong>To:</strong> ${escapeHtml(r.phone)}</div>
            <div><strong>Amount:</strong> ${moneyFromUSD(r.amountUSD)}</div>
            <div><strong>Fee:</strong> ${moneyFromUSD(r.feeUSD)}</div>
            <div><strong>Total:</strong> ${moneyFromUSD(r.totalUSD)}</div>
            <hr/>
            <div>Status: Completed</div>
          </body></html>
        `;
        const w = window.open("", "_blank");
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.focus();
        setTimeout(()=> w.print(), 300);
      },
      reset(){
        if(!confirm("Reset wallet + ledger?")) return;
        Store.setWallet(defaultWallet);
        Wallet.render();
        Dashboard.render();
        showToast("Wallet reset", "success");
      },
      render(){
        const wallet = Store.wallet();
        document.getElementById("walletBalance").textContent = moneyFromUSD(wallet.balanceUSD);

        const rows = wallet.ledger.map(x=>{
          const when = new Intl.DateTimeFormat(locale(), { dateStyle:"medium", timeStyle:"short" }).format(new Date(x.ts));
          const sign = x.type==="credit" ? "+" : "âˆ’";
          const color = x.type==="credit" ? "#166534" : "#991b1b";
          return `
            <tr>
              <td>${when}</td>
              <td><strong>${escapeHtml(x.provider)}</strong><div class="muted" style="font-size:.85rem;">${escapeHtml(x.note)}</div></td>
              <td style="color:${color}; font-weight:900;">${sign}${moneyFromUSD(x.amountUSD)}</td>
            </tr>
          `;
        }).join("");

        document.getElementById("ledgerTable").innerHTML = `
          <table>
            <thead><tr><th>Date</th><th>Details</th><th>Amount</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;

        Wallet.renderFee();
        Wallet.renderReceipt();
      }
    };

    // ---------- ORDERS ----------
    const Orders = {
      seedOne(){
        const listings = Store.listings();
        if(!listings.length) return showToast("Create a market listing first.", "error");
        const l = listings[Math.floor(Math.random()*listings.length)];
        const qty = Math.max(50, Math.min(300, l.qtyKg));
        const id = "ORD-" + String(Math.floor(10000 + Math.random()*89999));
        const orders = Store.orders();
        orders.unshift({ id, crop:l.crop, qtyKg:qty, priceUSD:l.pricePerKgUSD, buyer:"Simulated Buyer", status:"Pending", ts: Date.now() });
        Store.setOrders(orders);
        Game.addXP(25, "Simulated order");
        Orders.render();
        Dashboard.render();
        showToast("Order simulated", "success");
      },
      setStatus(id, status){
        const orders = Store.orders();
        const o = orders.find(x=> x.id===id);
        if(!o) return;
        o.status = status;
        Store.setOrders(orders);
        Game.addXP(10, "Order update");
        Orders.render();
        showToast("Order updated", "success");
      },
      reset(){
        if(!confirm("Clear all orders?")) return;
        Store.setOrders([]);
        Orders.render();
        Dashboard.render();
        showToast("Orders cleared", "success");
      },
      render(){
        const wrap = document.getElementById("ordersTable");
        if(!wrap) return;
        const orders = Store.orders();
        if(!orders.length){
          wrap.innerHTML = `<div class="muted">No orders yet. Place an order from Market.</div>`;
          return;
        }
        const rows = orders.map(o=>{
          const when = new Intl.DateTimeFormat(locale(), { dateStyle:"medium", timeStyle:"short" }).format(new Date(o.ts));
          const totalUSD = o.qtyKg * o.priceUSD;
          return `
            <tr>
              <td><strong>${escapeHtml(o.id)}</strong><div class="muted" style="font-size:.85rem;">${when}</div></td>
              <td>${escapeHtml(o.crop)}</td>
              <td>${o.qtyKg.toLocaleString(locale())}</td>
              <td>${moneyFromUSD(o.priceUSD)}</td>
              <td><strong>${moneyFromUSD(totalUSD)}</strong><div class="muted" style="font-size:.85rem;">${escapeHtml(o.buyer)}</div></td>
              <td>
                <select onchange="Orders.setStatus('${escapeHtml(o.id)}', this.value)">
                  <option ${o.status==="Pending"?"selected":""}>Pending</option>
                  <option ${o.status==="In Transit"?"selected":""}>In Transit</option>
                  <option ${o.status==="Delivered"?"selected":""}>Delivered</option>
                  <option ${o.status==="Disputed"?"selected":""}>Disputed</option>
                </select>
              </td>
            </tr>
          `;
        }).join("");

        wrap.innerHTML = `
          <table>
            <thead><tr><th>Order</th><th>Crop</th><th>Qty</th><th>Price/kg</th><th>Total</th><th>Status</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }
    };

    // ---------- AI ----------
    const AI = {
      addHistory(type, payload){
        const h = Store.aiHistory();
        h.unshift({ id: uuid(), type, payload, ts: Date.now() });
        Store.setAiHistory(h.slice(0, 30));
        AI.renderHistory();
      },
      clearHistory(){
        Store.setAiHistory([]);
        AI.renderHistory();
        showToast("AI history cleared", "success");
      },
      renderHistory(){
        const el = document.getElementById("aiHistory");
        if(!el) return;
        const h = Store.aiHistory();
        if(!h.length){ el.innerHTML = `<div class="muted">No history yet.</div>`; return; }
        el.innerHTML = h.map(x=>{
          const when = new Intl.DateTimeFormat(locale(), { dateStyle:"medium", timeStyle:"short" }).format(new Date(x.ts));
          return `<div class="card" style="margin-bottom:10px;">
            <div class="content-pad">
              <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                <strong>${escapeHtml(x.type)}</strong><span class="badge">${when}</span>
              </div>
              <div class="muted" style="margin-top:6px;line-height:1.6;">${escapeHtml(JSON.stringify(x.payload))}</div>
            </div>
          </div>`;
        }).join("");
      },
      setLoading(targetId, text){
        const el = document.getElementById(targetId);
        el.innerHTML = `<span class="loading"><span class="spinner"></span> ${escapeHtml(text)}</span>`;
      },
      ask(){
        const input = document.getElementById("aiPrompt");
        const out = document.getElementById("aiAnswerText");
        const q = (input.value || "").trim();
        if(!q) return showToast("Enter a question.", "error");

        AI.setLoading("aiAnswerText", "Thinkingâ€¦");

        setTimeout(()=>{
          const qq = q.toLowerCase();
          let answer = "";
          if(qq.includes("wallet") || qq.includes("balance")){
            const w = Store.wallet();
            answer = `Your available balance is ${moneyFromUSD(w.balanceUSD)}.`;
          } else if(qq.includes("maize") || qq.includes("corn")){
            answer = "For maize deals, target buyers near Nairobi and offer 2â€“4% discount for 1000kg+. Use escrow for first-time buyers.";
          } else if(qq.includes("logistics") || qq.includes("delivery")){
            answer = "Recommend split routing: farm â†’ warehouse â†’ hub. Add insurance on long-haul segments and confirm GPS check-ins every 2 hours.";
          } else if(qq.includes("order")){
            answer = "To create an order: Market â†’ click Order on a listing â†’ choose quantity and buyer â†’ submit.";
          } else {
            answer = "I can help with pricing, buyer targeting, contracts, and logistics. Try: â€œEstimate maize Grade A price for 800kgâ€.";
          }
          out.textContent = answer;
          AI.addHistory("AI Ask", { question:q, answer });
          input.value = "";
          Game.addXP(10, "Used AI");
        }, 520);
      },
      calcPrice(){
        const crop = document.getElementById("priceCrop").value;
        const grade = document.getElementById("priceGrade").value;
        const qty = Number(document.getElementById("priceQty").value);
        if(!Number.isFinite(qty) || qty<=0) return showToast("Enter qty (kg).", "error");

        AI.setLoading("priceOut", "Calculatingâ€¦");
        document.getElementById("priceNote").textContent = "â€”";

        setTimeout(()=>{
          const base = { maize:0.45, beans:0.95, coffee:3.20, cassava:0.25 }[crop] || 0.5;
          const gradeMul = { A:1.12, B:1.00, C:0.90 }[grade] || 1.0;
          const discount = qty >= 1000 ? 0.04 : qty >= 500 ? 0.02 : 0.0;

          const priceUSD = base * gradeMul * (1 - discount);
          const totalUSD = priceUSD * qty;

          document.getElementById("priceOut").textContent = moneyFromUSD(totalUSD);
          document.getElementById("priceNote").textContent =
            `Per-kg: ${moneyFromUSD(priceUSD)} â€¢ Bulk discount: ${(discount*100).toFixed(0)}% â€¢ Grade: ${grade.toUpperCase()}`;

          AI.addHistory("Price Estimate", { crop, grade, qtyKg: qty, perKgUSD: +priceUSD.toFixed(3), totalUSD: +totalUSD.toFixed(2) });
          Game.addXP(12, "Price estimate");
        }, 520);
      },
      soilAnalyze(){
        const f = document.getElementById("soilFile").files[0];
        if(!f) return showToast("Upload a report (image/PDF).", "error");

        document.getElementById("soilResult").innerHTML = `<span class="loading"><span class="spinner"></span> Analyzing soil reportâ€¦</span>`;

        setTimeout(()=>{
          const n = f.size % 1000;
          const ph = (6.0 + (n/1000)*1.2).toFixed(1);
          const nppm = 45 + (n % 40);
          const pppm = 12 + (n % 18);
          const kppm = 80 + (n % 60);

          const result = { file: f.name, ph:+ph, N:nppm, P:pppm, K:kppm };

          document.getElementById("soilResult").innerHTML = `
            <div><strong>Soil Summary</strong></div>
            <div class="muted">File: ${escapeHtml(f.name)}</div>
            <hr>
            <div>pH: <strong>${ph}</strong></div>
            <div>N (ppm): <strong>${nppm}</strong></div>
            <div>P (ppm): <strong>${pppm}</strong></div>
            <div>K (ppm): <strong>${kppm}</strong></div>
            <hr>
            <div><strong>Recommendation</strong></div>
            <div class="muted" style="line-height:1.7;">
              Apply balanced fertilizer, add compost for organic matter, and irrigate lightly after application.
            </div>
          `;
          AI.addHistory("Soil Analysis", result);
          Game.addXP(18, "Soil analysis");
        }, 650);
      },
      diseaseScan(){
        const f = document.getElementById("diseaseFile").files[0];
        if(!f) return showToast("Upload a crop photo.", "error");

        document.getElementById("diseaseResult").innerHTML = `<span class="loading"><span class="spinner"></span> Scanning crop imageâ€¦</span>`;

        setTimeout(()=>{
          const c = 86 + (f.size % 12);
          const healthy = (f.size % 3) !== 0;

          const result = { file: f.name, confidence: c, healthy };

          document.getElementById("diseaseResult").innerHTML = healthy
            ? `<div><strong>Healthy Crop Detected</strong></div>
               <div class="muted">Confidence: <strong>${c}%</strong></div>
               <hr>
               <div class="muted" style="line-height:1.7;">No disease patterns detected. Continue current care schedule and monitor weekly.</div>`
            : `<div><strong>Potential Risk Detected</strong></div>
               <div class="muted">Confidence: <strong>${c}%</strong></div>
               <hr>
               <div class="muted" style="line-height:1.7;">Consider isolating affected plants and applying recommended treatment. Retest with a clearer photo under daylight.</div>`;

          AI.addHistory("Disease Scan", result);
          Game.addXP(20, "Disease scan");
        }, 650);
      }
    };

    // ---------- CHAT ----------
    const Chat = {
      tab: "buyers",
      switch(tab){
        const c = Store.chat();
        c.tab = tab;
        Store.setChat(c);
        document.querySelectorAll(".tab").forEach(x=> x.classList.remove("active"));
        document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add("active");
        Chat.render();
      },
      send(){
        const input = document.getElementById("chatInput");
        const text = (input.value || "").trim();
        if(!text) return;
        const c = Store.chat();
        c.messages.push({ role:"me", tab: c.tab, text, ts: Date.now() });

        const lower = text.toLowerCase();
        let reply = "";
        if(c.tab === "ai"){
          if(lower.includes("wallet") || lower.includes("balance")){
            reply = `Balance: ${moneyFromUSD(Store.wallet().balanceUSD)}.`;
          } else if(lower.includes("order")){
            reply = "Open Market â†’ click Order on a listing â†’ set buyer and quantity â†’ submit.";
          } else if(lower.includes("disease")){
            reply = "Open AI Tools â†’ Disease Scanner â†’ upload a crop photo â†’ Scan Crop.";
          } else if(lower.includes("price")){
            reply = "Open AI Tools â†’ Price AI â†’ choose crop/grade and quantity â†’ Estimate.";
          } else {
            reply = "Try: â€œEstimate maize Grade A price for 800kgâ€ or â€œFind buyers near Nairobiâ€.";
          }
        } else if(c.tab === "buyers"){
          reply = "Buyer lead: Nairobi Foods Ltd â€” prefers weekly supply, Grade A, 500â€“1500kg. Ask for delivery timeline and payment terms (escrow recommended).";
        } else {
          reply = "Seller lead: Co-op in Nakuru â€” consistent maize supply. Ask for moisture %, grade certificate, and pickup window.";
        }

        c.messages.push({ role:"ai", tab: c.tab, text: reply, ts: Date.now() });
        Store.setChat(c);

        input.value = "";
        Chat.render();
        Game.addXP(8, "Chat message");
      },
      render(){
        const c = Store.chat();
        Chat.tab = c.tab || "buyers";
        const box = document.getElementById("chatMessages");
        const msgs = c.messages.filter(m => m.tab === c.tab);

        const html = msgs.map(m=>{
          const own = m.role === "me";
          return `
            <div class="message ${own ? "own" : ""}">
              ${own ? "" : `<div class="avatar">AI</div>`}
              <div class="bubble ${own ? "own" : ""}">
                ${escapeHtml(m.text)}
              </div>
              ${own ? `<div class="avatar">ME</div>` : ""}
            </div>
          `;
        }).join("");

        box.innerHTML = html || `<div class="muted">No messages yet.</div>`;
        box.scrollTop = box.scrollHeight;
      }
    };

    // ---------- GAME ----------
    const Game = {
      thresholds: [0, 200, 450, 800, 1200, 1700, 2300],
      badges: [
        { key:"trader", name:"Trader", need: 100, benefit:"Higher trust + better buyer matching" },
        { key:"quality", name:"Quality", need: 250, benefit:"Priority listings placement" },
        { key:"pioneer", name:"Pioneer", need: 450, benefit:"Lower escrow friction" },
        { key:"export", name:"Export", need: 800, benefit:"Export-ready compliance checklist" },
        { key:"green", name:"Green", need: 1200, benefit:"Sustainability badge on profile" },
        { key:"mentor", name:"Mentor", need: 1700, benefit:"Mentor matchmaking access" }
      ],
      checklistItems(){
        const listings = (Store.listings()||[]).length;
        const orders = (Store.orders()||[]).length;
        const ledger = (Store.wallet()?.ledger||[]).length;
        const history = (Store.aiHistory()||[]).length;

        return [
          { label:"Create a listing (+25 XP)", done: listings >= 4 },
          { label:"Place an order (+35 XP)", done: orders >= 3 },
          { label:"Send a payment (+20 XP)", done: ledger >= 3 },
          { label:"Run a disease scan (+20 XP)", done: history.some(h=>h.type==="Disease Scan") },
          { label:"Run a soil analysis (+18 XP)", done: history.some(h=>h.type==="Soil Analysis") },
          { label:"Get 2 AI results (+10 XP each)", done: history.length >= 2 }
        ];
      },
      addXP(amount, reason){
        const g = Store.game();
        g.xp += amount;
        Game.recalc(g);
        Store.setGame(g);
        Game.render();
      },
      recalc(g){
        let lvl = 1;
        for(let i=1;i<Game.thresholds.length;i++){
          if(g.xp >= Game.thresholds[i]) lvl = i+1;
        }
        g.level = lvl;
        for(const b of Game.badges){
          if(g.xp >= b.need) g.unlocked[b.key] = true;
        }
      },
      unlockProgress(){
        const listings = (Store.listings()||[]).length;
        const orders = (Store.orders()||[]).length;
        const ledger = (Store.wallet()?.ledger||[]).length;
        const history = (Store.aiHistory()||[]).length;

        let gain = 0;
        gain += Math.min(60, listings * 10);
        gain += Math.min(90, orders * 18);
        gain += Math.min(45, ledger * 6);
        gain += Math.min(45, history * 6);
        gain += 25;

        const g = Store.game();
        g.xp += gain;
        Game.recalc(g);
        Store.setGame(g);
        Game.render();
        showToast(`Progress unlocked: +${gain} XP`, "success");
      },
      claimReward(){
        const g = Store.game();
        const now = Date.now();
        if(now - g.lastClaimAt < 60_000){
          showToast("Reward is on cooldown (60 seconds).", "warn");
          return;
        }
        // Claim gives wallet bonus
        const bonus = 50 + (g.level * 10);
        const w = Store.wallet();
        w.balanceUSD += bonus;
        w.ledger.unshift({ id: uuid(), type:"credit", provider:"Reward", amountUSD: bonus, note:`Level ${g.level} reward`, ts: Date.now() });
        Store.setWallet(w);

        g.lastClaimAt = now;
        Store.setGame(g);

        Wallet.render();
        Dashboard.render();
        showToast(`Reward claimed: +${moneyFromUSD(bonus)} added to wallet`, "success");
      },
      reset(){
        if(!confirm("Reset XP + badges?")) return;
        Store.setGame(defaultGame);
        Game.render();
        showToast("Progress reset", "success");
      },
      render(){
        const g = Store.game();
        Game.recalc(g);

        document.getElementById("xp").textContent = String(g.xp);
        document.getElementById("lvl").textContent = String(g.level);
        document.getElementById("navXP").textContent = String(g.xp);
        document.getElementById("navLevel").textContent = String(g.level);

        const next = Game.thresholds.find(x => x > g.xp) || (g.xp + 200);
        document.getElementById("nextReward").textContent = String(next) + " XP";

        const prev = Game.thresholds[g.level-1] || 0;
        const span = Math.max(1, next - prev);
        const pct = Math.max(0, Math.min(100, ((g.xp - prev) / span) * 100));
        document.getElementById("xpBar").style.width = pct.toFixed(0) + "%";

        const badgesWrap = document.getElementById("badges");
        badgesWrap.innerHTML = Game.badges.map(b=>{
          const on = !!g.unlocked[b.key];
          return `
            <div class="card" style="border-color:${on ? "rgba(22,163,74,.28)" : "rgba(11,18,32,.12)"};">
              <div class="content-pad">
                <div class="row" style="justify-content:space-between;">
                  <strong>${escapeHtml(b.name)}</strong>
                  <span class="badge">${on ? "Unlocked" : `${b.need} XP`}</span>
                </div>
                <div class="muted" style="margin-top:6px; line-height:1.6;">
                  ${on ? `Benefit: ${escapeHtml(b.benefit)}` : "Complete actions in Market/Wallet/AI to unlock."}
                </div>
              </div>
            </div>
          `;
        }).join("");

        const checklist = document.getElementById("checklist");
        const items = Game.checklistItems();
        checklist.innerHTML = items.map(i=>`
          <div class="card" style="margin-bottom:10px;">
            <div class="content-pad" style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
              <div>${escapeHtml(i.label)}</div>
              <span class="badge">${i.done ? "Done" : "Pending"}</span>
            </div>
          </div>
        `).join("");
      }
    };

    // ---------- MAPS ----------
    const Maps = {
      map:null,
      mirror:null,
      markersMain: [],
      markersMirror: [],
      initMain(){
        const el = document.getElementById("map");
        if(!el) return;
        if(typeof window.L === "undefined"){
          document.getElementById("mapFallback").style.display = "block";
          return;
        }
        try{
          if(Maps.map){
            Maps.map.invalidateSize();
            return;
          }
          Maps.map = L.map("map").setView([-1.2921, 36.8219], 6);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(Maps.map);
          const markers = [
            { pos: [-1.2921, 36.8219], title: "Nairobi - Warehouse" },
            { pos: [-0.0236, 37.9062], title: "Mt. Kenya - Farm" },
            { pos: [-1.2864, 36.8172], title: "In Transit" }
          ];
          Maps.markersMain = markers.map(m => L.marker(m.pos).addTo(Maps.map).bindPopup(m.title));
          setTimeout(()=> Maps.map.invalidateSize(), 350);
          setTimeout(()=> Maps.map.invalidateSize(), 900);
        }catch{
          document.getElementById("mapFallback").style.display = "block";
        }
      },
      initMirror(){
        const el = document.getElementById("mapMirror");
        const fb = document.getElementById("mapMirrorFallback");
        if(!el) return;
        if(typeof window.L === "undefined"){
          fb.style.display = "block";
          return;
        }
        try{
          if(Maps.mirror){
            Maps.mirror.invalidateSize();
            return;
          }
          Maps.mirror = L.map("mapMirror").setView([-1.2921, 36.8219], 6);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(Maps.mirror);
          const markers = [
            { pos: [-1.2921, 36.8219], title: "Nairobi - Hub" },
            { pos: [-0.0236, 37.9062], title: "Farm Pickup" },
            { pos: [-1.2864, 36.8172], title: "Truck Checkpoint" }
          ];
          Maps.markersMirror = markers.map(m => L.marker(m.pos).addTo(Maps.mirror).bindPopup(m.title));
          setTimeout(()=> Maps.mirror.invalidateSize(), 350);
          setTimeout(()=> Maps.mirror.invalidateSize(), 900);
        }catch{
          fb.style.display = "block";
        }
      },
      fitAll(){
        try{
          const m = Maps.mirror || Maps.map;
          if(!m) return;
          const markers = (Maps.mirror ? Maps.markersMirror : Maps.markersMain);
          if(!markers?.length) return;
          const group = new L.featureGroup(markers);
          m.fitBounds(group.getBounds().pad(0.2));
        }catch{}
      }
    };

    // ---------- LOGISTICS TIMELINE ----------
    const Logistics = {
      addCheckpoint(){
        UI.openModal({
          title: "Add Logistics Checkpoint",
          icon: "fa-route",
          bodyHTML: `
            <div class="hint">Add a real checkpoint event (saved locally).</div>
            <div style="margin-top:10px;">
              <div class="hint">Checkpoint label</div>
              <input id="cpLabel" placeholder="e.g., Arrived at warehouse for grading"/>
            </div>
            <div class="error" id="cpErr" style="display:none; margin-top:10px;"></div>
          `,
          footHTML: `
            <button class="btn" onclick="UI.closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button class="btn primary" onclick="Logistics.saveCheckpoint()"><i class="fa-solid fa-check"></i> Save</button>
          `
        });
      },
      saveCheckpoint(){
        const label = (document.getElementById("cpLabel").value||"").trim();
        const err = document.getElementById("cpErr");
        if(!label){
          err.style.display="block";
          err.textContent="Checkpoint label is required.";
          return;
        }
        const timeline = Store.logisticsTimeline() || [];
        timeline.unshift({ id: uuid(), label, ts: Date.now() });
        Store.setLogisticsTimeline(timeline.slice(0, 20));
        UI.closeModal();
        Logistics.render();
        Game.addXP(8, "Logistics checkpoint");
        showToast("Checkpoint added", "success");
      },
      render(){
        const el = document.getElementById("logTimeline");
        if(!el) return;
        const timeline = Store.logisticsTimeline() || [];
        if(!timeline.length){ el.innerHTML = `<div class="muted">No checkpoints yet.</div>`; return; }
        el.innerHTML = timeline.map(x=>{
          const when = new Intl.DateTimeFormat(locale(), { dateStyle:"medium", timeStyle:"short" }).format(new Date(x.ts));
          return `<div class="card" style="margin-bottom:10px;">
            <div class="content-pad" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
              <div><strong>${escapeHtml(x.label)}</strong></div>
              <span class="badge">${when}</span>
            </div>
          </div>`;
        }).join("");
      }
    };

    // ---------- EXPORTS ----------
    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 500);
    }
    function toCSV(rows){
      const esc = (v)=> `"${String(v ?? "").replaceAll('"','""')}"`;
      return rows.map(r=> r.map(esc).join(",")).join("\n");
    }

    const Exports = {
      exportListings(){
        const listings = Store.listings() || [];
        const rows = [
          ["id","crop","grade","qtyKg","pricePerKgUSD","location","seller","updatedAt"],
          ...listings.map(x=>[x.id,x.crop,x.grade,x.qtyKg,x.pricePerKgUSD,x.location,x.seller,new Date(x.updatedAt).toISOString()])
        ];
        downloadText("agritrade_listings.csv", toCSV(rows));
        showToast("Listings CSV exported", "success");
      },
      exportOrders(){
        const orders = Store.orders() || [];
        const rows = [
          ["id","crop","qtyKg","priceUSD","buyer","status","terms","delivery","ts"],
          ...orders.map(o=>[o.id,o.crop,o.qtyKg,o.priceUSD,o.buyer,o.status,o.terms||"",o.delivery||"",new Date(o.ts).toISOString()])
        ];
        downloadText("agritrade_orders.csv", toCSV(rows));
        showToast("Orders CSV exported", "success");
      },
      exportLedger(){
        const w = Store.wallet();
        const rows = [
          ["id","type","provider","amountUSD","note","ts"],
          ...(w.ledger||[]).map(x=>[x.id,x.type,x.provider,x.amountUSD,x.note,new Date(x.ts).toISOString()])
        ];
        downloadText("agritrade_wallet_ledger.csv", toCSV(rows));
        showToast("Ledger CSV exported", "success");
      },
      exportAll(){
        Exports.exportListings();
        setTimeout(()=> Exports.exportOrders(), 250);
        setTimeout(()=> Exports.exportLedger(), 500);
      }
    };

    // ---------- GLOBALS FOR ONCLICK ----------
    window.Market = Market;
    window.Wallet = Wallet;
    window.Orders = Orders;
    window.Chat = Chat;
    window.AI = AI;
    window.Game = Game;
    window.Maps = Maps;
    window.Logistics = Logistics;
    window.Exports = Exports;

    // ---------- INIT ----------
    document.addEventListener("DOMContentLoaded", ()=>{
      ensureSeed();
      setDir();

      // wire dropdowns
      const langSel = document.getElementById("langSelect");
      const curSel = document.getElementById("currency");

      langSel.value = state.lang;
      curSel.value = state.currency;

      langSel.addEventListener("change", ()=>{
        state.lang = langSel.value;
        localStorage.setItem(LS.lang, state.lang);
        setDir();
        applyTranslations();
        Market.render(); Orders.render(); Wallet.render(); Dashboard.render(); Chat.render(); Game.render(); AI.renderHistory(); Logistics.render();
        showToast("Language updated", "success");
      });

      curSel.addEventListener("change", ()=>{
        state.currency = curSel.value;
        localStorage.setItem(LS.currency, state.currency);
        Market.render(); Orders.render(); Wallet.render(); Dashboard.render(); Game.render();
        showToast("Currency updated", "success");
      });

      document.getElementById("marketSearch").addEventListener("input", ()=> Market.render());

      applyTranslations();
      Wallet.selectProvider("M-Pesa");
      Wallet.render();
      Market.render();
      Orders.render();
      Dashboard.render();
      Chat.render();
      Game.render();
      AI.renderHistory();
      Logistics.render();

      __agri_nav(state.section);

      setTimeout(()=> Maps.initMain(), 420);
    });
  })();
  </script>
</body>
</html>
